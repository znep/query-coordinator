<% content_for :head do %>
  <%= rendered_stylesheet_tag 'administration-screen' %>
  <%= rendered_stylesheet_tag 'administration-users' %>
  <title>Manage Users | <%= CurrentDomain.strings.site_title %></title>
<% end %>

<% content_for :skip_links do %>
  <a href="?no_js=true">Disable Javascript on this page</a>
<% end %>

<%= render :partial => 'left_nav' %>
<%- no_js = params[:no_js].present? -%>

<div class="contentBox withLeftNavigation usersScreen">
   <div class="adminHeader floating users">
    <%- unless no_js -%>
      <div class="bulkCreateButtonArea">
        <a href="#BulkCreate" class="button showBulkCreateForm">Bulk Create</a>
      </div>
    <%- end -%>
    <span class="icon"></span>
    <h1>Manage Users</h1>
  </div>

  <div class="bulkUserCreateSection clearfix<%= ' hide' unless no_js %>">
    <%= form_tag({:action => 'bulk_create_users'}, {:method => 'post', :class => 'commonForm'}) %>
      <div class="line">
        <label for="users">Emails</label>
        <%= text_area_tag('users', nil,
          :class => 'textPrompt', :title => 'Enter email addresses for the accounts you wish to create') %>
      </div>
      <div class="line">
        <label for="role">Role</label>
        <%= raw(select_for_role('role', 'role', nil, 'roleSelect', false)) %>
      </div>
      <div class="line">
        <label>&nbsp;</label>
        <input type="submit" class="bulkCreateButton button default" value="Create Accounts" />
        <%- unless no_js -%>
          <a href="#Cancel" class="cancelBulkCreate button">Cancel</a>
        <%- end -%>
      </div>
    </form>
  </div>
</div>

<div class="contentBox withLeftNavigation usersScreen" id="adminContent">
  <%- unless @users_list.blank? %>
    <div class="userRoleSelectFilter">
      <label for="userRoleFilterDropdown">Filter by</label>
      <select id="userRoleFilterDropdown">
        <option value="all">All</option>
        <%- User.roles_list.each do |role| -%>
          <option value="<%= role =%>"><%= role.titleize %></option>
        <%- end -%>
      </select>
    </div>
  <%- end -%>

  <%= display_standard_flashes %>

  <%- unless @user_search_results.nil? -%>
    <p class="information">
      <%= link_to 'Return to users overview', :action => 'users' %>
    </p>
  <%- end -%>

  <form class="search usersFind" action="<%= url_for :action => 'users' %>" method="get">
    <label for="username">Search for Users to Add</label>
    <input type="text" class="textPrompt searchField<%= ' prompt' if @search.nil? %>" name="username" id="username"
     title="Search for users to add"<%= raw(" value=\"#{h @search}\"") unless @search.nil? %> />
    <input type="submit" class="submit" alt="search" value="Search" />
  </form>

  <div class="adminUsersTableContainer tableContainer">
  <h2><%= @table_title %></h2>
  <%- unless @users_list.nil? -%>
    <div class="flash notice userNotice"></div>
    <div class="gridListWrapper">
      <table class="gridList adminUsersTable" cellspacing="0">
        <colgroup>
          <%# Enable once we have bulk ops %>
          <%- if @existing_user_actions && false-%>
            <col class="select" />
          <%- end -%>
          <col class="user" />
          <col class="email" />
          <col class="role" />
          <%- if @existing_user_actions -%>
            <col class="actions" />
          <%- end -%>
        </colgroup>
        <thead>
          <tr>
            <%#Enable once we have bulk ops %>
            <%- if @existing_user_actions && false -%>
              <th class="select"></th>
            <%- end -%>
            <th class="user"><div>Name</div><span class="icon"></span></th>
            <th class="email"><div>Email</div><span class="icon"></span></th>
            <th class="role"><div>Role</div><span class="icon"></span></th>
            <%- if @existing_user_actions -%>
              <th class="actions">Actions</th>
            <%- end -%>
          </tr>
        </thead>
        <tbody>
          <%- @users_list.each do |user| -%>
            <tr class="item" data-userrole="<%= user.roleName %>">
              <%# Enable once we have bulk ops %>
              <%- if @existing_user_actions && false -%>
                <td class="select">
                  <%- unless user.id == current_user.id %>
                    <%= check_box_tag "user_select[#{user.id}]" %>
                  <%- end -%>
                </td>
              <%- end -%>
              <td class="user">
                <a href="<%= user.href %>">
                  <img class="userIcon" src="<%= user.profile_image_path('small')%>"
                    alt="<%= user.displayName %>" />
                  <span class="cellInner">
                    <%= user.displayName %>
                  </span>
                </a>
              </td>
              <td class="email">
                <span class="cellInner">
                  <%= user.email %>
                </span>
              </td>
              <td class="role">
                <%- if user.id == current_user.id -%>
                  <span class="cellInner"><%= (current_user.roleName || '').titleize %></span>
                <%- else -%>
                  <span class="cellInner hide"><%= (user.roleName || '').titleize %></span>
                  <%= form_tag({:action => 'set_user_role'}, {:method => 'put'}) %>
                    <input type="hidden" name="user_id" class="hiddenID" value="<%= user.id %>" />
                    <%= raw(select_for_role("userSelect-#{user.id}", 'role', user.roleName, 'roleSelect')) %>
                    <%- if no_js -%>
                      <input type="submit" class="userSaveButton" value="Save" />
                    <%- end -%>
                  </form>
                <%- end -%>
              </td>
              <%- if @existing_user_actions -%>
                <td class="actions">
                  <%- unless user.id == current_user.id -%>
                    <span class="loading"></span>
                    <%= form_button({ :action => 'set_user_role', :user_id => user.id, :role => 0 },
                                    'Remove', {:method => :put}, {:class => 'button removeButton'}) %>
                    <%= form_button({ :action => 'reset_user_password', :user_id => user.id },
                                    'Reset Password', {}, {:class => 'button resetPasswordButton'}) %>
                  <%- end -%>
                </td>
              <%- end -%>
            </tr>
          <%- end -%>
        </tbody>
      </table>
    </div>
    <p class="noResultsMessage<%= ' noHide' if @users_list && @users_list.length == 0 %>">No users match your current filter.</p>
  </div>
  <%- end -%>

  <%- unless @futures.blank? -%>
    <div class="futureUsersContainer tableContainer">
      <p class="unregisteredExplanation">
        The following users have accounts pending, but have not activated them yet
      </p>
      <div class="gridListWrapper">
        <table class="gridList futureUsersTable" cellspacing="0">
          <colgroup>
            <col class="email" />
            <col class="role" />
            <col class="createdAt" />
            <col class="actions" />
          </colgroup>
          <thead>
            <tr>
              <th class="email"><div>Email</div><span class="icon"></span></th>
              <th class="role"><div>Role</div><span class="icon"></span></th>
              <th class="createdAt"><div>Invited</div><span class="icon"></span></th>
              <th class="actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            <%- @futures.each do |user| -%>
              <tr class="item" data-userrole="<%= user.role %>">
                <td class="email">
                  <span class="cellInner">
                    <%= user.email %>
                  </span>
                </td>
                <td class="role">
                  <span class="cellInner">
                    <%= user.role.titleize %>
                  </span>
                </td>
                <td class="createdAt">
                  <span class="cellInner">
                    <%= blist_long_date(user.createdAt) %>
                  </span>
                </td>
                <td class="actions">
                  <span class="loading"></span>
                  <%= form_button({ :action => 'delete_future_user', :id => user.id }, 'Remove',
                       {:method => :delete}, {:class => 'button removeButton'}) %>
                </td>
              </tr>
            <%- end -%>
          </tbody>
        </table>
      </div>
      <p class="noResultsMessage">No pending users match your current filter</p>
    </div>
  <%- end -%>

  </div>
</div>

<% content_for :js_footer do %>
  <%- unless no_js -%>
    <%= include_javascripts 'admin-users' %>
  <%- end -%>
<% end %>

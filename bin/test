#!/usr/bin/env bash
set -ex

# Called by Jenkins to ensure tests pass and code is free of lint.

# Log the author name and email of the last commit
echo "Change committed by: $(git log HEAD -1 --pretty=format:"%an (%ae)")"

# Dependencies
export RUBYOPT="-E utf-8"
bundle config socrata.artifactoryonline.com $ARTIFACTORYONLINE_USER:$ARTIFACTORYONLINE_PASSWORD
bundle install
npm install --depth 0

# Lint
MERGE_BASE=$(git merge-base HEAD master)
NEW_PROBLEMS=$(git diff --name-status ${MERGE_BASE} | grep '^\(A\|M\).*\.jsx\?$' | cut -c3- | xargs node_modules/.bin/eslint --ignore-path .eslintignore -f compact || true)
DELTA=$(echo "${NEW_PROBLEMS}" | sed -e :a -e '$d;N;2,2ba' -e 'P;D')
DELTA_COUNT=$(echo "${NEW_PROBLEMS}" | tail -n1 | cut -d ' ' -f 1)

if [[ "$DELTA_COUNT" -gt 0 ]]; then
  echo
  echo "Lint errors [${DELTA_COUNT}]:"
  echo
  echo "${DELTA}"
  echo
  echo "Found lint errors, exiting"
  exit 1
else
  echo "No lint errors"
fi

# Tests
bundle exec rake test

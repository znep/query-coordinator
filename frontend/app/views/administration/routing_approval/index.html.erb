<% content_for :head do %>
  <%= rendered_stylesheet_tag 'administration-screen' %>
  <%= rendered_stylesheet_tag 'administration-routing-approval' %>
  <title><%= t('screens.admin.routing_approval.title') %> | <%= get_site_title %></title>
<% end %>

<% content_for :skip_links do %>
  <%= link_to t('core.no_js'), '?no_js=true' %>
<% end %>

<% content_for :breadcrumb do %>
  <%= t('screens.admin.routing_approval.title')  %>
<% end %>

<%= render '/administration/left_nav' %>

<div id="routingApprovalContent" class="contentBox <%= admin_page_with_left_nav_class %>">
  <%= render :partial => 'header',
        :locals => {:active => 'dashboard'} %>

  <%= display_standard_flashes %>

  <div id="routingApprovalDashboard">
    <%- if !@approval_template.nil? -%>
    <%- if @appr_count > 0 -%>
    <div class="banner clearfix">
      <a href="<%= queue_path %>" class="button"><%= t('screens.admin.routing_approval.take_action') %></a>
      <p>
        <%= raw @appr_count > 1 ?
                t('screens.admin.routing_approval.require_action.other', count: @appr_count) :
                t('screens.admin.routing_approval.require_action.one') %>
      </p>
    </div>
    <%- end -%>

    <div class="pipeline report loading hide">
      <h3><%= t('screens.admin.routing_approval.pipeline_report') %></h3>
      <ul class="content">
      </ul>
      <span class="spinner"></span>
    </div>

    <div class="ageReport report loading hide">
      <h3><%= t('screens.admin.routing_approval.age_by_stage_report') %></h3>
      <table class="gridList content">
        <colgroup>
          <col class="stage" />
          <col class="count" />
          <col class="average" />
        </colgroup>
        <thead>
          <tr>
            <th class="stage" scope="col"><%= t('screens.admin.routing_approval.stage') %></th>
            <th class="count" scope="col"><%= t('screens.admin.routing_approval.count') %></th>
            <th class="average" scope="col"><%= t('screens.admin.routing_approval.average_age') %></th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <span class="spinner"></span>
    </div>

    <div class="agingReport report loading hide">
      <h3><%= t('screens.admin.routing_approval.stage_breakdown_report') %></h3>
      <table class="gridList content">
        <colgroup>
          <col class="stage" />
        </colgroup>
        <thead>
          <tr>
            <th class="stage"><%= t('screens.admin.routing_approval.stage') %></th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <span class="spinner"></span>
    </div>

    <div class="stuckReport report">
      <h3><%= t('screens.admin.routing_approval.stuck_datasets') %></h3>
      <table class="gridList">
        <colgroup>
          <col class="name" />
          <col class="stage" />
          <col class="inactive" />
        </colgroup>
        <thead>
          <tr>
            <th class="name"><%= t('screens.admin.routing_approval.dataset') %></th>
            <th class="stage"><%= t('screens.admin.routing_approval.stage') %></th>
            <th class="inactive"><%= t('screens.admin.routing_approval.inactive') %></th>
          </tr>
        </thead>
        <tbody>
          <%- @stuck_results.each do |v| -%>
          <tr>
            <td class="name">
              <span class="icon"></span><a href="<%= view_path(v) %>"><%= v.name %></a>
            </td>
            <td class="stage">
              <%= render :partial => 'datasets/stage_icon',
                :locals => {:view => v, :approval => @approval_template} %>
            </td>
            <td class="inactive">
              <%= t('screens.admin.routing_approval.day', :count => ((Time.now - Time.at(v.last_approval_date)) / 1.day).to_i) %>
            </td>
          </tr>
          <%- end -%>
        </tbody>
      </table>
      <%- if @stuck_count > 5 -%>
        <a href="<%= queue_path(show_stuck: true) %>" class="moreStuck"><%= t('screens.admin.routing_approval.show_more') %></a>
      <%- end -%>
    </div>

    <%- else -%>
    <h3 class="unconfiguredMessage"><%= t('screens.admin.routing_approval.unconfigured_message') %></h3>
    <%- end -%>

  </div>
</div>

<%= render_admin_qualtrics %>

<% content_for :templates do %>
<ul class="pipelineItem">
  <li class="clearfix">
  <div class="label"><span></span></div>
  <div class="barContainer">
    <span class="bar"></span>
    <span class="count"></span>
  </div>
  </li>
</ul>

<table class="ageItem">
  <tr>
    <td class="stage" scope="row">
      <div class="icon"></div>
      <span class="name"></span>
    </td>
    <td class="count"></td>
    <td class="average"></td>
  </tr>
</table>

<table class="agingItem">
  <tr>
    <td class="stage" scope="row">
      <div class="icon"></div>
      <span class="name"></span>
    </td>
  </tr>
</table>
<% end %>

<%- content_for :js_footer do -%>
  <%- unless params[:no_js] == 'true' -%>
    <script type="text/javascript">
      $(function()
      {
         var raNS = blist.namespace.fetch('blist.routingApproval');
         raNS.approvalTemplate = new Approval(<%= safe_json(@approval_template) %>);
      });
    </script>
    <%= include_webpack_bundle 'open-data/admin-routing-approval.js' %>
  <%- end -%>
<%- end -%>

<% content_for :translations do %>
  <%= render_translations LocalePart.screens.ds %>
  <%= render_translations LocalePart.screens.admin.routing_approval %>
<% end %>

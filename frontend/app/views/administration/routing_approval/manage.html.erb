<%- prefix = 'screens.admin.routing_approval' %>
<% content_for :head do %>
  <%= rendered_stylesheet_tag 'administration-screen' %>
  <%= rendered_stylesheet_tag 'administration-routing-approval' %>
  <title><%= t('screens.admin.routing_approval.title') %> | <%= get_site_title %></title>
<% end %>

<% content_for :skip_links do %>
  <%= link_to t('core.no_js'), '?no_js=true' %>
<% end %>

<% content_for :breadcrumb do %>
  <%= t('screens.admin.routing_approval.title')  %>
<% end %>

<%= render '/administration/left_nav' %>

<div id="routingApprovalContent" class="contentBox withLeftNavigation">
  <%= render :partial => 'header',
        :locals => {:active => 'manage'} %>

  <%= display_standard_flashes %>

  <div id="routingApprovalManagement">
    <h2><%= t('screens.admin.routing_approval.manage_approval_process') %></h2>
    <%= form_tag({:action => 'manage_save'},
      {:class => 'commonForm'}) do %>
      <div class="line">
        <label for="template_name" class="required"><%= t('screens.admin.routing_approval.name') %></label>
        <input type="text" id="template_name" name="template[name]" class="required"
          value="<%= @approval_template.nil? ? '' : @approval_template.name %>" />
      </div>
      <div class="line">
        <label for="template_maxInactivityInterval"><%= t('screens.admin.routing_approval.mark_stuck') %></label>
        <input type="text" id="template_maxInactivityInterval"
          name="template[maxInactivityInterval]" class="number"
          value="<%= @approval_template.nil? ? 5 : @approval_template.maxInactivityInterval %>" />
        <label for="template_maxInactivityInterval"><%= t('screens.admin.routing_approval.days') %></label>
      </div>
      <div class="line checkbox-line">
        <%= check_box_tag(
                'template[approveOnlyNew]',
                'true',
                !(@approval_template.nil? || @approval_template.reapproveOnPublish),
                :id => 'template_approveOnlyNew'
            ) %>
        <label for="template_approveOnlyNew"><%= t('screens.admin.routing_approval.approve_only_new_datasets') %></label>
        <span class="info"><%= t('screens.admin.routing_approval.approve_only_new_datasets_info') %></span>
      </div>

      <h3><%= t('screens.admin.routing_approval.stages') %></h3>
      <p class="info deleteInfo"><%= t('screens.admin.routing_approval.clear_stage_name_to_delete') %></p>
      <ul class="stageList">
        <%- (@approval_template.nil? ? [] : (@approval_template.stages || [])).clone.push({'id' => 'new-0'}).
          each do |stage| -%>
        <li class="stageItem clearfix">
          <div class="line">
            <label for="template_stages_<%= stage['id'] %>_name"><%= t('screens.admin.routing_approval.name') %></label>
            <input type="text" id="template_stages_<%= stage['id'] %>_name"
              name="template[stages][<%= stage['id'] %>][name]" class="stageName"
              value="<%= stage['name'] %>" />
          </div>
          <div class="line">
            <label for="template_stages_<%= stage['id'] %>_notificationMode">
              <%= t('screens.admin.routing_approval.notification_method') %>
            </label>
            <%= select_tag("template[stages][#{stage['id']}][notificationMode]",
            options_for_select({
                'S' => t('screens.admin.routing_approval.one_at_a_time'),
                'P' => t('screens.admin.routing_approval.everyone_at_once')
            }.invert,
            stage['notificationMode'])) %>
          </div>
          <div class="line">
            <label for="template_stages_<%= stage['id'] %>_notificationInterval">
              <%= t('screens.admin.routing_approval.notification_interval') %>
            </label>
            <%= select_tag("template[stages][#{stage['id']}][notificationInterval]",
            notification_interval_select_options(stage['notificationInterval'])) %>
          </div>
          <div class="line">
            <label><%= t('screens.admin.routing_approval.approvers') %></label>
            <ul class="userList">
              <%- (stage['approverUids'] || []).each do |userId| -%>
              <%- user = @users[userId] -%>
              <li class="userItem">
              <input type="text"
                name="template[stages][<%= stage['id'] %>][approverUids][]"
                value="<%= profile_path(user) %>" />
              <a href="<%= profile_path(user) %>"
                class="userLink"><%= user.displayName %></a>
              </li>
              <%- end -%>
              <li class="userItem newItem">
              <input type="text" class="userId"
                name="template[stages][<%= stage['id'] %>][approverUids][]" />
              <span><%= t('screens.admin.routing_approval.enter_profile') %></span>
              </li>
            </ul>
          </div>
        </li>
        <%- end -%>
      </ul>

      <%- if @approval_template.nil? -%>
      <div class='line'>
        <label for="grandfatherDatasets"><%= t('screens.admin.routing_approval.keep_datasets_visible') %></label>
        <input type="checkbox" id="grandfatherDatasets"
          name="grandfatherDatasets" value="true" checked="checked" />
        <span class="info"><%= t('screens.admin.routing_approval.keep_datasets_visible_info') %></span>
      </div>
      <%- end -%>

      <ul class="finishButtons clearfix">
        <li>
          <input class="button templateSave" type="submit"
            value="<%= @approval_template.nil? ? t('core.dialogs.create') : t('core.dialogs.save') %>" />
        </li>
        <li>
          <input class="button close" type="reset" value="<%= t('core.dialogs.cancel') %>" />
        </li>
      </ul>
    <% end %>
  </div>
</div>

<%= render_admin_qualtrics %>

<%- content_for :js_footer do -%>
  <%- unless params[:no_js] == 'true' -%>
    <%= include_webpack_bundle 'open-data/admin-routing-approval.js' %>
  <%- end -%>
<%- end -%>

<% content_for :translations do %>
  <%= render_translations LocalePart.screens.ds %>
  <%= render_translations LocalePart.screens.admin.routing_approval %>
<% end %>

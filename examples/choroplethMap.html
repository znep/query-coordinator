<!DOCTYPE html>
<html>
  <head>
    <title>Example Usage: socrata.visualizations.Choropleth.js</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF8">
    <!-- `leaflet.css` must be included or the map will render incorrectly -->
    <link rel="stylesheet" media="all" href="../bower_components/leaflet/dist/leaflet.css">
    <link rel="stylesheet" media="all" href="../src/views/styles/choroplethMap.css">
    <link rel="stylesheet" media="all" href="../src/views/styles/flyoutRenderer.css">
    <style type="text/css">

      body {
        font-size: 10px;
        font-family: sans-serif;
      }

      #choropleth1, #choropleth2 {
        display: block;
        position: relative;
        width: 640px;
        height: 480px;
        margin: 50px auto 0 auto;
        border: 1px solid #aaa;
      }

    </style>
  </head>
  <body>
    <div id="choropleth1"></div>
    <div id="choropleth2"></div>
  </body>
  <script type="text/javascript" src="../bower_components/lodash/lodash.js"></script>
  <script type="text/javascript" src="../bower_components/jquery/dist/jquery.js"></script>
  <script type="text/javascript" src="../bower_components/d3/d3.js"></script>
  <script type="text/javascript" src="../bower_components/socrata-utils/socrata.utils.js"></script>
  <script type="text/javascript" src="../bower_components/chroma-js/chroma.min.js"></script>
  <script type="text/javascript" src="../bower_components/simple-statistics/src/simple_statistics.js"></script>
  <script type="text/javascript" src="../dist/frontend-visualizations-jquery-plugins.js"></script>
  <script type="text/javascript">

    $(document).ready(function() {

      /**
       * Sample data!
       */

      var DATASET_UID = 'hsns-kwdt';
      var DOMAIN = 'dataspace.demo.socrata.com';
      var GEOJSON_UID = 'snuk-a5kv';

      /**
       * Render things!
       */

      var flyoutRenderer = new socrata.visualizations.views.FlyoutRenderer();

      var choroplethVIF = {
        'aggregation': {
          // TODO: implement this!
        },
        'columnName': 'ward',
        'configuration': {
          'baseLayerUrl': 'https://a.tiles.mapbox.com/v3/socrata-apps.ibp0l899/{z}/{x}/{y}.png',
          'baseLayerOpacity': 0.8,
          'defaultExtent' : {
            'southwest': [41.45919537950706, -90.24169921875],
            'northeast': [42.20817645934742, -85.242919921875]
          },
          'legend': {
            'type': 'continuous'
          },
          // The localization values should be set by the application but are set to string literals
          // for the purposes of this example.
          'localization': {
            'FLYOUT_SELECTED_NOTICE': 'The page is currently filtered by this value, click to clear it',
            'FLYOUT_UNFILTERED_AMOUNT_LABEL': 'Total',
            'FLYOUT_FILTERED_AMOUNT_LABEL': 'Filtered',
            'NULL_VALUE_LABEL': '(No Value)',
            'CLEAR_FILTER_LABEL': 'Clear filter'
          },
          'savedExtent': {
            'southwest': [41.42625319507272, -88.5662841796875],
            'northeast': [42.24478535602799, -86.9183349609375]
          },
          'shapefile': {
            'columns': {
              'name': '__SOCRATA_HUMAN_READABLE_NAME__',
              'unfiltered': '__SOCRATA_UNFILTERED_VALUE__',
              'filtered': '__SOCRATA_FILTERED_VALUE__',
              'selected': '__SOCRATA_FEATURE_SELECTED__'
            },
            'geometryLabel': 'ward',
            'primaryKey': '_feature_id',
            'uid': GEOJSON_UID
          }
        },
        'datasetUid': DATASET_UID,
        'description': 'An example choropleth',
        'domain': DOMAIN,
        'filters': [],
        'format': {
          'type': 'visualization_interchange_format',
          'version': 1
        },
        'title': 'Example Usage: socrata.visualizations.ChoroplethMap.js',
        'type': 'choropleth',
        'unit': {
          'one': 'crime',
          'other': 'crimes'
        }
      };

      var choroplethVIF1 = _.cloneDeep(choroplethVIF);

      var choroplethVIF2 = _.cloneDeep(choroplethVIF);
      choroplethVIF2.configuration.legend = {
        'type': 'discrete'
      };

      var $choroplethElement1 = $('#choropleth1');
      var visualization1 = $choroplethElement1.socrataChoroplethMap(choroplethVIF1);

      var $choroplethElement2 = $('#choropleth2');
      var visualization2 = $choroplethElement2.socrataChoroplethMap(choroplethVIF2);

      /**
       * Handle flyout events.
       */

      $choroplethElement1.on('SOCRATA_VISUALIZATION_CHOROPLETH_FLYOUT_EVENT', handleFlyout);
      $choroplethElement2.on('SOCRATA_VISUALIZATION_CHOROPLETH_FLYOUT_EVENT', handleFlyout);

      function handleFlyout(event) {

        var payload = event.originalEvent.detail;

        // Render/hide a flyout
        if (payload !== null) {
          flyoutRenderer.render(payload);
        } else {
          flyoutRenderer.clear();
        }
      }

      /**
       * Destroy the plugin.
       *
       * The plugin (and all internal modules) can be destroyed by calling
       * `.destroySocrataChoroplethMap()` on the element.
       */

      // $choroplethElement1.off('SOCRATA_VISUALIZATION_CHOROPLETH_FLYOUT_EVENT', handleFlyout);
      // $choroplethElement1.destroySocrataChoroplethMap();

      // $choroplethElement2.off('SOCRATA_VISUALIZATION_CHOROPLETH_FLYOUT_EVENT', handleFlyout);
      // $choroplethElement2.destroySocrataChoroplethMap();

    });
  </script>
</html>

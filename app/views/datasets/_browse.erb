<%= render_browse_includes unless supress_includes %>

<%- cur_sort = @sort_opts.detect {|s| s[:value] == @opts[:sortBy]} -%>
<%- show_time_period = cur_sort.nil? ? false : cur_sort[:is_time_period] -%>

<div class='browseSection <%= @facets.length < 1 ? 'noFacets' : '' %>
  <%= @browse_in_container ? 'inContainer' : '' %>'>
  <%- if @facets.length > 0 -%>
  <div class='browseFacets <%= show_time_period ? 'hasTimePeriod' : '' %>'>
    <form class='searchSection'>
      <span class='icon'></span>
      <input type='text' name='browseSearch' title='Search'
        class='textPrompt searchBox' value='<%= @params[:q] %>' />
      <%- if !@params[:q].nil? -%>
      <%- cp = @params.reject {|p, v| p.to_s == 'page' || p.to_s == 'q' ||
            p.to_s == 'no_default'} -%>
      <a href='<%= @base_url + '?' + cp.to_param %>'
        class='clearSearch close'><span class='icon'></span></a>
      <%- end -%>
    </form>

    <%- if !@params[:q].nil? || @facets.any? {|f| !@params[f[:param]].nil? } ||
          !@params[:no_default].nil? -%>
    <div class='facetSection clearAllSection'>
      <ul>
        <li>
        <%- cp = @params.reject {|p, v| p.to_s == 'page' || p.to_s == 'q' ||
              p.to_s == 'no_default'} -%>
        <%- @facets.each do |f| -%>
        <%- cp.delete(f[:param]) -%>
        <%- end -%>
        <a href='<%= @base_url + '?' + cp.to_param %>'>Clear All Options</a>
        </li>
      </ul>
    </div>
    <%- end -%>

    <%- @facets.each do |facet| -%>
    <%- next if facet[:options].nil? || facet[:options].length < 1 -%>
    <div class='facetSection clearfix'>
      <h4 class='title'><%= facet[:title] %></h4>
      <ul>
        <%- if !@params[facet[:param]].nil? ||
              !@default_params[facet[:param]].nil? -%>
        <%- cp = @params.reject {|p, v| p.to_s == 'page'} -%>
        <%- cp.delete(facet[:param]) -%>
        <%- cp[:no_default] = facet[:param] if !@default_params[facet[:param]].nil? -%>
        <li><a href='<%= @base_url + '?' + cp.to_param %>' class='clearValues'>
          <%- if facet[:use_icon] -%>
          <span class='icon'></span>
          <%- end -%>
          (All)
        </a></li>
        <%- end -%>
        <%- facet[:options].each do |f| -%>
        <%- cp = @params.reject {|p, v| p.to_s == 'page' ||
              p.to_s == 'no_default'} -%>
        <%- cp[facet[:param]] = f[:value] -%>
        <li><a href='<%= @base_url + '?' + cp.to_param %>'
          class='<%= f[:class] %> <%= @params[facet[:param]] == f[:value] ||
            (@params[facet[:param]].nil? &&
              @default_params[facet[:param]] == f[:value]) ?
            'active' : '' %>'>
          <%- if facet[:use_icon] -%>
          <span class='icon'></span>
          <%- end -%>
          <%= f[:text] %>
        </a></li>
        <%- end -%>
      </ul>
      <%- if !facet[:extra_options].nil? -%>
      <a class='moreLink' href='#More <%= facet[:title] %>'>View more</a>
      <div class='moreOptions hide'>
        <%- facet[:extra_options].each do |f| -%>
        <%- cp = @params.reject {|p, v| p.to_s == 'page' ||
              p.to_s == 'no_default'} -%>
        <%- cp[facet[:param]] = f[:value] -%>
        <a href='<%= @base_url + '?' + cp.to_param %>'
          rel='<%= f[:count] %>'>
          <%# We need a space inside the a, or else when we stick them in
          the dialog, tags without any space will not wrap at all %>
          <%= f[:text] %>
        </a>
        <%- end -%>
      </div>
      <%- end -%>
    </div>
    <%- end -%>
  </div>
  <%- end -%>

  <%- if ((CurrentDomain.user_can?(current_user, :create_datasets) || CurrentDomain.module_enabled?(:community_creation))) -%>
  <div class='createDatasetBox infoBox'>
    <h3>Create or upload your own dataset</h3>
    <div class="buttonContainer">
      <a class='button next' href='/datasets/new' title='Create a new dataset'>
        <%= @browse_in_container ? 'Create a new Dataset' : 'Create' %><span class='icon'></span>
      </a>
    </div>
  </div>
  <%- end -%>

  <div class='browseList'>
    <%- if !@browse_in_container -%>
    <div class='titleContainer'>
      <h2 title='<%= @title %>'><%= @title %></h2>
    </div>
    <%- end -%>
    <%- if @view_count > 0 && @sort_opts.length > 0 -%>
    <div class='sortOptions'>
      <select class='sortType' name='sortType'>
        <%- @sort_opts.each do |so| -%>
        <%- next if !so[:requires].nil? && @params[so[:requires]].nil? -%>
        <option value='<%= so[:value] %>' class='<%= so[:is_time_period] ?
          'timePeriod' : '' %>' <%= so[:value] == @opts[:sortBy] ?
          "selected='selected'" : '' %>><%= so[:name] %></option>
        <%- end -%>
      </select>
      <%- time_opts = [
        {:value => 'week', :name => 'This week'},
        {:value => 'month', :name => 'This month'},
        {:value => 'year', :name => 'This year'}
      ] -%>
      <select class='sortPeriod <%= !show_time_period ? 'hide' : '' %>'
        name='sortPeriod'>
        <%- time_opts.each do |to| -%>
        <option value='<%= to[:value] %>' <%= to[:value] == @params[:sortPeriod] ?
          "selected='selected'" : '' %>><%= to[:name] %></option>
        <%- end -%>
      </select>
    </div>
    <%- end -%>

    <div class='results'>
      <%- if @view_count == 0 -%>
      <div class='noResults'>
        <span class='message'><%= @no_results_text %></span>
        <%- if (CurrentDomain.user_can?(current_user, :create_datasets) ||
              CurrentDomain.module_enabled?(:community_creation)) -%>
        <a class='button createLink' href='/datasets/new'>Create New Dataset</a>
        <%- end -%>
        <%- if CurrentDomain.module_enabled?(:dataset_nomination) -%>
        <a class='button suggestLink' href='/nominate'>Suggest a Dataset</a>
        <%- end -%>
      </div>

      <%- else -%>
      <table class='gridList'>
        <colgroup>
          <col class='index' />
          <%- if @use_federations -%>
          <col class='domainIcon' />
          <%- end -%>
          <col class='nameDesc' />
          <col class='popularity' />
          <col class='type' />
        </colgroup>
        <thead>
          <tr>
            <th class='index'></th>
            <%- if @use_federations -%>
            <th class='domainIcon'></th>
            <%- end -%>
            <th class='nameDesc'>Name</th>
            <th class='popularity'>Popularity</th>
            <th class='type'>Type</th>
          </tr>
        </thead>
        <tbody>
          <%- start_index = (@opts[:page] - 1) * @limit + 1 -%>
          <%- @view_results.each_with_index do |v, i| -%>
          <tr class='item collapsed' data-viewId='<%= v.id %>'>
            <td class='index'>
              <a class='expander' title='Click to expand' href='#Expand'>
                <span class='icon'></span>
              </a>
              <span class='value'><%= start_index + i %>.</span>
            </td>
            <%- rel_type = v.federated? ?
                  CurrentDomain.feature?(:federated_interstitial) ?
                    'externalDomain' : 'external' : '' -%>
            <%- if @use_federations -%>
            <td class='domainIcon'>
              <a href='<%= v.href(@port) %>' rel='<%= rel_type %>'>
                <img src='<%= v.domain_icon_href %>' alt='<%= v.federated? ?
                  'Federated from ' + v.domainCName : CurrentDomain.cname %>' />
              </a>
            </td>
            <%- end -%>
            <td class='nameDesc'>
              <a href='<%= v.href(@port) %>' class='name'
                rel='<%= rel_type %>'><%= v.name %></a>
              <%- if !v.category.blank? -%>
              <span class='category infoItem'><%= v.category %></span>
              <%- end -%>
              <%- if !v.tags.nil? -%>
              <span class='tags infoItem'><%= v.tags.join(', ') %></span>
              <%- end -%>
              <div class='expandBlock clearfix collapsed'>
                <div class='description'><%= v.description %></div>
                <div class='extraInfo <%= @use_federations ? 'federated' : '' %>'>
                  <div class='infoContent'></div>
                  <a class='close' href='#Close'><span class='icon'></span></a>
                </div>
              </div>
            </td>
            <td class='popularity'>
              <span class='visits'><%= pluralize(number_with_delimiter(v.viewCount,
                {:locale => 'en'}), 'view') %></span>
            </td>
            <td class='type type<%= v.display.type.capitalize %>'
              title='<%= v.display.name.capitalize %>'>
              <div class='icon'></div>
            </td>
          </tr>
          <%- end -%>
        </tbody>
      </table>
      <%- end -%>
    </div>

    <%- if @view_count > 0 -%>
    <%= create_pagination(@view_count, @limit,
      @opts[:page], @base_url + '?' + @params.to_param, 'button') %>
    <%- end -%>
  </div>

  <%- if !@browse_in_container &&
          CurrentDomain.module_enabled?(:dataset_nomination) -%>
  <div class='suggestBox infoBox'>
    <h3>Didn't find what you're looking for? Suggest a dataset</h3>
    <div class="buttonContainer">
      <a class='button next' href='/nominate'>Suggest<span class='icon'></span></a>
    </div>
  </div>
  <%- end -%>

  <div class="clearBoth"></div>
</div>

<script type='text/javascript'>
  $(function()
  {
     blist.namespace.fetch('blist.browse');
     blist.browse.datasets = {};
     <%- @view_results.each do |v| -%>
     blist.browse.datasets['<%= v.id %>'] = <%= safe_json(v) %>;
     <%- end -%>
     blist.browse.baseURL = '<%= @base_url %>';
  });
</script>

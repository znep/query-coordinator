<% content_for :head do %>
  <%= auto_discovery_link_tag(:rss, "/views/#{@view.id}/rows.rss") %>
  <%= stylesheet_link_merged 'blist-show-alt' %>
  <title><%= h(@view.name) %> | <%= CurrentDomain.strings.site_title %></title>
  <%= meta_tags :description => @meta_description, :keywords => @meta_keywords %>
  <link rel="canonical" href="<%= @view.href %>" />
<% end %>

<% content_for :skip_links do %>
  <a href="#dataGrid" accesskey="d">Skip to data</a>
  <a href="#metaTabs" accesskey="m">Skip to metadata information</a>
<% end %>

<%- is_owner = current_user && @view.owner.id == current_user.id -%>
<%- is_blist = @view.is_blist? %>
<%- can_edit = current_user && @view.can_edit() -%>

<div class="altShowContainer oneColumnContainer <%= @view.is_invalid? ? 'invalidView' : '' %>">
  <div class="fullPageContentContainer">
    <div class="fullPageOuterContent">
      <div class="fullPageContent">
        <div class="outerContent">
          <div class="contentTR"><div class="contentTL"></div></div>
          <div class="content">
            <ul id="datasetMenu">
              <li><a href="<%= @view.href %>/about">About this Dataset...</a></li>
              <li><a href="<%= @view.href %>/print">Print...</a></li>
              <li><a href="<%= @view.href %>/email">Email...</a></li>
              <li><a href="<%= @view.href %>/append">Append Rows via Upload...</a></li>
              <li><a href="<%= @view.href %>/replace">Replace Rows via Upload...</a></li>
              <li><a href="/views/<%= @view.id %>/rows.rss">Subscribe via RSS</a></li>
            <%- socialize_menu_options(@view).each do |item| -%>
              <li><a href="<%= item['href'] %>">Share via <%= item['text'] %></a></li>
            <%- end -%>
              <li><a href=""></a></li>
              <li><a href="/views/<%= @view.id %>/rows.csv?accessType=DOWNLOAD">Export To CSV</a></li>
              <li><a href="/views/<%= @view.id %>/rows.xls?accessType=DOWNLOAD">Export To XLS</a></li>
              <li><a href="/views/<%= @view.id %>/rows.xlsx?accessType=DOWNLOAD">Export To XLSX</a></li>
            </ul>
            <a name="dataGrid"></a>

            <h1><%= @view.name %></h1>
            <% if @view.parent_dataset != @view %>
              <p>This is a filtered view based on <%= link_to @view.parent_dataset.name, @view.parent_dataset.alt_href %>.</p>
            <% end %>

            <div class="dataGridWrapper">
              <table id="dataGrid">
                <%= render(:partial => 'alt_tbody',
                  :locals => {:columns => @view.viewable_columns,
                  :rows => @data, :start_page => @page, :parent_id => '0'}) %>
                <% unless @aggregates.nil? or @aggregates.none? %>
                  <tfoot>
                    <tr>
                      <th>Totals</th>
                      <% @view.viewable_columns.each do |column|%>
                      <th>
                        <%- agg = @aggregates.find{|aggregate|
                            aggregate['columnId'] == column.id} -%>
                        <%= agg['value'] if !agg.nil? %>
                      </th>
                      <% end %>
                    </tr>
                  </tfoot>
                <% end %>
              </table>
            </div>
            <div id="pagination links" style="margin: 20px;">
              <%= will_paginate @data %>

            </div>
          </div>
          <%# This is somewhat ugly but is inline for perf reasons %>
          <% form_tag alt_filter_blist_path(@view.id) do -%>
          <h2>Filter</h2>
          <% @view.viewable_columns.each do |filter_field| %>
          <%- unless filter_field.possible_filter_conditions.nil? -%>
          <p>
          <%= label_tag "Filter on #{filter_field.name}" %>
          <%= select_tag "limit_#{filter_field.id}",
            options_for_limit_to(filter_field)%>
          <%= text_field_tag "cell_content_#{filter_field.id}" %>
          </p>
          <% end %>
          <% end %>

          <h2>Sort</h2>
          <% 1.upto(5) do |n|%>
          <%= label_tag "Sort field #{n.to_s}" %>
          <%= select_tag "sort_field_#{n}", options_for_sort_by(@view.viewable_columns)%>
          <%= select_tag "sort_direction_#{n}", options_for_select(["Ascending", "Descending"]), :value =>"Ascending" %>

          <% end %>
          <%= submit_tag "submit" %>
          <% end -%>
          <h2>Search</h2>
          <% form_tag alt_filter_blist_path(@view.id) do -%>
          <%= label_tag "Search" %>
          <%= text_field_tag "search", @search_query %>
          <%= link_to "clear search", @view.alt_href %>
          <%= submit_tag "submit" %>
          <% end %>
        </div>
        <% if @query_json and current_user %>
        <h2>Save this view</h2>
        <% form_tag save_filter_blist_path(@view.id) do -%>
        <%= hidden_field_tag 'query_json', @query_json %>
        <%= label_tag "Name" %>
        <%= text_field_tag "name" %>
        <%= submit_tag "submit" %>
        <% end %>
        <% elsif @query_json and not current_user %>
        <div><%= link_to "Sign in to save this view.", :controller => :blists, :action => :login_to_alt, :id => @view.id, :query_json => @query_json %></div>
        <% end %>
        <h2>Saved Views</h2>
        <% @view.filters.each do |filter| %>

        <ul>
          <li><%= link_to filter.name, filter.alt_href %></li>
        </ul>
        <% end %>
        <h2>Comments</h2>
        <h2>
          <%= pluralize(@view.numberOfComments, 'Comment') %>
        </h2>
        <h2><%= @view.averageRating %> Average Rating</h2>
        <h2><%= pluralize(@view.totalTimesRated, 'Rating') %></h2>

        <%- form_tag(alt_post_comment_blist_path(@view.id)) do -%>

        <%= label_tag "My Rating" %>
        <%= select_tag("comment[viewRating]", options_for_select([1, 2, 3, 4, 5].reverse)) %>
        <%= label_tag "Title" %>
        <%= text_field_tag("comment[title]") %>
        <%= label_tag "Body" %>
        <%= text_area_tag("comment[body]") %>
        <%= submit_tag "submit" %>
        <%- end -%>

        <% @view.comments.each do |comment| %>
        <div class="comment">
          <p>Rating:           <%= get_comment_rating_html(comment) %></p>
          <p><%= comment.title %></p>
          <p><%= comment.user.displayName %></p>

          <p><%= humane_date(comment.createdAt) %></p>

          <p><%= comment.body %></p>

        </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!DOCTYPE html>
<html>
  <head>
    <title>Example Usage: SvgBarChart.js</title>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=UTF8">
    <link rel="stylesheet" media="all" href="../dist/socrata-visualizations.css">
    <!-- Include styleguide to test for style namespace collisions -->
    <link rel="stylesheet" media="all" href="../node_modules/socrata-components/dist/css/styleguide.css">
    <style type="text/css">

      body {
        font-size: 10px;
        font-family: sans-serif;
      }

      #bar-chart-1,
      #bar-chart-2,
      #bar-chart-3,
      #bar-chart-4,
      #bar-chart-5,
      #bar-chart-6,
      #bar-chart-7 {
        display: block;
        position: relative;
        width: 640px;
        height: 480px;
        margin: 100px auto 0 auto;
      }
    </style>
  </head>
  <body>
    <p>Unaggregated data</p>
    <div id="bar-chart-1"></div>
    <p>Unaggregated data with limit = 10</p>
    <div id="bar-chart-2"></div>
    <p>Unaggregated data with limit = 10 and 'showOtherCategory'</p>
    <div id="bar-chart-3"></div>
    <p>Aggregated data with dimension sorted ascending alphabetically</p>
    <div id="bar-chart-4"></div>
    <p>Multi-series unaggregated data</p>
    <div id="bar-chart-5"></div>
    <p>Unaggregated data with measure sorted descending by value</p>
    <div id="bar-chart-6"></div>
    <p>Multi-series unaggregated data with measure axis min and max values</p>
    <div id="bar-chart-7"></div>
  </body>

  <!-- Include external vendor -->
  <script type="text/javascript" src="./vendor.js"></script>

  <!-- Include bundle -->
  <script type="text/javascript" src="../dist/socrata-visualizations.js"></script>

  <script type="text/javascript">

    $(document).ready(function() {

      /**
       * Set up VIFs
       */

      var DIMENSION = 'district_name';
      var MEASURE = 'proficient_2';
      var MEASURE_AGGREGATION = null;
      var DATASET_UID = 'mu6e-brbz';
      var DOMAIN = 'data.iowa.gov';
      var FILTERS = [
        {
          columnName: 'topic',
          function: 'binaryOperator',
          arguments: {
            operator: '=',
            operand: 'Math'
          },
          pivot: true
        },
        {
          columnName: 'grade',
          function: 'binaryOperator',
          arguments: {
            operator: '=',
            operand: '3'
          },
          pivot: true
        },
        {
          columnName: 'school_year',
          function: 'binaryOperator',
          arguments: {
            operator: '=',
            operand: '2014'
          },
          pivot: true
        }
      ];

      var barChart1Vif = {
        configuration: {
          viewSourceDataLink: true,
          axisLabels: {
            top: 'School District',
            right: '% Proficient',
            bottom: 'School Districts in Iowa, Sorted Alphabetically',
            left: '% of 3rd Grade Students Rated Proficient in Math (For Real)'
          }
        },
        description: 'Math proficiency by school district for 3rd graders in 2014',
        series: [
          {
            color: {
              secondary: null,
              highlight: '#44ffaa'
            },
            dataSource: {
              datasetUid: DATASET_UID,
              dimension: {
                columnName: DIMENSION,
                aggregationFunction: null
              },
              domain: DOMAIN,
              measure: {
                columnName: MEASURE,
                aggregationFunction: MEASURE_AGGREGATION
              },
              type: 'socrata.soql',
              filters: FILTERS
            },
            label: 'Proficient',
            type: 'barChart',
            unit: {
              one: 'percent of students',
              other: 'percent of students'
            }
          }
        ],
        createdAt: '2014-01-01T00:00:00',
        format: {
          type: 'visualization_interchange_format',
          version: 2
        },
        origin: {
          type: 'test_data',
          url: 'localhost'
        },
        scale: {
          x: {
            type: 'ordinal',
            unit: {
              one: 'category',
              other: 'categories'
            }
          },
          y: {
            type: 'quantitative'
          }
        },
        title: 'Math Proficienty for 3rd Graders - Iowa Public Schools'
      };

      var barChart2Vif = _.cloneDeep(barChart1Vif);
      barChart2Vif.series[0].dataSource.limit = 10;

      var barChart3Vif = _.cloneDeep(barChart1Vif);
      barChart3Vif.configuration.showOtherCategory = true;
      barChart3Vif.series[0].dataSource.limit = 10;

      var VIF_1_COLUMN_NAME = 'category';
      var VIF_1_DATASET_UID = 'r6t9-rak2';
      var VIF_1_DOMAIN = 'dataspace.demo.socrata.com';

      // This is a version 1 VIF, which should be automatically migrated
      // when passed to the visualization.
      var barChart4Vif = {
        'aggregation': {
          'columnName': null,
          'function': 'count'
        },
        'columnName': VIF_1_COLUMN_NAME,
        'configuration': {},
        'createdAt': '2014-01-01T00:00:00',
        'datasetUid': VIF_1_DATASET_UID,
        'domain': VIF_1_DOMAIN,
        'filters': [],
        'format': {
          'type': 'visualization_interchange_format',
          'version': 1
        },
        'origin': {
          'type': 'test_data',
          'url': 'localhost'
        },
        'title': VIF_1_COLUMN_NAME,
        'type': 'barChart',
        'unit': {
          'one': 'case',
          'other': 'cases'
        }
      };

      var barChart5Vif = _.cloneDeep(barChart1Vif);
      barChart5Vif.configuration.axisLabels = {
        top: null,
        right: null,
        bottom: 'School District',
        left: '# Proficient v.s. Total'
      };
      barChart5Vif.title = null;
      barChart5Vif.description = null;
      barChart5Vif.series = [
        {
          color: {
            primary: 'silver',
            secondary: null,
          },
          dataSource: {
            datasetUid: DATASET_UID,
            dimension: {
              columnName: DIMENSION,
              aggregationFunction: null
            },
            domain: DOMAIN,
            measure: {
              columnName: 'proficient_1',
              aggregationFunction: null
            },
            type: 'socrata.soql',
            filters: FILTERS.concat([
              {
                columnName: 'district_name',
                function: 'binaryOperator',
                arguments: [
                  {
                    operator: '=',
                    operand: 'Ames'
                  },
                  {
                    operator: '=',
                    operand: 'Ankeny'
                  },
                  {
                    operator: '=',
                    operand: 'Cedar Falls'
                  }
                ]
              }
            ])
          },
          label: 'Proficient',
          type: 'barChart',
          unit: {
            one: 'student',
            other: 'students'
          }
        },
        {
          color: {
            primary: 'gold',
            secondary: null,
          },
          dataSource: {
            datasetUid: DATASET_UID,
            dimension: {
              columnName: DIMENSION,
              aggregationFunction: null
            },
            domain: DOMAIN,
            measure: {
              columnName: 'total',
              aggregationFunction: null
            },
            type: 'socrata.soql',
            filters: FILTERS.concat([
              {
                columnName: 'district_name',
                function: 'binaryOperator',
                arguments: [
                  {
                    operator: '=',
                    operand: 'Ames'
                  },
                  {
                    operator: '=',
                    operand: 'Ankeny'
                  },
                  {
                    operator: '=',
                    operand: 'Cedar Falls'
                  }
                ]
              }
            ])
          },
          label: 'Total',
          type: 'barChart',
          unit: {
            one: 'student',
            other: 'students'
          }
        }
      ];

      var barChart6Vif = _.defaultsDeep({}, barChart1Vif, {
        configuration: {
          showOtherCategory: true
        },
        series: [{
          dataSource: {
            orderBy: {
              parameter: 'measure',
              sort: 'desc'
            }
          }
        }]
      });

      var barChart7Vif = _.cloneDeep(barChart5Vif);
      barChart7Vif.configuration.measureAxisMinValue = 250;
      barChart7Vif.configuration.measureAxisMaxValue = 500;

      /**
       * Instantiate the plugins
       */

      var flyoutRenderer = new socrata.visualizations.views.FlyoutRenderer();

      var $barChart1Element = $('#bar-chart-1');
      $barChart1Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart1Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart1Element.socrataSvgBarChart(barChart1Vif);

      var $barChart2Element = $('#bar-chart-2');
      $barChart2Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart2Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart2Element.socrataSvgBarChart(barChart2Vif);

      var $barChart3Element = $('#bar-chart-3');
      $barChart3Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart3Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart3Element.socrataSvgBarChart(barChart3Vif);

      var $barChart4Element = $('#bar-chart-4');
      $barChart4Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart4Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart4Element.socrataSvgBarChart(barChart4Vif);

      var $barChart5Element = $('#bar-chart-5');
      $barChart5Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart5Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart5Element.socrataSvgBarChart(barChart5Vif);

      var $barChart6Element = $('#bar-chart-6');
      $barChart6Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart6Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart6Element.socrataSvgBarChart(barChart6Vif);

      var $barChart7Element = $('#bar-chart-7');
      $barChart7Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart7Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart7Element.socrataSvgBarChart(barChart7Vif);

      /**
       * Handle plugin events
       */

      function handleFlyout(event) {
        var payload = event.originalEvent.detail;

        // Render/hide a flyout
        if (payload !== null) {

          flyoutRenderer.render(payload);

        } else {

          flyoutRenderer.clear();
        }
      }

      function handleVifUpdated(event) {
        var payload = event.originalEvent.detail;
        var renderVifEvent = jQuery.Event('SOCRATA_VISUALIZATION_RENDER_VIF');

        renderVifEvent.originalEvent = {
          detail: payload
        };

        $(this).trigger(renderVifEvent);
      }

      /**
       * Destroy the plugins
       */

      // $barChart1Element.off('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      // $barChart1Element.off('SOCRATA_VISUALIZATION_VIF_UPDATED', handleVifUpdated);
      // $barChart1Element.trigger('SOCRATA_VISUALIZATION_DESTROY');

      // $barChart2Element.off('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      // $barChart2Element.off('SOCRATA_VISUALIZATION_VIF_UPDATED', handleVifUpdated);
      // $barChart2Element.trigger('SOCRATA_VISUALIZATION_DESTROY');

      // $barChart2Element.off('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      // $barChart2Element.off('SOCRATA_VISUALIZATION_VIF_UPDATED', handleVifUpdated);
      // $barChart2Element.trigger('SOCRATA_VISUALIZATION_DESTROY');
    });
  </script>
</html>

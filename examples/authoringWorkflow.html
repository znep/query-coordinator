<!DOCTYPE html>
<html>
  <head>
    <title>Example Usage: AuthoringWorkflow</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <link rel="stylesheet" media="all" href="../node_modules/socrata-components/dist/css/styleguide.css">
    <link rel="stylesheet" media="all" href="../node_modules/leaflet/dist/leaflet.css">
    <link rel="stylesheet" media="all" href="../dist/socrata-visualizations.css">

    <style>
      .custom-vif {
        background-color: purple;
      }

      #chart {
        display: block;
        position: relative;
        width: 640px;
        height: 490px;
      }

      #outputs p {
        background: #ddd;
        width: 100%;
        word-wrap: break-word;
      }
    </style>
  </head>

  <body>
    Select a VIF to launch AX, or
    <button id="custom-vif" class="btn">Paste one in</button>
    <button id="edit" class="btn">Edit Current</button>

    <div id="vif-selections"></div>
    <div id="authoring-workflow"></div>

    <section id='outputs'>
      <div id="chart"></div>

      <strong>Vif:</strong>
      <p>
        <button class="select">Select</button><br>
        <code id="vif-output" style="white-space: pre-wrap;"></code>
      </p>

      <strong>Filters:</strong>
      <p><code id="filter-output" style="white-space: pre-wrap;"></code></p>
    </section>
  </body>

  <!-- Include external vendor -->
  <script type="text/javascript" src="./vendor.js"></script>

  <!-- Include bundle -->
  <script type="text/javascript" src="../dist/socrata-visualizations.js"></script>

  <script type="text/javascript" src="./sample-vifs.js"></script>

  <script type="text/javascript">
    var vif;
    var filters;
    var authoringWorkflow;
    var AuthoringWorkflow = socrata.visualizations.AuthoringWorkflow;
    var VisualizationRenderer = socrata.visualizations.VisualizationRenderer;
    var container = document.querySelector('#authoring-workflow');
    var vifOutput = document.querySelector('#vif-output');
    var filterOutput = document.querySelector('#filter-output');
    var chart = document.querySelector('#chart');
    var visualization;

    $('#edit, #outputs').hide();

    function addVifButton(vif, vifName, extraClass) {
      return $('#vif-selections').append(
        $('<button class="launch btn btn-primary">'+vifName+'</button>').
          data('vif', vif).
          addClass(extraClass)
      );
    }

    _.each(window.socrata.sampleVifs, addVifButton)

    var onComplete = function(result) {
      vif = result.vif;
      filters = result.filters;
      vifOutput.innerHTML = JSON.stringify(vif, null, 2);
      filterOutput.innerHTML = JSON.stringify(filters, null, 2);

      chart.innerHTML = '';

      if (visualization) {
        visualization.destroy();
      }

      visualization = new VisualizationRenderer(result.vif, chart);

      authoringWorkflow.destroy();
      $('#edit, #outputs').show();
    };

    var onCancel = function() {
      authoringWorkflow.destroy();
    };

    var onBack = function() {
      console.log('Back to somewhere!');
    };

    function launchAx(vifToLoad) {
      authoringWorkflow = new AuthoringWorkflow(container, {
        vif: vifToLoad,
        backButtonText: 'Back to Dataset Selection',
        enableFiltering: true,
        onComplete: onComplete,
        onCancel: onCancel,
        onBack: onBack,
        useLogger: true
      });
    }

    $('#custom-vif').click(function() {
      var customVif = prompt('Paste yer vif here.');
      try {
        customVif = JSON.parse(customVif);
        addVifButton(customVif, _.uniqueId('Custom VIF '), 'custom-vif');
      } catch (e) {
        alert(e);
      }
    });

    $('#vif-selections').on('click', 'button', function(evt) {
      launchAx($(evt.target).data('vif'));
    });
    $('#edit').click(function() { launchAx(vif); });
    $('button.select').click(function(evt) {
      var range = document.createRange();
      range.selectNode($(evt.target).nextAll('code')[0]);
      window.getSelection().addRange(range);
    });
  </script>
</html>

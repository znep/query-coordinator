<% content_for :head do %>
  <%= auto_discovery_link_tag(:rss, "/views/#{@view.id}/rows.rss") %>
  <%= raw @view.display.render_stylesheet_includes %>
  <%= include_stylesheets 'grid-sidebar' %>
  <%= rendered_stylesheet_tag 'dataset-show' %>

  <meta name="viewport" content="width=1024, user-scalable=no, maximum-scale=1.0" />

  <title><%= h(@view.name) %> | <%= CurrentDomain.strings.site_title %></title>
  <link rel="canonical" href="<%= @view.href %>" />
<% end %>

<% content_for :skip_links do %>
  <%= link_to 'Go to an accessible version of this page', @view.alt_href %>

  <%- if @view.can_edit? -%>
    <%= link_to 'Edit the metadata of this dataset', @view.href + '/edit_metadata' %>
  <%- end -%>
<% end %>

<div id='datasetBar' class='clearfix'>
  <div id='infoBox'>
    <div id='datasetIcon' class='type<%= @view.display.type.capitalize %>'>
      <span class='icon currentViewName'><%= @view.display.name %></span>
      <span class='alertIcon'></span>
    </div>
    <div class='unsavedLine'>
      <h2 id='unsavedTitle'>Unsaved View</h2>
      <%- if !@view.is_blist? && @view.has_rights?('update_view') -%>
      <a href='#Save' title='Save current view' data-savingText='Saving...'
        class='save toolbarButton'>Save</a>
      <%- end -%>
      <a href='#SaveAs' title='Save view as...'
        class='saveAs toolbarButton'>Save As...</a>
      <a href='#Revert' title='Revert to saved view'
        class='revert toolbarButton'>Revert</a>
    </div>
    <h2 id='datasetName' class="clipText currentViewName"><%= @view.name %></h2>
    <div class="basedOnParent">
      Based on <a class="parentName"></a>
    </div>
    <div class='basedOnTemp'>
      Based on <a class='revertLink currentViewName' href="#revert"><%= @view.name %></a>
    </div>

    <div id='description'>
      <p class="collapsed"><%= raw(auto_link(h(@view.description), :html => { :rel => 'nofollow' })) || '(No description provided)'%></p>
      <a href="#expand" class="descriptionExpander rightArrow" title="Click to expand">
        <span class="icon"></span>
      </a>
    </div>

    <%- if @view.can_edit? && !@view.is_alt_view? -%>
    <div id='editBar' class='clearfix'>
      <ul id='editOptions'>
        <li><a href='#Undo' class='button undo' title='Undo'>
          <span class='icon'>Undo</span>
        </a></li>
        <li><a href='#Redo' class='button redo' title='Redo'>
          <span class='icon'>Redo</span>
        </a></li>
      </ul>

      <div id='formatOptions' class='disabled'>
        <ul>
          <li><a href='#format_bold' class='button bold toggleButton'
            title='Bold'><span class='icon'>Bold</span></a></li>
          <li><a href='#format_underline' class='button underline toggleButton'
            title='Underline'><span class='icon'>Underline</span></a></li>
          <li><a href='#format_italic' class='button italic toggleButton'
            title='Italic'><span class='icon'>Italic</span></a></li>
          <li><a href='#format_strikethrough' class='button strike toggleButton'
            title='Strikethrough'><span class='icon'>Strike</span></a></li>
          <li><a href='#format_unorderedList'
            class='button bulletedList toggleButton'
            title='Bulleted List'><span class='icon'>Bulleted List</span></a></li>
          <li><a href='#format_orderedList' class='button numberedList toggleButton'
            title='Numbered List'><span class='icon'>Numbered List</span></a></li>
          <li><a href='#format_link' class='button link toggleButton'
            title='Link'>Link</a></li>
          <li><%= select_tag("format_fontFamily", font_select_options('Helvetica'),
            {:class => 'fontFamily'}) %></li>
          <li><%= select_tag("format_fontSize", font_size_select_options(12),
            {:class => 'fontSize'}) %></li>
          <li><div class='menu color'>
            <a class='menuButton color' title='Font Color'>
              <span class='colorIcon colorIndicator'></span><span class='icon'></span>
            </a>
          </div></li>
          <li><div class='align menu alignLeft'></div></li>
        </ul>
      </div>
    </div>
    <%- end -%>

  </div>

  <div id='actionBox' class='clearfix'>
    <ul id="toolbarOptions" class='clearfix'>
      <li>
        <%- if @view.is_tabular? && !@view.is_form? -%>
        <ul id='renderTypeOptions' class="pillButtons">
          <li><a href='<%= @view.href %>'
            class='main <%= @view.display.type %> noRedirPrompt'
            title='View as <%= @view.display.name.downcase %>'>
            <span class='icon'></span>
          </a></li>
          <li><a href='<%= @view.href %>?defaultRender=richList'
            class='fatrow noRedirPrompt' title='View as a rich list'>
            <span class='icon'></span>
          </a></li>
          <li><a href='<%= @view.href %>?defaultRender=page'
            class='page noRedirPrompt' title='View a single row'>
            <span class='icon'></span>
          </a></li>
        </ul>
        <%- end -%>
      </li>
      <li>
        <div id='shareMenu' class='share menu'></div>
      </li>
      <%- unless @view.is_alt_view? -%>
      <li>
        <form id="searchForm" action="#">
          <span class="icon"></span>
          <input type="text" class="searchField textPrompt" title="Find in this Dataset" />
          <a href="#clear" class="clearSearch close"><span class="icon"></span></a>
        </form>
      </li>
      <%- end -%>
    </ul>
    <div class="sidebarOptionsContainer clearfix">
      <ul id='sidebarOptions' class="clearfix">
        <li><a href='#Edit' title='Edit' class="edit"
          data-paneName='edit'><span class="icon"></span>Edit</a></li>
        <li><a href='#More Views' title='More Views' class="moreViews"
          data-paneName='moreViews'><span class="icon"></span>More Views</a></li>
        <li><a href='#Filter' title='Filter' class='filter'
          data-paneName='filter'><span class="icon"></span>Filter
          <span class='alertIcon'></span></a></li>
        <li><a href='#Visualize' title='Visualize' class="visualize"
          data-paneName='visualize'><span class="icon"></span>Visualize</a></li>
        <li><a href='#Export' title='Export' class="export"
          data-paneName='export'><span class="icon"></span>Export</a></li>
        <li><a href='#Discuss' title='Discuss' class="feed"
          data-paneName='feed'><span class="icon"></span>Discuss</a></li>
        <li><a href='#Embed' title='Embed' class="embed"
          data-paneName='embed'><span class="icon"></span>Embed</a></li>
        <li><a href='#About' title='About' class="about"
          data-paneName='about'><span class="icon"></span>About</a></li>
      </ul>
    </div>
  </div>

  <a href="#toggleFullScreen" class="fullscreenButton maximize" title="Toggle full screen">
    <span class="icon">Toggle full screen</span>
  </a>
</div>

<div class='outerContainer'>
  <div class='innerContainer'>
    <div class="aboutLoad">
      <%= render :partial => 'about_dataset' %>
      <%- if @view.is_tabular? && !@view.is_form? && @view.display.valid? -%>
      <%# SEO links for individual rows %>
      <%- next_index = 0 -%>
      <%- if !@row.nil? -%>
      <%- next_index = @view.get_row_index(@row['sid']) + 1 -%>
      <%- end -%>
      <%- next_row = @view.get_row_by_index(next_index) -%>
      <%- if !next_row.nil? -%>
      <a href='<%= @view.href %>/<%= next_row['sid'] %>' class='rowLink'>
        <%= @row.nil? ? 'First' : 'Next' %> row
      </a>
      <%- end -%>
      <%- end -%>
    </div>
    <div class='mainSpinner loadingSpinnerContainer hide'>
      <div class='loadingSpinner'></div>
    </div>
    <div class='viewErrorContainer'>
      <%- if @view.has_rights?('update_view') -%>
      <div class='viewError'><%= @view.display.invalid_message %></div>
      <ul class='invalidActions'>
        <li>
          <a href='#Edit' class='editView button'>Edit View</a>
        </li>
        <%- if @view.has_rights?('delete_view') -%>
        <li>
          <a href='#Remove' class='removeView button'>Delete View</a>
        </li>
        <%- end -%>
      </ul>
      <%- else -%>
      <div class='viewError'>This view cannot be displayed</div>
      <%- end -%>
    </div>

    <div id='mainGrid' class='fullHeight'>
      <%= raw @view.display.render_body(self) %>
      <%= render(:partial => @view.display.render_partial) %>
    </div>

    <%- if @view.is_tabular? && !@view.is_form? -%>
    <div id='fatRowRenderType'
      class='fatRowRenderType navRenderType fullHeight hide'>
      <div class='columnHeaders'></div>
      <div class='rowList'></div>
      <ul class='navigation'>
        <%- if @view.has_rights?('update_view') -%>
        <li class='edit'><a class='button'
          href='<%= @view.href %>/edit_rr'>Edit Layout</a></li>
        <%- end -%>
        <li><a href='#start' title='View first row' class='start button'>
          <span class='icon'></span>
        </a></li>
        <li><a href='#previous' title='View previous row' class='previous button'>
          <span class='icon'></span>
        </a></li>
        <li class='page'><a href='#page'>0</a></li>
        <li><a href='#next' title='View next row' class='next button'>
          <span class='icon'></span>
        </a></li>
        <li><a href='#end' title='View last row' class='end button'>
          <span class='icon'></span>
        </a></li>
      </ul>
      <div class='templateRow row clearfix'>
      </div>
    </div>

    <div id='pageRenderType' class='pageRenderType navRenderType fullHeight
      <%= @row.nil? ? 'hide' : '' %>'>
      <div class='content'>
        <%- if !@row.nil? -%>
        <div class='pageColumn'>
          <%- @view.visible_columns.each do |c| -%>
          <div class='pageLine <%= c.renderTypeName %>'>
            <span class='pageLabel'><%= c.name %></span>

            <div class='pageItem'>
              <%- cell = @row[c.id] -%>
              <%- if c.renderTypeName == 'nested_table' -%>
              <table>
                <thead>
                  <tr>
                    <%- c.viewable_children.each do |cc| -%>
                    <th><%= cc.name %></th>
                    <%- end -%>
                  </tr>
                </thead>
                <tbody>
                  <%- (cell || []).each do |cr| -%>
                  <tr>
                    <%- c.viewable_children.each do |cc| -%>
                    <td><%= seo_render(cr[cc.id], cc) %></td>
                    <%- end -%>
                  </tr>
                  <%- end -%>
                </tbody>
              </table>
              <%- else -%>
              <%= seo_render(cell, c) %>
              <%- end -%>
            </div>
          </div>
          <%- end -%>
        </div>
        <%- end -%>
      </div>
      <ul class='navigation'>
        <%- if @view.has_rights?('update_view') -%>
        <li class='edit'><a class='button'
          href='<%= @view.href %>/edit_rr'>Edit Layout</a></li>
        <%- end -%>
        <li><a href='#start' title='View first row' class='start button'>
          <span class='icon'></span>
        </a></li>
        <li><a href='#previous' title='View previous row' class='previous button'>
          <span class='icon'></span>
        </a></li>
        <li class='info'>
        Viewing row <span class='curPage'></span> of <span
          class='totalPages'></span>
        </li>
        <li><a href='#next' title='View next row' class='next button'>
          <span class='icon'></span>
        </a></li>
        <li><a href='#end' title='View last row' class='end button'>
          <span class='icon'></span>
        </a></li>
      </ul>
    </div>
    <%- end -%>
  </div>

  <div id='gridSidebar'>
    <a class='close' href='#close'><span class='icon'>Close</span></a>
  </div>
</div>

<% content_for :templates do %>
<%= render(:partial => 'shared/grid_sidebar_templates') %>
<%= render(:partial => 'show_hide_template') %>
<div class="embedForm">
  <%= render :partial => 'embed_form', :locals => { :view => @view, :cur => 'root',
             :customization_id => (CurrentDomain.user_can?(current_user, :edit_sdp) ? nil : CurrentDomain.default_widget_customization_id) } %>
</div>
<div class="printForm">
  <%= render :partial => 'print_form', :locals => { :view => @view } %>
</div>
<%= render :partial => 'downloads_table_template' %>
<%= render :partial => 'feed_template' %>
<%= render :partial => 'flag_message' %>
<%= render :partial => 'sharing' %>
<%= render :partial => 'api_access' %>
<%= render :partial => 'signed_dataset' %>
<%= render :partial => 'subscribe' %>
<div class='fatRowColumn'>
  <div class='column'>
    <div class='info'>
      <span class='dataTypeIcon'></span>
      <span class='name'></span>
    </div>
    <a href='#Sort' class='sort'><span class='icon'></span></a>
    <a href='#Clear-Sort' title='Clear sort' class='clearSort close'>
      <span class='icon'></span>
    </a>
  </div>
</div>
<% end %>

<%- content_for :modals do -%>
  <div class="emailDatasetDialog modalDialog<%= ' ownerDialog' if
    @view.has_rights?('grant') %>">
    <a href="#close" class="jqmClose modalDialogClose">Close</a>
    <h2><span class='emailDatasetHint'>Email</span> this
      <span class="datasetTypeNameUpcase">Dataset</span></h2>
    <div class="emailSuccess">
      <div class="flash notice">
        Your email has been successfully sent.
      </div>
      <ul class="actions clearfix">
        <li>
          <a href="#cancel" class="jqmClose button">Close</a>
        </li>
        <li>
      </ul>
    </div>
    <div class="emailDatasetContent">
      <div class="flash" id="emailDatasetMessage"></div>
      <p>Share this <span class="datasetTypeName">dataset</span> with the following email addresses</p>
      <div class="emailFormContent">
        <form class='commonForm' id='emailDatasetForm'
          action='/views/<%= @view.id %>.json?method=sendAsEmail' method='post'>
          <div class="emailLine">
            <a href="#remove" title="Remove" class="removeLink delete hiddenLink">
              <span class="icon"></span>
            </a>
            <input type="hidden" class="recipientUid" />
            <div class="textWrapper">
              <input type="text" class="emailRecipient email"
                name="emailRecipient0" />
            </div>
            <%- if @view.has_rights?('grant') -%>
              <%= select_tag 'role', options_for_select(Share.types),
                    :class => 'recipientRole', :id => nil %>
            <%- end -%>
          </div>
          <div class="addMoreLine">
            <a class="button addMoreRecipientsButton add" href="#add">
              <span class="icon"></span>Add More
            </a>
          </div>
          <p class="emailMessageHint">Enter an optional message</p>
          <textarea id="emailMessage"></textarea>
        </form>
      </div>
      <ul class="actions clearfix">
        <li>
          <a href="#cancel" class="jqmClose button cancel">
            <span class="icon"></span>Cancel
          </a>
        </li>
        <li>
          <a href="#email" class="button" id="emailSubmitButton">
            <span class="icon"></span><span class='emailDatasetHint'>Email</span>
          </a>
        </li>
      </ul>
    </div>
  </div>

  <%= render :partial => 'save_view_dialog' %>

  <%- unless current_user -%>
    <div id="login" class="modalDialog">
      <a href="#close" class="jqmClose modalDialogClose">Close</a>
      <h2>Sign in using your Socrata ID</h2>

      <%= display_standard_flashes %>

      <% form_for @user_session, :html => { :class => "commonForm" } do |f| %>
        <%= render :partial => "user_sessions/login_form_data_new", :locals => { :f => f } %>
      <% end %>

      <ul class="accountMaint">
        <li><%= link_to "Forgot your password?", forgot_password_path, :class => 'noRedirPrompt' %></li>
        <li><%= link_to "No account yet?", signup_url, { :class => "signupLink noRedirPrompt" } %></li>
      </ul>

      <script type="text/javascript">
        blist.secureUrl = "https://<%= request.host %>:<%= SslRequirement.port_for_protocol('https') %>";
      </script>
    </div>

    <div id="signup" class="modalDialog">
      <a href="#close" class="jqmClose modalDialogClose">Close</a>
      <h2>We're glad you want to join Socrata!</h2>

      <% form_for :signup, @signup, :url => account_path, :html => {:id => 'signupForm',
                  :class => 'commonForm', :multipart => true} do |f| %>
       <%= render :partial => "accounts/signup_form_data_new", :locals => { :f => f, :is_modal => true } %>
      <% end %>
    </div>
  <%- end -%>
<%- end -%>

<% content_for :js_footer do %>
  <script type="text/javascript">
    <%= raw @view.display.render_inline_setup_js('mainGrid', self) %>

    <%- if !current_user.nil? -%>
      blist.currentUserId = '<%= current_user.id %>';
    <%- end -%>

    <%- if !@row.nil? -%>
    blist.initialRowId = "<%= @row['sid'] %>";
    <%- end -%>

    <%# Namespace to keep track of disabled sidebar sections %>
    blist.namespace.fetch('blist.sidebarHidden');

    <%# Saved views %>
    blist.sidebarHidden.savedViews = <%= !@view.is_tabular? %>;

    <%# Edit pane %>
    blist.sidebarHidden.edit = blist.sidebarHidden.edit || {};
    blist.sidebarHidden.edit.append = <%= !@view.is_blist? ||
      !@view.has_rights?('add') ||
      !CurrentDomain.module_available?(:dataset_append) %>;
    blist.sidebarHidden.edit.replace = <%= !@view.is_blist? ||
      !@view.has_rights?('add') ||
      !@view.has_rights?('delete') ||
      !CurrentDomain.module_available?(:dataset_refresh) %>;
    blist.sidebarHidden.edit.addColumn = <%= !@view.is_blist? ||
      !@view.has_rights?('add_column') %>;

    <%# Columm properties %>
    blist.sidebarHidden.columnProperties = <%= @view.is_alt_view? %>;

    <%# Filter pane %>
    blist.sidebarHidden.filter = blist.sidebarHidden.filter || {};
    blist.sidebarHidden.filter.filterDataset = <%= !@view.is_tabular? ||
      @view.is_form? %>;
    blist.sidebarHidden.filter.showHide = <%= @view.is_alt_view? ||
      !@view.has_rights?('update_view') %>;

    <%# Visualize pane %>
    blist.sidebarHidden.visualize = blist.sidebarHidden.visualize || {};
    blist.sidebarHidden.visualize.calendarCreate = <%= @view.is_alt_view? &&
      (@view.display.type != 'calendar' || !@view.has_rights?('update_view')) %>;
    blist.sidebarHidden.visualize.chartCreate = <%= @view.is_alt_view? &&
      (@view.display.type != 'visualization' ||
       !@view.has_rights?('update_view')) %>;
    blist.sidebarHidden.visualize.mapCreate = <%= @view.is_alt_view? &&
      (@view.display.type != 'map' || !@view.has_rights?('update_view')) ||
      @view.is_grouped? ||
      !module_available?(:map_publish) %>;

    <%# Embed pane %>
    blist.sidebarHidden.embed = blist.sidebarHidden.embed || {};
    blist.sidebarHidden.embed.formCreate = <%= (@view.is_alt_view? &&
      !@view.is_form?) ||
      @view.is_grouped? ||
      !CurrentDomain.user_can?(current_user, :create_datasets) ||
      !module_available?(:form_publish) ||
      !@view.owned_by?(current_user) ||
      !@view.parent_dataset.owned_by?(current_user) %>;

    <%# Export pane %>
    blist.sidebarHidden.exportSection = blist.sidebarHidden.exportSection || {};
    blist.sidebarHidden.exportSection.signedDataset = <%=
      !@view.owned_by?(current_user) || !module_available?(:digital_signatures) %>;
    blist.sidebarHidden.exportSection.print = <%= @view.is_alt_view? %>;
    blist.sidebarHidden.exportSection.download = <%= !@view.is_tabular? %>;
    blist.sidebarHidden.exportSection.api = <%= !@view.is_tabular? %>;

    <%# Sharing pane %>
    blist.sidebarHidden.sharing = <%= !@view.user_granted?(current_user) &&
      !CurrentDomain.user_can?(current_user, :edit_others_datasets) %>;

    <%# Please see admin_controller#add_custom_layer for explanation %>
    <%# custom_layer_config = Configuration.find_by_type('custom_layers', true).first
        custom_layers = {}
        ['esri'].each do |map_type|
          custom_layers[map_type] = custom_layer_config.data['properties'].detect { |property|
            property['name'] == map_type
          }['value']
        end if custom_layer_config
    -%>
    <%#blist.custom_layers = JSON.parse($.htmlUnescape("<%= h custom_layers.to_json.gsub(/\\/, '\\\\\\') % >")); -%>
  </script>

  <%- if @view.is_tabular? -%>
  <%= raw @view.display.render_edit_javascript_includes(self) %>
  <%- end -%>
  <%= raw @view.display.render_javascript_includes(self) %>

  <%= include_javascripts 'dataset-show' %>
<% end %>

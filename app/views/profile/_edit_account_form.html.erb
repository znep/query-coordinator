<div class="editAccountInfoForm editForm">
  <h1><%= t('screens.profile.edit.account.title') %></h1>

  <%= display_standard_flashes %>
  <%- openid_identifiers = current_user.openid_identifiers -%>
  <%= form_tag(update_account_profile_url, :method => 'put',
       :class => 'commonForm' + (openid_identifiers.empty? ? '' : ' hasOpenId'),
       :id => 'editAccountForm') do %>
    <div class="editArea">
      <%- unless current_user.flag?('nopassword') -%>
        <div class="editSection clearfix">
          <div class="line clearfix">
            <label><%= t('screens.profile.edit.account.current_email') %></label>
            <span class="field textItem"><%= current_user.email %></span>
          </div>
          <div class="line clearfix">
            <label for="user_email"><%= t('screens.profile.edit.account.new_email') %></label>
            <%= text_field_tag('user[email]', '', :class => 'textPrompt email') %>
          </div>
          <div class="line clearfix">
            <label for="user_email_confirm"><%= t('screens.profile.edit.account.confirm_email') %></label>
            <%= text_field_tag('user[email_confirm]', '', :class => 'textPrompt email') %>
          </div>
          <div class="line clearfix">
            <label for="user_email_password"><%= t('screens.profile.edit.account.password') %></label>
            <%= password_field_tag('user[email_password]', '') %>
            <span class="fieldHint textItem">
              <%= t('screens.profile.edit.account.password_prompt') %>
            </span>
          </div>
        </div>
      <%- end -%>

      <div class="editSection clearfix">
        <div class="line clearfix<%= ' noPassword hide' if current_user.flag?('nopassword') %>">
          <label for="user_password_old"><%= t('screens.profile.edit.account.old_password') %></label>
          <%= password_field_tag('user[password_old]', '', :class => 'currentPassword') %>
        </div>
        <div class="line clearfix">
          <label for="user_password_new"><%= t('screens.profile.edit.account.new_password') %></label>
          <%= password_field_tag('user[password_new]', '', :class => 'newPassword') %>
          <span class="fieldHint textItem passwordHint about">
            <%= t('screens.profile.edit.account.password_restrictions_html') %>
          </span>
        </div>
        <div class="line clearfix">
          <label for="user_password_confirm"><%= t('screens.profile.edit.account.confirm_password') %></label>
          <%= password_field_tag('user[password_confirm]', '', :class => 'confirmPassword') %>
        </div>
      </div>

      <%- openid_login = CurrentDomain.module_enabled?(:openid_login) -%>
      <%- if openid_login -%>
      <div class="editSection clearfix">
        <div class="line clearfix">
          <label>&nbsp;</label>
          <span class="field textItem">
            <%= t('screens.profile.edit.account.connect_openid') %>
            <%= link_to t('screens.profile.edit.account.learn_openid'), openid_explained_url(profile_account_url) %>
          </span>
        </div>

        <%- if openid_identifiers.empty? -%>
        <div class="line clearfix">
          <label>&nbsp;</label>
          <span class="field emptyItem"><%= t('screens.profile.edit.account.no_openid') %></span>
        </div>
        <%- else -%>
          <%- openid_identifiers.each do |ident| -%>
            <div class="line clearfix">
              <label>Delete</label>
              <span class="field textItem">
                <%= check_box_tag "openid_delete[#{ident.id}]" %>
                <%= hidden_field_tag "openid_delete_paths[#{ident.id}]", ident.delete_path %>
                <%= link_to ident.identifier %>
              </span>
            </div>
          <%- end -%>
        <%- end -%>
        <div class="line clearfix fullLine">
          <label>&nbsp;</label>
          <%= link_to_rpx raw('<span class="icon"></span>' + t('screens.profile.edit.account.add_openid_button')),
                add_rpx_token_url(:section => 'openid'), :class => 'rpxnow button add addOpenIdButton' %>
        </div>
      </div>
      <%- end -%>

      <div class="editSection clearfix">
        <div class="line clearfix">
          <label><%= t('screens.profile.edit.account.email.title') %></label>
          <span class="textItem">
            <%= t('screens.profile.edit.account.email.subtitle') %>
          </span>
        </div>
        <%- EmailInterest.specification.sort {|a, b| a.last[:description] <=> b.last[:description]}.each do |interest| -%>
          <%- next if interest.last[:right] && !current_user.has_right?(interest.last[:right]) -%>
          <div class="line emailInterestLine clearfix">
            <label>&nbsp;</label>
            <%= check_box_tag("email_interests[#{interest.first}]", true, @email_interests.any? { |i| i.eventTag == interest.first }) %>
            <label class="description" for="email_interests_<%= interest.first %>"><%= t('screens.profile.edit.account.email.interests.' + interest.last[:description]) %></label>
          </div>
        <%- end -%>
        <div class="line emailSubscribeLine clearfix">
          <label><%= t('screens.profile.edit.account.email.interests.other') %></label>
          <%= check_box_tag('user[email_subscribe]', true, !current_user.emailUnsubscribed) %>
          <label for="user_email_subscribe" class="description">
            <%= t('screens.profile.edit.account.email.interests.user_affected') %>
          </label>
          <p><%= t('screens.profile.edit.account.email.policy', site: CurrentDomain.strings.company) %></p>
        </div>
      </div>
    </div>

    <div class="submitLine">
      <%= submit_tag t('core.dialogs.save'), :class => 'button default' %>
      <%= link_to t('core.dialogs.cancel'), profile_path(current_user), :class => 'button' %>
    </div>
  <% end %>
</div>

<% content_for :js_footer do %>
  <script src="https://rpxnow.com/openid/v2/widget" type="text/javascript"></script>
  <script type="text/javascript">
    RPXNOW.overlay = true;
    RPXNOW.language_preference = 'en';
    RPXNOW.flags='show_provider_list';
  </script>
<% end %>

<%- activity_feed_prefix = 'screens.admin.jobs' %>
<% content_for :head do %>
  <%= rendered_stylesheet_tag 'administration-screen' %>
  <%= rendered_stylesheet_tag 'administration-activity-feed' %>
  <title><%= t("#{activity_feed_prefix}.show_page.title") %> | <%= CurrentDomain.strings.site_title %></title>
<% end %>

<% content_for :skip_links do %>
  <%= link_to(t('core.no_js'), '?no_js=true') %>
<% end %>

<%= include_webpack_bundle 'admin/admin-activity-feed-show.js' %>

<%= render :partial => 'left_nav' %>
<div class="contentBox withLeftNavigation showJobScreen">
  <div class="adminHeader floating jobs">
    <span class="icon"></span>
    <span class="back-to-jobs-list">
      <%= link_to(t("#{activity_feed_prefix}.show_page.back"), {:action => 'jobs'}) %>
    </span>
    <h1><%= t("#{activity_feed_prefix}.show_page.page_title") %></h1>
  </div>
</div>

<div class="contentBox withLeftNavigation showJobScreen mainContent">
  <%= display_standard_flashes %>

  <div style="position: relative;">
    <div>
      <h1><%= t("#{activity_feed_prefix}.actions.#{@activity.activity_type}") %></h1>
      <p class="file-name">
        <% if @activity.dataset.nil? %>
          <%= t("#{activity_feed_prefix}.index_page.deleted_dataset") %>
        <% else %>
          <%= link_to(@activity.dataset.name, view_path(@activity.dataset)) %>
        <% end %>
        <% if @activity.file_name.blank? %>
          <%= t("(#{activity_feed_prefix}.show_page.file_name_unknown)") %>
        <% else %>
          <%= "(#{@activity.file_name})" %>
        <% end %>
        <% if @activity.had_working_copy? %>
          <% working_copy = @activity.working_copy %>
          <p class="working-copy-annotation">
            to working copy
          <% if working_copy && working_copy.is_unpublished? %>
            <%= link_to(@activity.working_copy_id, view_path(working_copy)) %>
          <% else %>
            <%= @activity.working_copy_display %>
          <% end %>
          </p>
        <% end %>
      </p>
    </div>
    <div style="position: absolute; right: 0; top: 2px;">
      <p class="import-status-label">
        <span class="import-status-icon import-status-icon-<%= @activity.status.dasherize %> icon-<%= icon_for_status(@activity.status) %>"></span>
        <%= t("#{activity_feed_prefix}.statuses.#{@activity.status}") %>
      </p>
      <p class="result-time-stamp time-stamp" data-epoch-seconds="<%= @activity.created_at.to_i %>">
        <span><%= @activity.last_updated.strftime('%d %b %Y at %H:%M:%S %Z') %></span>
        (<%= HumaneDateHelper.humane_date(@activity.last_updated) %>)
      </p>
    </div>
  </div>

  <section class="import-job-container">
    <div class="import-job-events">
      <% failure_events = @activity.events %>
      <% if failure_events.empty? %>
        <p><%= t("#{activity_feed_prefix}.show_page.no_events") %></p>
      <% else %>
        <% last_event = failure_events.last %>
        <div class="import-job-event">
          <h2><%= event_title(last_event) %></h2>
          <p class="event-time-stamp time-stamp" data-epoch-seconds="<%= @activity.created_at.to_i %>">
            <span><%= last_event.event_time.strftime('%d %b %Y at %H:%M:%S %Z') %></span>
            (<%= HumaneDateHelper.humane_date(last_event.event_time) %>)
          </p>
          <div class="event-description-container">
            <% description = event_description(last_event) %>
            <% unless description.blank? %>
              <p class="event-description event-description-human-readable">
                <%= html_safe(description) %>
              </p>
            <% else %>
              <p class="error-details-heading">
                <%= t("#{activity_feed_prefix}.show_page.error_details_heading") %>:
              </p>
              <pre class="event-description event-description-json"><%= JSON.pretty_generate(last_event.info) %></pre>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <div class="import-job-details">
      <h3><%= t("#{activity_feed_prefix}.show_page.started_by") %></h3>
      <p>
        <% if @activity.initiated_by.nil? %>
          <%= "(#{t("#{activity_feed_prefix}.index_page.deleted_user")})" %>
        <% else %>
          <%= link_to(@activity.initiated_by.displayName, profile_path(@activity.initiated_by))%>
        <% end %>
      </p>
      <h3><%= t("#{activity_feed_prefix}.show_page.initiated_at") %></h3>
      <p class="started-time-stamp time-stamp" data-epoch-seconds="<%= @activity.created_at.to_i %>">
        <span><%= @activity.created_at.strftime('%d %b %Y at %H:%M:%S %Z') %></span>
      </p>
      <h3><%= t("#{activity_feed_prefix}.show_page.import_method") %></h3>
      <p><%= html_safe(t("#{activity_feed_prefix}.show_page.services.#{@activity.service}")) %></p>
      <% unless @activity.bad_rows_url.blank? %>
        <h3>
          <%= t("#{activity_feed_prefix}.show_page.failed_rows") %>
          <span class="icon-warning"></span>
        </h3>
        <p><%= link_to('errors.csv', @activity.bad_rows_url) %></p>
      <% end %>
    </div>
  </section>
</div>

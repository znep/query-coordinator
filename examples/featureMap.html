<!DOCTYPE html>
<html>
  <head>
    <title>Example Usage: socrata.visualizations.FeatureMap.js</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF8">
    <!-- `leaflet.css` must be included or the map will render incorrectly -->
    <link rel="stylesheet" media="all" href="../bower_components/leaflet/dist/leaflet.css">
    <link rel="stylesheet" media="all" href="../socrata.visualizations.featureMap.css">
    <link rel="stylesheet" media="all" href="../socrata.visualizations.rowInspector.css">
    <style type="text/css">

      body {
        font-size: 10px;
        font-family: sans-serif;
      }

      #feature-map-1 {
        display: block;
        position: relative;
        width: 640px;
        height: 480px;
        margin: 50px auto 0 auto;
        border: 1px solid #aaa;
      }

      #feature-map-2 {
        display: block;
        position: relative;
        width: 640px;
        height: 480px;
        margin: 50px auto 0 auto;
        border: 1px solid #aaa;
      }

    </style>
  </head>
  <body>
    <div>IF THE  ROW INSPECTOR TEMPLATE CHANGED, FOR ALL THAT IS RIGHT, PLEASE CHANGE THIS, TOO. I'M NOT KIDDING</div>
    <div>ALSO, if the styles have changed, please run "npm run-script compile-css"</div>
    <div id="socrata-row-inspector">
      <div class="tool-panel">
        <div class="tool-panel-main">

          <div class="icon-close"></div>
          <div class="sticky-border"></div>
          <div class="tool-panel-inner-container">
            <!-- Successful query response -->
            <div class="row-inspector-content">
              <div class="row-data-item">
                <span class="name"></span>
                <span class="value"></span>
              </div>
            </div>
            <!-- Loading spinner while query pending-->
            <div class="pending-content"></div>
            <!-- Error message if row query unsuccessful -->
            <div class="error-content">
              <div class="icon-warning"></div>
              <div class="error-message"></div>
            </div>
          </div>
          <div class="sticky-border bottom"></div>
          <div class="paging-panel">
            <button type="button" title="" class="l-to-r pagination-btn action-btn previous">
              <span class="caret"></span>
            </button>
            <button type="button" title="" class="r-to-l pagination-btn action-btn next">
              <span class="caret"></span>
            </button>
            <div class="paging-info">
              <div class="message">
                <div></div>
                <div></div>
              </div>
            </div>
          </div>
          <div class="tool-panel-hint"></div>
        </div>
      </div>
    </div>

    <div id="feature-map-1"></div>
    <div id="feature-map-2"></div>
  </body>
  <!-- lodash must be loaded before `socrata.utils.js` -->
  <script type="text/javascript" src="../bower_components/lodash/lodash.js"></script>
  <script type="text/javascript" src="../bower_components/socrata-utils/socrata.utils.js"></script>
  <!-- jquery must be loaded before `socrata.visualizations.Visualization.js` -->
  <script type="text/javascript" src="../bower_components/jquery/dist/jquery.js"></script>
  <!-- `socrata.visualizations.Visualization.js` must be loaded before `socrata.visualizations.FeatureMap.js` -->
  <script type="text/javascript" src="../socrata.visualizations.Visualization.js"></script>
  <!-- leaflet must be loaded before `socrata.visualizations.FeatureMap.js` -->
  <script type="text/javascript" src="../bower_components/leaflet/dist/leaflet.js"></script>
  <!-- `socrata.visualizations.pbf.js` must be loaded before `socrata.visualizations.FeatureMap.js` -->
  <script type="text/javascript" src="../socrata.visualizations.pbf.js"></script>
  <!-- vector-tile-js must be loaded before `socrata.visualizations.FeatureMap.js` -->
  <script type="text/javascript" src="../bower_components/vector-tile/dist/vectortile.js"></script>
  <!-- d3 must be loaded before `socrata.visualizations.FeatureMap.js` -->
  <script type="text/javascript" src="../bower_components/d3/d3.js"></script>
  <!-- `socrata.visualizations.VectorTileManager.js` must be loaded before `socrata.visualizations.FeatureMap.js` -->
  <script type="text/javascript" src="../socrata.visualizations.VectorTileManager.js"></script>
  <script type="text/javascript" src="../socrata.visualizations.FeatureMap.js"></script>
  <script type="text/javascript" src="../socrata.visualizations.rowInspector.js"></script>
  <!-- `socrata.visualizations.DataProvider.js` must be loaded before `socrata.visualizations.TileserverDataProvider.js` -->
  <script type="text/javascript" src="../socrata.visualizations.DataProvider.js"></script>
  <script type="text/javascript" src="../socrata.visualizations.GeospaceDataProvider.js"></script>
  <script type="text/javascript" src="../socrata.visualizations.TileserverDataProvider.js"></script>
  <script type="text/javascript" src="../socrata.visualizations.SoqlDataProvider.js"></script>
  <script type="text/javascript" src="../socrata.visualizations.MetadataProvider.js"></script>
  <script type="text/javascript" src="../components/SocrataFeatureMap.js"></script>
  <script type="text/javascript">

    /**
     * Set up the plugin.
     */

    var APP_TOKEN = 'zvQamMSTi4GNuZWWDwjLdLPhW';
    var DOMAIN = 'dataspace.demo.socrata.com';
    var FOUR_BY_FOUR = 'r6t9-rak2';
    var FIELD_NAME = 'point';

    var TEST_DATASET_METADATA = {"name":"Case Data from San Francisco 311","updatedAt":"2014-08-22T22:36:10.000Z","defaultPage":"cs5s-apnb","description":"Cases created since 7/1/2008 with location information","domain":"dataspace.demo.socrata.com","rowDisplayUnit":"Case","locale":"en_US","id":"r6t9-rak2","columns":{"request_details":{"name":"request details","fred":"text","description":"Cases created since 7/1/2008 with location information","physicalDatatype":"text","position":9,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},":version":{"description":"","fred":"text","name":":version","physicalDatatype":"row_version"},"point":{"name":"point","fred":"location","description":"Cases created since 7/1/2008 with location information","physicalDatatype":"point","position":13,"hideInTable":false,"format":{},"dataTypeName":"point","renderTypeName":"point","defaultCardType":"feature","availableCardTypes":["feature"]},"source":{"name":"source","fred":"category","description":"Which medium was used to file the ticket","physicalDatatype":"text","position":14,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},":Computed_qgg2gdwk_point":{"name":"Police Districts","fred":"location","description":"","computationStrategy":{"source_columns":["point"],"parameters":{"region":"_qgg2-gdwk"},"strategy_type":"georegion_match_on_point"},"physicalDatatype":"text","position":17,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text"},":created_at":{"description":"","fred":"text","name":":created_at","physicalDatatype":"fixed_timestamp"},"closed":{"name":"closed","fred":"time","description":"Date case was closed","physicalDatatype":"floating_timestamp","position":3,"hideInTable":false,"format":{},"dataTypeName":"calendar_date","renderTypeName":"calendar_date","defaultCardType":"timeline","availableCardTypes":["timeline"]},"neighborhood":{"name":"neighborhood","fred":"category","description":"Cases created since 7/1/2008 with location information","physicalDatatype":"text","position":12,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},"media_url":{"name":"media url","fred":"text","description":"Cases created since 7/1/2008 with location information","physicalDatatype":"text","position":15,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},"request_type":{"name":"request type","fred":"category","description":"","physicalDatatype":"text","position":8,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},":Computed_n8rpcfd9_point":{"name":"Neighborhoods","fred":"location","description":"","computationStrategy":{"source_columns":["point"],"parameters":{"region":"_n8rp-cfd9"},"strategy_type":"georegion_match_on_point"},"physicalDatatype":"text","position":18,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text"},"opened":{"name":"opened","fred":"time","description":"Date case was filed","physicalDatatype":"floating_timestamp","position":2,"hideInTable":false,"format":{},"dataTypeName":"calendar_date","renderTypeName":"calendar_date","defaultCardType":"timeline","availableCardTypes":["timeline"]},"updated":{"name":"updated","fred":"time","description":"Time the case was updated","physicalDatatype":"floating_timestamp","position":4,"hideInTable":false,"format":{},"dataTypeName":"calendar_date","renderTypeName":"calendar_date","defaultCardType":"timeline","availableCardTypes":["timeline"]},"responsible_agency":{"name":"responsible agency","fred":"category","description":"Agency responsible for handling and managing the case","physicalDatatype":"text","position":6,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},":Computed_a9zvgp2q_point":{"name":"Zip codes","fred":"location","description":"","computationStrategy":{"source_columns":["point"],"parameters":{"region":"_a9zv-gp2q"},"strategy_type":"georegion_match_on_point"},"physicalDatatype":"text","position":19,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text"},"status":{"name":"status","fred":"category","description":"Cases created since 7/1/2008 with location information","physicalDatatype":"text","position":5,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},":Computed_ernjgade_point":{"name":"Supervisor Districts","fred":"location","description":"","computationStrategy":{"source_columns":["point"],"parameters":{"region":"_ernj-gade"},"strategy_type":"georegion_match_on_point"},"physicalDatatype":"text","position":16,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text"},"address":{"name":"address","fred":"text","description":"Cases created since 7/1/2008 with location information","physicalDatatype":"text","position":10,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},"category":{"name":"category","fred":"category","description":"","physicalDatatype":"text","position":7,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},":updated_at":{"description":"","fred":"text","name":":updated_at","physicalDatatype":"fixed_timestamp"},":id":{"description":"","fred":"text","name":":id","physicalDatatype":"row_identifier"},"case_id":{"name":"caseid","fred":"identifier","description":"Unique identifier per 311 case","physicalDatatype":"number","position":1,"hideInTable":false,"format":{},"dataTypeName":"number","renderTypeName":"number","defaultCardType":"histogram","availableCardTypes":["histogram","column","search"]},"supervisor_district":{"name":"supervisor district","fred":"category","description":"Cases created since 7/1/2008 with location information","physicalDatatype":"number","position":11,"hideInTable":false,"format":{},"dataTypeName":"number","renderTypeName":"number","defaultCardType":"histogram","availableCardTypes":["histogram","column","search"]},"*":{"availableCardTypes":["table"],"defaultCardType":"table","name":"Data Table","description":"","fred":"*","physicalDatatype":"*"}},"ownerId":"8ibz-n25n","permissions":{"isPublic":true,"rights":["read"]},"pages":{"publisher":[{"name":"San Francisco 311","largestTimeSpanDays":2199,"description":"SF311 cases created since 7/1/2008 with location information.  You can find the type of request, as well as volume of requests and the request status.","primaryAmountField":null,"cards":[{"activeFilters":[],"cardSize":1,"cardType":"timeline","expanded":false,"fieldName":"opened"},{"activeFilters":[],"cardSize":1,"cardType":"column","expanded":false,"fieldName":"category"},{"activeFilters":[],"cardSize":1,"cardType":"column","expanded":false,"fieldName":"request_type"},{"activeFilters":[],"cardSize":2,"cardType":"timeline","expanded":false,"fieldName":"closed"},{"activeFilters":[],"cardSize":2,"cardType":"timeline","expanded":false,"fieldName":"updated"},{"activeFilters":[],"cardSize":2,"cardType":"feature","expanded":false,"fieldName":"point"},{"activeFilters":[],"cardSize":2,"cardType":"column","expanded":false,"fieldName":"source"},{"activeFilters":[],"cardSize":2,"cardType":"table","expanded":false,"fieldName":"*"}],"datasetId":"r6t9-rak2","pageId":"cs5s-apnb","version":1,"primaryAggregation":null,"defaultDateTruncFunction":"date_trunc_ym"}],"user":[]}}

    var featureMapConfig = {
      // Data
      appToken: APP_TOKEN,
      domain: DOMAIN,
      fourByFour: FOUR_BY_FOUR,
      fieldName: FIELD_NAME,
      // If the value of `datasetMetadata` is falsey then the feature map
      // plugin will make its own request for dataset metadata.
      // If it is truthy then this value will be used instead of making a new
      // request.
      datasetMetadata: false,
      // Behavior
      hover: true,
      panAndZoom: true,
      locateUser: true,
      // The localization values should be set by the application but are set to string literals
      // for the purposes of this example.
      localization: {
        'FLYOUT_FILTER_NOTICE': 'There are too many points at this location',
        'FLYOUT_FILTER_OR_ZOOM_NOTICE': 'Zoom in to see details',
        'FLYOUT_DENSE_DATA_NOTICE': 'Numerous',
        'FLYOUT_CLICK_TO_INSPECT_NOTICE': 'Click to see details',
        'FLYOUT_CLICK_TO_LOCATE_USER_TITLE': 'Click to show your position on the map',
        'FLYOUT_CLICK_TO_LOCATE_USER_NOTICE': 'You may have to give your browser permission to share your current location',
        'FLYOUT_LOCATING_USER_TITLE': 'Your position is being determined',
        'FLYOUT_LOCATE_USER_ERROR_TITLE': 'There was an error determining your location',
        'FLYOUT_LOCATE_USER_ERROR_NOTICE': 'Click to try again',
        'ROW_INSPECTOR_ROW_DATA_QUERY_FAILED': 'Detailed information about these points cannot be loaded at this time',
        'USER_CURRENT_POSITION': 'Your current location (estimated)'
      },
      // Base layer
      baseLayer: 'https://a.tiles.mapbox.com/v3/socrata-apps.ibp0l899/{z}/{x}/{y}.png',
      baseLayerOpacity: 0.5,
      baseWhereClause: '',
      useOriginHost: false
    };

    var $featureMap1Element = $('#feature-map-1');
    $featureMap1Element.socrataFeatureMap(featureMapConfig);

    // Instantiate a second visualizaton with existing dataset metadata to test
    // row inspector events that have access to dataset metadata while we are
    // getting CORS into the frontend routes for metadata.
    var featureMap2Config = _.clone(featureMapConfig);
    featureMap2Config.datasetMetadata = TEST_DATASET_METADATA;
    var $featureMap2Element = $('#feature-map-2');
    $featureMap2Element.socrataFeatureMap(featureMap2Config);

    /** 
     * Handle flyout/row inspector events.
     */

    $featureMap1Element.on('SOCRATA_VISUALIZATION_FEATURE_MAP_FLYOUT', handleFlyout);
    $featureMap1Element.on('SOCRATA_VISUALIZATION_ROW_INSPECTOR_SHOW', handleRowInspectorShow);
    $featureMap1Element.on('SOCRATA_VISUALIZATION_ROW_INSPECTOR_UPDATE', handleRowInspectorUpdate);
    $featureMap1Element.on('SOCRATA_VISUALIZATION_ROW_INSPECTOR_HIDE', handleRowInspectorHide);

    $featureMap2Element.on('SOCRATA_VISUALIZATION_FEATURE_MAP_FLYOUT', handleFlyout);
    $featureMap2Element.on('SOCRATA_VISUALIZATION_ROW_INSPECTOR_SHOW', handleRowInspectorShow);
    $featureMap2Element.on('SOCRATA_VISUALIZATION_ROW_INSPECTOR_UPDATE', handleRowInspectorUpdate);
    $featureMap2Element.on('SOCRATA_VISUALIZATION_ROW_INSPECTOR_HIDE', handleRowInspectorHide);

    function handleFlyout(event) {

      var payload = event.originalEvent.detail.data;

      // Render/hide a flyout
      if (payload !== null) {

        console.log(
          'Showing flyout with data: {0}'.format(
            JSON.stringify(payload)
          )
        );

      } else {

        console.log('Hiding flyout.');
      }
    }

    function handleRowInspectorShow(event) {

      var payload = event.originalEvent.detail;

      // Show the row inspector
      if (payload !== null) {

        console.log(
          'Showing Row Inspector at: ({0}, {1}).'.format(
            payload.position.pageX,
            payload.position.pageY
          )
        );
      }
    }

    function handleRowInspectorUpdate(event) {

      var payload = event.originalEvent.detail.data;

      // Update the row inspector
      if (payload !== null) {

        console.log(
          'Updating Row Inspector with payload: {0}.'.format(
            JSON.stringify(payload)
          )
        );
      }
    }

    function handleRowInspectorHide(event) {

      console.log('Hiding Row Inspector.');
    }

    /**
     * Destroy the plugin.
     *
     * The plugin (and all internal modules) can be destroyed by calling
     * `.destroySocrataFeatureMap()` on the element.
     */

     // $featureMap1Element.off('SOCRATA_VISUALIZATION_ROW_INSPECTOR_SHOW', handleRowInspectorShow);
     // $featureMap1Element.off('SOCRATA_VISUALIZATION_ROW_INSPECTOR_UPDATE', handleRowInspectorUpdate);
     // $featureMap1Element.off('SOCRATA_VISUALIZATION_ROW_INSPECTOR_HIDE', handleRowInspectorHide);
     // $featureMap1Element.destroySocrataFeatureMap();

     // $featureMap2Element.off('SOCRATA_VISUALIZATION_ROW_INSPECTOR_SHOW', handleRowInspectorShow);
     // $featureMap2Element.off('SOCRATA_VISUALIZATION_ROW_INSPECTOR_UPDATE', handleRowInspectorUpdate);
     // $featureMap2Element.off('SOCRATA_VISUALIZATION_ROW_INSPECTOR_HIDE', handleRowInspectorHide);
     // $featureMap2Element.destroySocrataFeatureMap();

    $(document).ready(function() {
      window.socrata.visualizations.rowInspector.setup();
    });
  </script>
</html>

#!/bin/bash
set -ex

# Called by Jenkins to build and package frontend in preparation for a deploy
# Note that dependencies should be installed before running this script.
bundle config socrata.artifactoryonline.com $ARTIFACTORYONLINE_USER:$ARTIFACTORYONLINE_PASSWORD
bundle check || bundle install

# Write REVISION file
git rev-parse HEAD > "$WORKSPACE/REVISION"

# Package assets
npm run build:prod
bundle exec rake assets:precompile

# Run tests
bundle exec rake test

# Remove certain javascript files from public/javascripts (BUT WHY)
if [ ! $COMPRESS_ASSETS = "true" ] ; then
  bundle exec rake deploy:move_resources
fi

# Make the tartifact thing
tar cpzfX $SERVICE_ARTIFACT .package-ignore * .bundle .semver

# Get build info for Decima
echo "---" > build_info.yml
echo "service: ${SERVICE_NAME}" >> build_info.yml
echo "version: ${SERVICE_VERSION}" >> build_info.yml
echo "service_sha: ${SERVICE_SHA}" >> build_info.yml
echo "configuration: ${BUILD_URL}" >> build_info.yml

# Static analysis
if $RUN_STATIC_ANALYSIS; then
  # FIXME for some reason this works but the commented rake task below does not.
  ./node_modules/.bin/eslint --ignore-path .eslintignore -c package.json -f checkstyle public/javascripts/angular > eslint-results.xml || true
  # bundle exec rake "lint:js:dataCards[checkstyle]" > eslint-results.xml

  bundle exec rake "lint:ruby[xml]" > reek-results.xml
fi

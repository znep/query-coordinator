#!/usr/bin/env ruby
require 'pathname'
require 'yaml'

# path to your application root.
APP_ROOT = Pathname.new File.expand_path('../../',  __FILE__)

if system('../bin/should_run_tests storyteller') == nil
  raise 'Test check script failed to run, aborting.'
elsif $?.exitstatus == 1
  exit 1
end

Dir.chdir APP_ROOT do

  database_config = YAML.load_file('config/database.yml.test')

  temporary_test_db_name = "storyteller_test_#{Time.now.to_i}"
  database_config['test']['database'] = temporary_test_db_name

  File.open('config/database.yml', 'w') do |f|
    # only write the test config
    test_db_config = database_config.select {|k, _| k == 'test' }
    f.write(test_db_config.to_yaml)
  end

  puts "\n== Running tests with temporary db, #{temporary_test_db_name} =="
  begin
    system('bin/test') or abort('`test` script returned a non-zero status')
  ensure
    system('RAILS_ENV=test bundle exec rake db:drop')
  end
end

<div class="browse2-facets-pane <%= facets_pane_classes %>">
  <%= raw opts[:sidebar_config].header if opts[:sidebar_config] && opts[:sidebar_config].header %>

  <div class="browse2-facets-pane-mobile-header">
    <a class="browse2-facets-pane-mobile-back-button" href="#">
      <span class="browse2-mobile-filter-icon icon-arrow-left"></span>
      <%= t('controls.browse.browse2.facets.mobile.back') %>
    </a>
  </div>

  <div class="browse2-facets-pane-body">
    <div class="browse2-facets-pane-mobile-clear-all-div">
      <a class="browse2-facets-pane-mobile-clear-all-button" href="#">
        <%= t('controls.browse.browse2.facets.mobile.clear_all') %>
      </a>
    </div>

    <div class="browse2-facets-mobile-active-filters">
      <%-
      facets = opts[:facets].
        reject { |facet| facet[:options].blank? && facet[:custom_content].blank? }

      facets.each do |facet|
        active_option = opts[facet[:param]]
        active_filter = active_facet_option(active_option, facet)

        if active_filter.present? -%>
          <%= render(
            :partial => 'datasets/browse2_mobile_facet_active_filters',
            :locals => {
              :title => facet[:title],
              :facet_param => facet[:param],
              :facet_option => active_filter
            }
          ) %>
    <%-
        end
      end
      -%>
    </div>

    <div class="browse2-facets">
      <h2 class="browse2-mobile-facets-header">
        <%= t('controls.browse.browse2.facets.mobile.all_filters') %>
      </h2>
      <%-
      facets.each do |facet|
        # TODO - once browse1 is ðŸ”¥, we should refactor the :options vs :extra_options logic
        # to just have :options contain everything, and handle the trimming logic elsewhere.
        all_facet_options = get_all_facet_options(facet).
          sort_by { |option| [-option.fetch(:count, 0), option.fetch(:text)] }

        all_facet_options_flattened = flatten_facet_options(all_facet_options).
          sort_by { |option| [-option.fetch(:count, 0), option.fetch(:text)] }

        facet_section_has_modal = facet[:extra_options].present?
      -%>
      <%=
        render(
          :partial => 'datasets/browse2_facet_section',
          :locals => {
            :opts => opts,
            :facet_title => facet[:title],
            :facet_param => facet[:param],
            :facet_section_has_modal => facet_section_has_modal,
            :truncate_facet_section_at_index => facet[:options].length,
            :all_facet_options => all_facet_options
          }
        )
      %>
      <%- if facet_section_has_modal -%>
        <%=
          render(
            :partial => 'datasets/browse2_facet_modal',
            :locals => {
              :opts => opts,
              :facet_title => facet[:title],
              :facet_param => facet[:param],
              :truncate_facet_section_at_index => facet[:options].length,
              :all_facet_options => all_facet_options_flattened
            }
          )
        %>
      <%-
        end
      end
      -%>
    </div>

    <div class="browse2-mobile-facets-filter-button-spacing"></div>

    <div class="browse2-mobile-facets-filter-button-container">
      <div class="browse2-mobile-facets-filter-button">
        <%= t('controls.browse.browse2.facets.mobile.filter') %>
      </div>
    </div>
  </div>

  <div class="browse2-loading-spinner-container">
    <span class="browse2-loading-spinner"></span>
  </div>
</div>

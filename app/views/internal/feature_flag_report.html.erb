<% content_for :head do %>
<%= rendered_stylesheet_tag 'internal' %>
<title>Feature Flag Report <%= "for #{params[:for]}" if params[:for] %>
  | Internal Panel | <%= CurrentDomain.strings.site_title %></title>
<% end %>

<%= render :partial => 'left_nav' %>

<div class="contentBox withLeftNavigation featureFlagReport">
  <h1>Feature Flag Report for <%= select_tag('for', list_of_feature_flags_as_options) %></h1>
  <%- if defined? @default %>
    <p>Description: <%= @description %></p>
    <p>Default Value: <%= @default %></p>

    <div class="environmentFeatureFlag">
      <h2>Environment Value<%= ' (unset)' if @environment.nil? %></h2>
      <%= form_tag set_environment_feature_flag_path, method: :post do %>
        <%= feature_flag_input(params[:for],
                               Hashie::Mash.new(FeatureFlags.config_for(params[:for])),
                               @environment) %>
        <input type="submit" value="Update" />
        <input type="submit" name="reset_to_default[<%= params[:for] %>]" value="Unset" />
      <%- end %>
    </div>

    <div class="domainFeatureFlags">
      <h2>Domain Values</h2>
      <h3>Summary</h3>
      <%- @domains.group_by { |(cname, value)| value }.each do |value, domains| %>
        <div>
          <div class="label"><%= value %></div>
          <div class="value"><%= list_of_cnames_as_links(domains) %></div>
        </div>
      <%- end %>

      <h3>By Domain</h3>
      <%- @domains.sort.each do |cname, value| %>
        <div>
          <div class="label"><%= link_to(cname, show_domain_path(domain_id: cname)) %></div>
          <div class="value">
            <%= link_to('(modify)', feature_flags_config_path(domain_id: cname)) %>
            <%= value %>
          </div>
        </div>
      <%- end %>
    </div>
  <%- else %>
    <p>Select a feature flag from the options above.</p>
  <%- end %>
</div>

<% content_for :js_footer do %>
  <script type="text/javascript">
    $(function() {
      $('.featureFlagReport select').change(function() {
        var flag = $(this).val();

        if (!_.isUndefined(blist.feature_flags[flag])) {
          window.location.href = '/internal/feature_flag_report?for={0}'.format(flag);
        }
      });

      var $form = $('.environmentFeatureFlag form');
      $('input:text, select', $form).on('focus change', function() {
        $(this).siblings('input.other').click();
      });
      $form.submit(function(e) {
        var $this = $(this);
        var otherNotSelected = $this.find('.other').not(':checked').exists();
        var otherPresent = $this.find('.other').exists();
        if (otherNotSelected && otherPresent) {
          $this.find('input:text, select').prop('disabled', true);
        }
      });
    });
  </script>
<% end %>

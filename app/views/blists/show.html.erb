<% content_for :head do %>
  <%= stylesheet_link_tag 'table-core', 'table-blist-grid', "blist-grid-screen",
    :cache => "cache/blists_show_all" %>
  <title><%= t(:page_title) %></title>
<% end %>

<div id='overlay'></div>
<%- is_owner = current_user && @view && @view.owner.id == current_user.id -%>
<%- can_edit = @view && @view.can_edit() -%>

<div class="scrollContentColumn">
  <div id='lensContainer' class='mainContent tableView'>
    <ul class='tabList'>
      <li class='backLink'><a title='Back to <%= t :blists_name %>'
        href='<%= blists_url() %>'>Back to <%= t :blists_name %></a></li>
      <li class='main <%= @is_child_view ? 'even' : 'active' %>'>
        <div class='wrapper'>
          <a class='clipText'
            href='<%= !@parent_view.nil? ? @parent_view.href : '#' %>'
            title='<%= !@parent_view.nil? ? h(@parent_view.name) : '' %>'>
            <%= !@parent_view.nil? ? h(@parent_view.name) :
              'New ' + t(:blist_name) %>
          </a>
        </div>
      </li>
      <%- if can_edit -%>
      <li class='swfItem newViewLink'>
        <a href='#newView' title='New View'>New View</a>
      </li>
      <%- end -%>

      <li class='prevTabLink'><a href='#prev_tab' title='Previous View'>
        Previous View
      </a></li>
      <%- if @is_child_view -%>
      <li class='active filter'><div class='wrapper'>
        <a class='clipText' href='<%= @view.href %>'
          title='<%= h(@view.name) %>'><%= h(@view.name) %></a>
      </div></li>
      <%- end -%>
      <li class='nextTabLink'><a href='#next_tab' title='Next View'>
        Next View
      </a></li>
    </ul>

    <div class='outerContent'>
      <div class='content'>
        <div class='headerBar clearfix'>
          <%- if !@view.nil? -%>
          <ul>
            <%# Main menu %>
            <li><a href='#main_menu' id='mainMenuLink' class='dropdownLink'>
              <div class='outerWrapper'><div class='midWrapper'>
                  <span class='innerWrapper'>Menu</span></div></div></a>
            <%= render(:partial => "main_menu",
            :locals => {:is_owner => is_owner, :can_edit => can_edit}) %>
            </li>

            <%- if can_edit -%>
            <li class='readItem separator'><a href='#editGrid' id='editLink'>
              Edit
            </a></li>
            <%- end -%>

            <%- if can_edit -%>
            <%# Undo/redo %>
            <li class='swfItem separator'><a href='#Undo' id='undoLink'
              class='linkIcon flashAction' title='Undo'>Undo</a></li>
            <li class='swfItem'><a href='#Redo' id='redoLink'
              class='linkIcon flashAction' title='Redo'>Redo</a></li>
            <%- end -%>

            <%# Table view options %>
            <%- if is_owner -%>
            <li class='swfItem separator tableOption'>
              <a class='addColumnsLink linkIcon' href='#'>Add Column</a></li>
            <%- end -%>
            <%- if can_edit -%>
            <li class='swfItem separator tableOption'>
              <a href='#' id='filterLink' class='dropdownLink'>
                <div class='outerWrapper'><div class='midWrapper'>
                    <div class='innerWrapper'>
                      <span class='linkIcon'>Filter & View</span></div></div>
              </div></a>
              <%= menu_tag({'id' => 'filterViewMenu', 'items' => [
              {'section_title' => 'Build a new view of your data'},
              {'text' => 'Filter Out Rows...', 'class' => 'filter', 'href' => '#'},
              {'text' => 'Sort Columns...', 'class' => 'sort', 'href' => '#'},
              {'text' => 'Show or Hide Columns...', 'class' => 'showHide',
                'href' => '#'}]}) %>
            </li>
            <%- end -%>

            <%# Page view options %>
            <%- if is_owner -%>
            <li class='swfItem separator pageOption'>
              <a class='addColumnsLink linkIcon' href='#'>Add Field</a>
            </li>
            <%- end -%>
            <%- if can_edit -%>
            <li class='swfItem pageOption'><a id='newPageLink'
              class='linkIcon flashAction' href='#NewPage'>New Page</a></li>
            <li class='swfItem separator pageOption'><a id='defaultLayoutLink'
              class='linkIcon flashAction'
              href='#DefaultLayout'>Default Layout</a></li>
            <%- end -%>

            <%# Export/access options %>
            <li class='separator'>
              <a id='apiLink' class='linkIcon' href='#API'>API</a>
            </li>
            <li>
              <a id='rssLink' class='linkIcon' href='#RSS'>RSS</a>
            </li>

            <%# Display menu %>
            <%- if can_edit -%>
            <li class='swfItem separator'>
              <a href='#' id='displayLink' class='dropdownLink'>
                <div class='outerWrapper'><div class='midWrapper'>
                    <span class='innerWrapper'>Display As</span></div></div></a>
              <%= menu_tag({'id' => 'displayMenu', 'option_menu' => true,
              'items' => [
              {'text' => 'A table', 'class' => 'table checked', 'href' => '#'},
              {'text' => 'A page', 'class' => 'page', 'href' => '#'}]}) %>
            </li>
            <%- end -%>
            
            <li class='separator'>
              <ul class="socialActions clearfix">
                <%- 
                  tweet = CGI::escape("Check out the #{h(@view.name)} dataset on blist - ")
                  seo_url = "#{request.protocol + request.host_with_port + @view.href}"
                  short_url = "#{request.protocol + request.host_with_port + @view.short_href}"
                -%>
                <li><%= link_to(image_tag("icons/social_icon_delicious_small.png", :size => "20x20", :alt => "Delicious"), 
                        "http://del.icio.us/post?url=#{seo_url}&title=#{h(@view.name)}",
                        :title => "Bookmark this on Delicious", :rel => "external") %></li>
                <li><%= link_to(image_tag("icons/social_icon_digg_small.png", :size => "20x20", :alt => "Digg"), 
                        "http://digg.com/submit?phase=2&url=#{seo_url}&title=#{h(@view.name)}",
                        :title => "Digg this", :rel => "external") %></li>
                <li><%= link_to(image_tag("icons/social_icon_twitter_small.png", :size => "20x20", :alt => "Twitter"), 
                        "http://www.twitter.com/home?status=#{tweet + short_url}",
                        :title => "Tweet this", :rel => "external") %></li>
              </ul>
            </li>
          </ul>

          <form class='search' action='#'>
            <p>
              <input type='text' class='textPrompt' title='Find' />
              <input type="image" class="submit" name="findSubmit"
                src="/stylesheets/images/content/table_menu/button_find.png" />
            </p>
          </form>
          <%- end -%>
        </div>

        <%- if is_owner -%>
        <div id='addColumnsMenu' class='fixedMenu'>
          <div class='outerWrapper'>
            <ul class='innerWrapper clearfix'>
              <li class='column'>
              <%# Text datatypes %>
                <ul>
                  <li><a href='#plainText'
                    id='addColumn_plainText'>Plain Text</a></li>
                  <li><a href='#formattedText'
                    id='addColumn_formattedText'>Formatted Text</a></li>
                </ul>
              </li>
              <li class='column'>
              <%# Numeric datatypes %>
                <ul>
                  <li><a href='#number' id='addColumn_number'>Number</a></li>
                  <li><a href='#money' id='addColumn_money'>Money</a></li>
                  <li><a href='#percent' id='addColumn_percent'>Percent</a></li>
                  <li><a href='#dateTime' id='addColumn_dateTime'>Date & Time</a></li>
                </ul>
              </li>
              <li class='column'>
              <%# Address datatypes %>
                <ul>
                  <li><a href='#phone' id='addColumn_phone'>Phone</a></li>
                  <li><a href='#email' id='addColumn_email'>Email</a></li>
                  <li><a href='#url' id='addColumn_url'>Website URL</a></li>
                </ul>
              </li>
              <li class='column narrow'>
              <%# Chooser/explicit pick options datatypes %>
                <ul>
                  <li><a href='#checkbox' id='addColumn_checkbox'>Checkbox</a></li>
                  <li><a href='#stars' id='addColumn_stars'>Star</a></li>
                  <li><a href='#flag' id='addColumn_flag'>Flag</a></li>
                </ul>
              </li>
              <li class='column'>
              <%# Blob datatypes %>
                <ul>
                  <li><a href='#document' id='addColumn_document'>Document</a></li>
                  <li><a href='#photo' id='addColumn_photo'>Photo (Image)</a></li>
                </ul>
              </li>
              <li class='column wide'>
              <%# Complex/join datatypes %>
                <ul>
                  <li><a href='#picklist'
                    id='addColumn_picklist'>Picklist (Drop-down)</a></li>
                  <li><a href='#blist_in_blist'
                    id='addColumn_bnb'>Table (blist in blist)</a></li>
                </ul>
              </li>
              <li class='column narrow last'>
              <%# Existing columns to unhide %>
                <ul>
                  <li><a href='#rowTag'
                    id='addColumn_rowTag'>Row Tag</a></li>
                </ul>
              </li>
            </ul>
            <a href='#Close_Add_Columns' title='Close' class='close'>Close</a>
          </div>
        </div>
        <%- end -%>

        <div id='pageViewHeader'><div class='innerWrapper'></div></div>

        <div id='outerSwfWrapper' class='scrollContent'>
          <div id='readGrid' class='readItem'></div>
          <%- if current_user -%>
          <div id='swfWrapper' class='swfItem'>
            <%= render(:partial => "shared/swf") %>
          </div>
          <%- end -%>
        </div>

        <div id='pageViewFooter'>
          <a href='#FirstPage' id='firstPageLink' class='flashAction'
            title='First Page'>First Page</a>
          <a href='#PrevPage' id='prevPageLink' class='flashAction'
            title='Previous Page'>Previous Page</a>
          <span id='pageInfo'>Page</span>
          <a href='#NextPage' id='nextPageLink' class='flashAction'
            title='Next Page'>Next Page</a>
          <a href='#LastPage' id='lastPageLink' class='flashAction'
            title='Last Page'>Last Page</a>
        </div>

      </div>
    </div>
  </div>

  <div id='lensMetaContainer'>
    <div id="mainColumnContent" class="column">
      <div id='infoPane'>
      <%- if !@view.nil? -%>
      <%= render(:partial => "info_for_single",
      :locals => { :view => @view, :page_single => true }) %>
      <%- end -%>
      </div>
    </div>
  </div>
</div>
<% content_for :js_footer do %>
  <%= render(:partial => "shared/common_js") %>
  <script type="text/javascript">
    blist.namespace.fetch('blist.blistGrid');
    blist.blistGrid.referer = "<%= request.referer %>";
    <%- if !@view.nil? -%>
    blist.blistGrid.blistId = "<%= @view.blistId %>";
    blist.blistGrid.viewId = "<%= @view.id %>";
    <%- if @is_child_view -%>
    blist.blistGrid.viewName = "<%= h(@view.name) %>";
    <%- end -%>
    <%- end -%>
  </script>
  <%= javascript_include_tag "plugins/jquery.cookies.2.0.1.min",
    "plugins/jquery.json", "plugins/ui.core", "plugins/ui.draggable",
    "util/extMouseWheel", "util/flash-interface", "util/navigation",
    "util/swfobject", "data/types", "data/model", "data/table",
    "widgets/dropdown-menu", "widgets/selectable-list", "widgets/pagination",
    "widgets/info-pane-comments", "widgets/scrollable", "screens/info-pane",
    "screens/blist-grid-screen", :cache => "cache/blists_show_all" %>
<% end %>

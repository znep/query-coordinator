<% content_for :head do %>
  <%= rendered_stylesheet_tag 'screen-browse' %>
<% end %>

<div class='browseSection clearfix <%= @facets.length < 1 ? 'noFacets' : '' %>
  <%= @browse_in_container ? 'inContainer' : '' %>'>
  <%- if @facets.length > 0 -%>
  <div class='browseFacets'>
    <form class='searchSection'>
      <span class='icon'></span>
      <input type='text' name='browseSearch' title='Search'
        class='textPrompt searchBox' value='<%= @params[:q] %>' />
    </form>

    <%- if !@params[:q].nil? || @facets.any? {|f| !@params[f[:param]].nil? } -%>
    <div class='facetSection clearAllSection'>
      <ul>
        <li>
        <%- cp = @params.reject {|p| p == 'page' || p == 'q'} -%>
        <%- @facets.each do |f| -%>
        <%- cp.delete(f[:param]) -%>
        <%- end -%>
        <a href='<%= @base_url + '?' + cp.to_param %>'>Clear All Options</a>
        </li>
      </ul>
    </div>
    <%- end -%>

    <%- @facets.each do |facet| -%>
    <div class='facetSection clearfix'>
      <h4 class='title'><%= facet[:title] %></h4>
      <ul>
        <%- if !@params[facet[:param]].nil? -%>
        <%- cp = @params.reject {|p| p == 'page'} -%>
        <%- cp.delete(facet[:param]) -%>
        <li><a href='<%= @base_url + '?' + cp.to_param %>' class='clearValues'>
          <%- if facet[:use_icon] -%>
          <span class='icon'></span>
          <%- end -%>
          (All)
        </a></li>
        <%- end -%>
        <%- facet[:options].each do |f| -%>
        <%- cp = @params.reject {|p| p == 'page'} -%>
        <%- cp[facet[:param]] = f[:value] -%>
        <li><a href='<%= @base_url + '?' + cp.to_param %>'
          class='<%= f[:class] %> <%= @params[facet[:param]] == f[:value] ?
            'active' : '' %>'>
          <%- if facet[:use_icon] -%>
          <span class='icon'></span>
          <%- end -%>
          <%= f[:text] %>
        </a></li>
        <%- end -%>
      </ul>
      <%- if !facet[:extra_options].nil? -%>
      <a class='moreLink' href='#More <%= facet[:title] %>'>View more</a>
      <div class='moreOptions hide'>
        <%- facet[:extra_options].each do |f| -%>
        <%- cp = @params.reject {|p| p == 'page'} -%>
        <%- cp[facet[:param]] = f[:value] -%>
        <a href='<%= @base_url + '?' + cp.to_param %>'
          rel='<%= f[:count] %>'><%= f[:text] %></a>
        <%- end -%>
      </div>
      <%- end -%>
    </div>
    <%- end -%>
  </div>
  <%- end -%>

  <div class='browseList'>
    <%- if @view_count > 0 && @sort_opts.length > 0 -%>
    <div class='sortOptions'>
      <%- show_time_period = false -%>
      <select class='sortType' name='sortType'>
        <%- @sort_opts.each do |so| -%>
        <%- next if !so[:requires].nil? && @params[so[:requires]].nil? -%>
        <option value='<%= so[:value] %>' class='<%= so[:is_time_period] ?
          'timePeriod' : '' %>' <%= so[:value] == @opts[:sortBy] ?
          "selected='selected'" : '' %>><%= so[:name] %></option>
        <%- show_time_period = true if so[:value] == @opts[:sortBy] &&
          so[:is_time_period] -%>
        <%- end -%>
      </select>
      <%- time_opts = [
        {:value => 'week', :name => 'This week'},
        {:value => 'month', :name => 'This month'},
        {:value => 'year', :name => 'This year'}
      ] -%>
      <select class='sortPeriod <%= !show_time_period ? 'hide' : '' %>'
        name='sortPeriod'>
        <%- time_opts.each do |to| -%>
        <option value='<%= to[:value] %>' <%= to[:value] == @params[:sortPeriod] ?
          "selected='selected'" : '' %>><%= to[:name] %></option>
        <%- end -%>
      </select>
    </div>
    <%- end -%>

    <div class='results'>
      <%- if @view_count == 0 -%>
      <div class='noResults'>No Results</div>

      <%- else -%>
      <table class='gridList'>
        <colgroup>
          <col class='index' />
          <col class='nameDesc' />
          <col class='popularity' />
          <col class='type' />
        </colgroup>
        <thead>
          <tr>
            <th class='index'></th>
            <th class='nameDesc'>Name</th>
            <th class='popularity'>Popularity</th>
            <th class='type'>Type</th>
          </tr>
        </thead>
        <tbody>
          <%- start_index = (@opts[:page] - 1) * @limit + 1 -%>
          <%- @view_results.each_with_index do |v, i| -%>
          <tr class='item collapsed'>
            <td class='index'>
              <a class='expander' title='Click to expand' href='#Expand'>
                <span class='icon'></span>
              </a>
              <span class='value'><%= start_index + i %>.</span>
            </td>
            <td class='nameDesc'>
              <a href='<%= v.href %>' class='name'><%= v.name %></a>
              <div class='expandBlock clearfix collapsed'>
                <div class='description'><%= v.description %></div>
                <div class='extraInfo'>
                  <div class='infoContent'></div>
                  <a class='close' href='#Close'><span class='icon'></span></a>
                </div>
              </div>
            </td>
            <td class='popularity'>
              <span class='visits'><%= pluralize(number_with_delimiter(v.viewCount,
                {:locale => 'en'}), 'view') %></span>
            </td>
            <td class='type type<%= v.display.type.capitalize %>'
              title='<%= v.display.name.capitalize %>'>
              <div class='icon'></div>
            </td>
          </tr>
          <%- end -%>
        </tbody>
      </table>
      <%- end -%>
    </div>

    <%- if @view_count > 0 -%>
    <%= create_pagination(@view_count, @limit,
      @opts[:page], @base_url + '?' + @params.to_param, 'button') %>
    <%- end -%>
  </div>
</div>

<%- content_for :modals do -%>
  <div class="browseOptionsDialog modalDialog">
    <a href="#close" class="jqmClose modalDialogClose">Close</a>
    <div class='optionsContent'></div>
  </div>
<%- end -%>

<% content_for :templates do %>
<div class='expandedInfo'>
  <div class='actions'>
    <a class='permissions button' href='#Permissions'
      title='Change the public visibility'>Make <span class='permType'></span></a>
    <a class='delete button' href='#Delete' title='Delete this item'>Delete</a>
    <div class='share menu'></div>
  </div>
  <div class='comments' title='Number of comments'>
    <span class='icon'></span><span class='value'></span>
  </div>
  <div class='starsControl datasetAverageRating'></div>
</div>
<% end %>

<% content_for :js_footer do %>
  <script type='text/javascript'>
    blist.namespace.fetch('blist.browse');
    blist.browse.datasets = <%= safe_json(@view_results) %>;
  </script>
  <%= javascript_include_merged 'screen-browse' %>
<% end %>

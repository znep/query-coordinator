<% content_for :head do %>
  <%= rendered_stylesheet_tag 'administration-screen' %>
  <%= rendered_stylesheet_tag 'administration-routing-approval' %>
  <title>Dataset Routing &amp; Approval | <%= CurrentDomain.strings.site_title %></title>
<% end %>

<% content_for :skip_links do %>
  <%= link_to t('core.no_js'), '?no_js=true' %>
<% end %>

<%= render :partial => 'left_nav' %>

<div id="routingApprovalContent" class="contentBox withLeftNavigation">
  <%= render :partial => 'routing_approval_header',
        :locals => {:active => 'manage'} %>

  <%= display_standard_flashes %>

  <div id="routingApprovalManagement">
    <h2>Manage Routing and Approval Process</h2>
    <%= form_tag({:action => 'routing_approval_manage_save'},
      {:class => 'commonForm'}) do %>
      <div class="line">
        <label for="template_name" class="required">Name</label>
        <input type="text" id="template_name" name="template[name]" class="required"
          value="<%= @approval_template.nil? ? '' : @approval_template.name %>" />
      </div>
      <div class="line">
        <label for="template_maxInactivityInterval">Mark as stuck after no activity for</label>
        <input type="text" id="template_maxInactivityInterval"
          name="template[maxInactivityInterval]" class="number"
          value="<%= @approval_template.nil? ? 5 : @approval_template.maxInactivityInterval %>" />
        <label for="template_maxInactivityInterval">day(s)</label>
      </div>
      <div class="line checkbox-line">
        <%= check_box_tag(
                'template[approveOnlyNew]',
                'true',
                !(@approval_template.nil? || @approval_template.reapproveOnPublish),
                :id => 'template_approveOnlyNew'
            ) %>
        <label for="template_approveOnlyNew">Approve only new datasets</label>
        <span class="info">Check this option to allow new versions of an approved dataset through automatically</span>
      </div>

      <h3>Stages</h3>
      <p class="info deleteInfo">Clear a stage name to delete that stage</p>
      <ul class="stageList">
        <%- (@approval_template.nil? ? [] : (@approval_template.stages || [])).clone.push({'id' => 'new-0'}).
          each do |stage| -%>
        <li class="stageItem clearfix">
          <div class="line">
            <label for="template_stages_<%= stage['id'] %>_name">Name</label>
            <input type="text" id="template_stages_<%= stage['id'] %>_name"
              name="template[stages][<%= stage['id'] %>][name]" class="stageName"
              value="<%= stage['name'] %>" />
          </div>
          <div class="line">
            <label for="template_stages_<%= stage['id'] %>_notificationMode">
              Notification Method
            </label>
            <%= select_tag("template[stages][#{stage['id']}][notificationMode]",
            options_for_select({'S' => 'One at a time', 'P' => 'Everyone at once'}.invert,
            stage['notificationMode'])) %>
          </div>
          <div class="line">
            <label for="template_stages_<%= stage['id'] %>_notificationInterval">
              Notification Interval
            </label>
            <%= select_tag("template[stages][#{stage['id']}][notificationInterval]",
            notification_interval_select_options(stage['notificationInterval'])) %>
          </div>
          <div class="line">
            <label>Approvers</label>
            <ul class="userList">
              <%- (stage['approverUids'] || []).each do |userId| -%>
              <%- user = @users[userId] -%>
              <li class="userItem">
              <input type="text"
                name="template[stages][<%= stage['id'] %>][approverUids][]"
                value="<%= profile_path(user) %>" />
              <a href="<%= profile_path(user) %>"
                class="userLink"><%= user.displayName %></a>
              </li>
              <%- end -%>
              <li class="userItem newItem">
              <input type="text" class="userId"
                name="template[stages][<%= stage['id'] %>][approverUids][]" />
              <span>(Enter a user ID or URL of their profile page)</span>
              </li>
            </ul>
          </div>
        </li>
        <%- end -%>
      </ul>

      <%- if @approval_template.nil? -%>
      <div class='line'>
        <label for="grandfatherDatasets">Keep current datasets visible in the catalog</label>
        <input type="checkbox" id="grandfatherDatasets"
          name="grandfatherDatasets" value="true" checked="checked" />
        <span class="info">If not checked, all existing datasets must go through this approval process before they are visible to users</span>
      </div>
      <%- end -%>

      <ul class="finishButtons clearfix">
        <li>
          <input class="button templateSave" type="submit"
            value="<%= @approval_template.nil? ? 'Create' : 'Save' %>" />
        </li>
        <li>
          <input class="button close" type="reset" value="Cancel" />
        </li>
      </ul>
    <% end %>
  </div>
</div>

<%= admin_user_zoom %>

<%- content_for :js_footer do -%>
  <%- unless params[:no_js] == 'true' -%>
    <%= include_javascripts 'admin-routing-approval' %>
  <%- end -%>
<%- end -%>

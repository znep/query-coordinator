<!DOCTYPE html>
<html>
  <head>
    <title>Example Usage: FeatureMap.js</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF8">
    <!-- `leaflet.css` must be included or the map will render incorrectly -->
    <link rel="stylesheet" media="all" href="../bower_components/leaflet/dist/leaflet.css">
    <link rel="stylesheet" media="all" href="../dist/socrata-visualizations.css">
    <style type="text/css">

      body {
        font-size: 10px;
        font-family: sans-serif;
      }

      #feature-map-1 {
        display: block;
        position: relative;
        width: 640px;
        height: 480px;
        margin: 50px auto 0 auto;
        border: 1px solid #aaa;
      }

      #feature-map-2 {
        display: block;
        position: relative;
        width: 640px;
        height: 480px;
        margin: 50px auto 0 auto;
        border: 1px solid #aaa;
      }

    </style>
  </head>
  <body>
    <div id="feature-map-1"></div>
    <div id="feature-map-2"></div>
  </body>

  <!-- Include external dependencies -->
  <script type="text/javascript" src="../bower_components/lodash/lodash.js"></script>
  <script type="text/javascript" src="../bower_components/jquery/dist/jquery.js"></script>
  <script type="text/javascript" src="../bower_components/d3/d3.js"></script>
  <script type="text/javascript" src="../bower_components/socrata-utils/socrata.utils.js"></script>

  <!-- Include bundle -->
  <script type="text/javascript" src="../dist/socrata-visualizations.js"></script>

  <script type="text/javascript">

    $(document).ready(function() {

      /**
       * Set up the plugin.
       */

      var DOMAIN = 'dataspace.demo.socrata.com';
      var DATASET_UID = 'r6t9-rak2';
      var COLUMN_NAME = 'point';

      var TEST_DATASET_METADATA = {"name":"Case Data from San Francisco 311","updatedAt":"2014-08-22T22:36:10.000Z","defaultPage":"cs5s-apnb","description":"Cases created since 7/1/2008 with location information","domain":"dataspace.demo.socrata.com","rowDisplayUnit":"Case","locale":"en_US","id":"r6t9-rak2","columns":{"request_details":{"name":"request details","fred":"text","description":"Cases created since 7/1/2008 with location information","physicalDatatype":"text","position":9,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},":version":{"description":"","fred":"text","name":":version","physicalDatatype":"row_version"},"point":{"name":"point","fred":"location","description":"Cases created since 7/1/2008 with location information","physicalDatatype":"point","position":13,"hideInTable":false,"format":{},"dataTypeName":"point","renderTypeName":"point","defaultCardType":"feature","availableCardTypes":["feature"]},"source":{"name":"source","fred":"category","description":"Which medium was used to file the ticket","physicalDatatype":"text","position":14,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},":Computed_qgg2gdwk_point":{"name":"Police Districts","fred":"location","description":"","computationStrategy":{"source_columns":["point"],"parameters":{"region":"_qgg2-gdwk"},"strategy_type":"georegion_match_on_point"},"physicalDatatype":"text","position":17,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text"},":created_at":{"description":"","fred":"text","name":":created_at","physicalDatatype":"fixed_timestamp"},"closed":{"name":"closed","fred":"time","description":"Date case was closed","physicalDatatype":"floating_timestamp","position":3,"hideInTable":false,"format":{},"dataTypeName":"calendar_date","renderTypeName":"calendar_date","defaultCardType":"timeline","availableCardTypes":["timeline"]},"neighborhood":{"name":"neighborhood","fred":"category","description":"Cases created since 7/1/2008 with location information","physicalDatatype":"text","position":12,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},"media_url":{"name":"media url","fred":"text","description":"Cases created since 7/1/2008 with location information","physicalDatatype":"text","position":15,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},"request_type":{"name":"request type","fred":"category","description":"","physicalDatatype":"text","position":8,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},":Computed_n8rpcfd9_point":{"name":"Neighborhoods","fred":"location","description":"","computationStrategy":{"source_columns":["point"],"parameters":{"region":"_n8rp-cfd9"},"strategy_type":"georegion_match_on_point"},"physicalDatatype":"text","position":18,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text"},"opened":{"name":"opened","fred":"time","description":"Date case was filed","physicalDatatype":"floating_timestamp","position":2,"hideInTable":false,"format":{},"dataTypeName":"calendar_date","renderTypeName":"calendar_date","defaultCardType":"timeline","availableCardTypes":["timeline"]},"updated":{"name":"updated","fred":"time","description":"Time the case was updated","physicalDatatype":"floating_timestamp","position":4,"hideInTable":false,"format":{},"dataTypeName":"calendar_date","renderTypeName":"calendar_date","defaultCardType":"timeline","availableCardTypes":["timeline"]},"responsible_agency":{"name":"responsible agency","fred":"category","description":"Agency responsible for handling and managing the case","physicalDatatype":"text","position":6,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},":Computed_a9zvgp2q_point":{"name":"Zip codes","fred":"location","description":"","computationStrategy":{"source_columns":["point"],"parameters":{"region":"_a9zv-gp2q"},"strategy_type":"georegion_match_on_point"},"physicalDatatype":"text","position":19,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text"},"status":{"name":"status","fred":"category","description":"Cases created since 7/1/2008 with location information","physicalDatatype":"text","position":5,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},":Computed_ernjgade_point":{"name":"Supervisor Districts","fred":"location","description":"","computationStrategy":{"source_columns":["point"],"parameters":{"region":"_ernj-gade"},"strategy_type":"georegion_match_on_point"},"physicalDatatype":"text","position":16,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text"},"address":{"name":"address","fred":"text","description":"Cases created since 7/1/2008 with location information","physicalDatatype":"text","position":10,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},"category":{"name":"category","fred":"category","description":"","physicalDatatype":"text","position":7,"hideInTable":false,"format":{},"dataTypeName":"text","renderTypeName":"text","defaultCardType":"search","availableCardTypes":["column","search"]},":updated_at":{"description":"","fred":"text","name":":updated_at","physicalDatatype":"fixed_timestamp"},":id":{"description":"","fred":"text","name":":id","physicalDatatype":"row_identifier"},"case_id":{"name":"caseid","fred":"identifier","description":"Unique identifier per 311 case","physicalDatatype":"number","position":1,"hideInTable":false,"format":{},"dataTypeName":"number","renderTypeName":"number","defaultCardType":"histogram","availableCardTypes":["histogram","column","search"]},"supervisor_district":{"name":"supervisor district","fred":"category","description":"Cases created since 7/1/2008 with location information","physicalDatatype":"number","position":11,"hideInTable":false,"format":{},"dataTypeName":"number","renderTypeName":"number","defaultCardType":"histogram","availableCardTypes":["histogram","column","search"]},"*":{"availableCardTypes":["table"],"defaultCardType":"table","name":"Data Table","description":"","fred":"*","physicalDatatype":"*"}},"ownerId":"8ibz-n25n","permissions":{"isPublic":true,"rights":["read"]},"pages":{"publisher":[{"name":"San Francisco 311","largestTimeSpanDays":2199,"description":"SF311 cases created since 7/1/2008 with location information.  You can find the type of request, as well as volume of requests and the request status.","primaryAmountField":null,"cards":[{"activeFilters":[],"cardSize":1,"cardType":"timeline","expanded":false,"fieldName":"opened"},{"activeFilters":[],"cardSize":1,"cardType":"column","expanded":false,"fieldName":"category"},{"activeFilters":[],"cardSize":1,"cardType":"column","expanded":false,"fieldName":"request_type"},{"activeFilters":[],"cardSize":2,"cardType":"timeline","expanded":false,"fieldName":"closed"},{"activeFilters":[],"cardSize":2,"cardType":"timeline","expanded":false,"fieldName":"updated"},{"activeFilters":[],"cardSize":2,"cardType":"feature","expanded":false,"fieldName":"point"},{"activeFilters":[],"cardSize":2,"cardType":"column","expanded":false,"fieldName":"source"},{"activeFilters":[],"cardSize":2,"cardType":"table","expanded":false,"fieldName":"*"}],"datasetId":"r6t9-rak2","pageId":"cs5s-apnb","version":1,"primaryAggregation":null,"defaultDateTruncFunction":"date_trunc_ym"}],"user":[]}}

      var flyoutRenderer = new socrata.visualizations.views.FlyoutRenderer();
      socrata.visualizations.views.RowInspector.setup();

      var featureMap1VIF = {
        'aggregation': {
          'columnName': null,
          'function': 'count'
        },
        'columnName': COLUMN_NAME,
        'configuration': {
          // If the value of `datasetMetadata` is falsey then the feature map
          // plugin will make its own request for dataset metadata.
          // If it is truthy then this value will be used instead of making a new
          // request.
          'datasetMetadata': false,
          // Behavior
          'hover': true,
          'panAndZoom': true,
          'locateUser': true,
          // The localization values should be set by the application but are set to string literals
          // for the purposes of this example.
          'localization': {
            'FLYOUT_FILTER_NOTICE': 'There are too many points at this location',
            'FLYOUT_FILTER_OR_ZOOM_NOTICE': 'Zoom in to see details',
            'FLYOUT_DENSE_DATA_NOTICE': 'Numerous',
            'FLYOUT_CLICK_TO_INSPECT_NOTICE': 'Click to see details',
            'FLYOUT_CLICK_TO_LOCATE_USER_TITLE': 'Click to show your position on the map',
            'FLYOUT_CLICK_TO_LOCATE_USER_NOTICE': 'You may have to give your browser permission to share your current location',
            'FLYOUT_LOCATING_USER_TITLE': 'Your position is being determined',
            'FLYOUT_LOCATE_USER_ERROR_TITLE': 'There was an error determining your location',
            'FLYOUT_LOCATE_USER_ERROR_NOTICE': 'Click to try again',
            'FLYOUT_PAN_ZOOM_DISABLED_WARNING_TITLE': 'Panning and zooming has been disabled',
            'ROW_INSPECTOR_ROW_DATA_QUERY_FAILED': 'Detailed information about these points cannot be loaded at this time',
            'USER_CURRENT_POSITION': 'Your current location (estimated)'
          },
          // Base layer
          'baseLayerUrl': 'https://a.tiles.mapbox.com/v3/socrata-apps.ibp0l899/{z}/{x}/{y}.png',
          'baseLayerOpacity': 0.8,
          'useOriginHost': false
        },
        'createdAt': '2014-01-01T00:00:00',
        'datasetUid': DATASET_UID,
        'domain': DOMAIN,
        'filters': [],
        'format': {
          'type': 'visualization_interchange_format',
          'version': 1
        },
        'origin': {
          'type': 'test_data',
          'url': 'localhost'
        },
        'unit': {
          'one': 'record',
          'other': 'records'
        }
      };

      var $featureMap1Element = $('#feature-map-1');
      $featureMap1Element.socrataFeatureMap(featureMap1VIF);

      // Instantiate a second visualizaton with existing dataset metadata to test
      // row inspector events that have access to dataset metadata while we are
      // getting CORS into the frontend routes for metadata.
      var featureMap2VIF = _.clone(featureMap1VIF);
      featureMap2VIF.configuration.datasetMetadata = TEST_DATASET_METADATA;
      featureMap2VIF.configuration.panAndZoom = false;

      var $featureMap2Element = $('#feature-map-2');
      $featureMap2Element.socrataFeatureMap(featureMap2VIF);

      /**
       * Handle flyout events.
       * (RowInspector events are handled internally to the RowInspector)
       */

      $featureMap1Element.on('SOCRATA_VISUALIZATION_FEATURE_MAP_FLYOUT', handleFlyout);
      $featureMap2Element.on('SOCRATA_VISUALIZATION_FEATURE_MAP_FLYOUT', handleFlyout);

      function handleFlyout(event) {

        var payload = event.originalEvent.detail;

        // Render/hide a flyout
        if (payload !== null) {
          flyoutRenderer.render(payload);
        } else {
          flyoutRenderer.clear();
        }
      }

      /**
       * Destroy the plugin.
       *
       * The plugin (and all internal modules) can be destroyed by triggering
       * `destroy` on the element.
       */

      // $featureMap1Element.off('SOCRATA_VISUALIZATION_FEATURE_MAP_FLYOUT', handleFlyout);
      // $featureMap1Element.trigger('destroy');

      // $featureMap2Element.off('SOCRATA_VISUALIZATION_FEATURE_MAP_FLYOUT', handleFlyout);
      // $featureMap2Element.trigger('destroy');
    });
  </script>
</html>

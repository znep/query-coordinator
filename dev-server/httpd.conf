LockFile var/apache2-accept.lock
RewriteLock var/rewrite.lock
PidFile var/apache2.pid
Timeout 180
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 15

StartServers          8
MinSpareServers       3
MaxSpareServers       3
MaxClients            25
MaxRequestsPerChild 4000

Listen 9292
DefaultType text/plain
HostnameLookups Off

TraceEnable off

LoadModule deflate_module /usr/libexec/apache2/mod_deflate.so
LoadModule log_config_module /usr/libexec/apache2/mod_log_config.so
LoadModule proxy_module /usr/libexec/apache2/mod_proxy.so
LoadModule proxy_http_module /usr/libexec/apache2/mod_proxy_http.so
LoadModule mime_module /usr/libexec/apache2/mod_mime.so
LoadModule rewrite_module /usr/libexec/apache2/mod_rewrite.so
LoadModule alias_module /usr/libexec/apache2/mod_alias.so
LoadModule ssl_module /usr/libexec/apache2/mod_ssl.so
LoadModule headers_module /usr/libexec/apache2/mod_headers.so
LoadModule cache_module /usr/libexec/apache2/mod_cache.so
LoadModule disk_cache_module /usr/libexec/apache2/mod_disk_cache.so

CacheRoot /tmp/apache-dev-server-cache


<VirtualHost *:9292>
  DocumentRoot htdocs
  ServerName www.socrata.com

  CacheEnable disk /ui/
  CacheIgnoreHeaders Set-Cookie

  RewriteCond %{REQUEST_URI} !^/images/profile
  RewriteRule (.*)              $1      [E=orig_host:%{HTTP_HOST}]
  RequestHeader set X-Socrata-Host "%{orig_host}e"

  RewriteEngine On
  RewriteMap domain_cache_map prg:domain_map
  RewriteCond %{REQUEST_FILENAME} !-f 
  # In production this hits the v3-stable version of the API
  RewriteRule ^/api/(.*)$        http://localhost:8080/$1 [P]
  RewriteRule ^/users(.*)$      http://localhost:8080/users$1 [P]
  RewriteRule ^/views(.*)$      http://localhost:8080/views$1 [P]
  RewriteRule ^/imports(.*)$    http://localhost:8080/imports$1 [P]
  RewriteRule ^/groups(.*)$     http://localhost:8080/groups$1 [P]
  RewriteRule ^/ui/(.*)         http://localhost:8080/ui/$1 [P]
  RewriteRule ^/errors$         http://localhost:8080/errors [P]
  RewriteRule ^/batches$        http://localhost:8080/batches [P]
  RewriteRule ^/widget_customization(.*)$ http://localhost:8080/widget_customization$1 [P]
  RewriteRule ^/assets(.*)$        http://localhost:8080/assets$1 [P]
  RewriteRule ^/nominations(.*)$    http://localhost:8080/nominations$1 [P]
  RewriteRule ^/organizations(.*)$    http://localhost:8080/organizations$1 [P]
  RewriteRule ^/blists(.*)$     /datasets$1 [R=301]
  RewriteRule ^/solution/social-data-network$ /solution [R=301]
  RewriteRule ^/solution/social-data-player-basic$ /solution [R=301]
  RewriteRule ^/solution/social-data-player-platform$ /solution [R=301]

  # Semantic urls
  RewriteRule ^/id/(.*)$               http://localhost:8080/id/$1 [P]
  RewriteRule ^/resource/(.*)$         http://localhost:8080/id/$1 [P]

  # This tests caching - note that once it's live, you better remember to
  # clear your page cache!
  RewriteCond %{REQUEST_METHOD} =GET
  RewriteCond %{QUERY_STRING} =""
  RewriteCond %{REQUEST_FILENAME} !^/images/profile
  RewriteRule (.*)              ${domain_cache_map:%{DOCUMENT_ROOT}!%{SERVER_NAME}!$1}

  RewriteRule ^(.+)/$ $1 [next]

  RewriteCond %{REQUEST_FILENAME} !^/images/profile
  RewriteRule ^/(.*)$           http://localhost:3000/$1 [P]

  Options FollowSymlinks
  Alias /images/profile ${HOME}/core/profile_pictures
</VirtualHost>

<IfModule mod_ssl.c>
  SSLProtocol all -SSLv2
  SSLPassPhraseDialog builtin
  SSLSessionCache dbm:var/ssl_scache
  SSLSessionCacheTimeout 300
  SSLMutex default
  SSLRandomSeed startup builtin

  Listen 9443
  <VirtualHost *:9443>
  DocumentRoot htdocs
  ServerName 127.0.0.1

  CacheEnable disk /ui/

  SSLEngine on
  SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
  SSLCertificateFile ssl/host.crt
  SSLCertificateKeyFile ssl/host.key
  SSLCertificateChainFile ssl/ca.crt
  SSLOptions +StdEnvVars

  RequestHeader set X_FORWARDED_PROTO 'https'
  RequestHeader set X-Forwarded-Proto 'https'

  RewriteCond %{REQUEST_URI} !^/images/profile
  RewriteRule (.*)              $1      [E=orig_host:%{HTTP_HOST}]
  RequestHeader set X-Socrata-Host "%{orig_host}e"

  RewriteEngine On
  RewriteMap domain_cache_map prg:domain_map
  RewriteCond %{REQUEST_FILENAME} !-f 
  # In production this hits the v3-stable version of the API
  RewriteRule ^/api/(.*)$        http://localhost:8080/$1 [P]
  RewriteRule ^/users(.*)$      http://localhost:8080/users$1 [P]
  RewriteRule ^/views(.*)$      http://localhost:8080/views$1 [P]
  RewriteRule ^/imports(.*)$    http://localhost:8080/imports$1 [P]
  RewriteRule ^/groups(.*)$     http://localhost:8080/groups$1 [P]
  RewriteRule ^/ui/(.*)         http://localhost:8080/ui/$1 [P]
  RewriteRule ^/errors$         http://localhost:8080/errors [P]
  RewriteRule ^/batches$        http://localhost:8080/batches [P]
  RewriteRule ^/widget_customization(.*)$ http://localhost:8080/widget_customization$1 [P]
  RewriteRule ^/assets(.*)$        http://localhost:8080/assets$1 [P]
  RewriteRule ^/nominations(.*)$    http://localhost:8080/nominations$1 [P]
  RewriteRule ^/organizations(.*)$    http://localhost:8080/organizations$1 [P]
  RewriteRule ^/blists(.*)$     /datasets$1 [R=301]
  RewriteRule ^/solution/social-data-network$ /solution [R=301]
  RewriteRule ^/solution/social-data-player-basic$ /solution [R=301]
  RewriteRule ^/solution/social-data-player-platform$ /solution [R=301]
  RewriteRule ^/img(.*)$        http://localhost:8080/images$1 [P]
  RewriteRule ^/oauth/do_authorize$ http://localhost:8080/o_auth?method=doAuthorize [P,QSA]
  RewriteRule ^/oauth/access_token$ http://localhost:8080/o_auth?method=accessToken [P,QSA]

  # Semantic urls
  RewriteRule ^/id/(.*)$               http://localhost:8080/id/$1 [P]
  RewriteRule ^/resource/(.*)$         http://localhost:8080/id/$1 [P]

  # This tests caching - note that once it's live, you better remember to
  # clear your page cache!
  RewriteCond %{REQUEST_METHOD} =GET
  RewriteCond %{QUERY_STRING} =""
  RewriteRule (.*)              ${domain_cache_map:%{DOCUMENT_ROOT}!%{SERVER_NAME}!$1}

  RewriteRule ^(.+)/$ $1 [next]

  RewriteCond %{REQUEST_FILENAME} !^/images/profile
  RewriteRule ^/(.*)$           http://localhost:3000/$1 [P]

  Options FollowSymlinks
  Alias /images/profile ${HOME}/core/profile_pictures
  </VirtualHost>
</IfModule>

ErrorLog log/error.log
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\"" combined
CustomLog log/access.log combined 


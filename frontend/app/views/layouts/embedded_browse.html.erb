<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<!--[if IE 8]>
  <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<%= I18n.locale %>" lang="<%= I18n.locale %>"
        xmlns:v="urn:schemas-microsoft-com:vml"
        xmlns:og="http://opengraphprotocol.org/schema/" class="ie ie8 noBorderRadius noLinearGradient noCss3"><![endif]-->
<!--[if gte IE 9]>
  <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<%= I18n.locale %>"
        xmlns:v="urn:schemas-microsoft-com:vml"
        xmlns:og="http://opengraphprotocol.org/schema/" lang="<%= I18n.locale %>" class="ie"><![endif]-->
<!--[if !IE]>-->
  <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<%= I18n.locale %>" lang="<%= I18n.locale %>"
        xmlns:og="http://opengraphprotocol.org/schema/"><!--<![endif]-->

<!--
Powered by Socrata Publica
http://www.socrata.com
-->

<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <%= meta_tags @meta unless @meta.blank? %>
  <%= csrf_meta_tags %>
  <%- unless @link_image_src.blank? -%>
    <link rel="image_src" href="<%= @link_image_src %>?<%= asset_revision_key %>" />
  <%- end -%>

  <link rel="apple-touch-icon-precomposed" media="screen" href="/stylesheets/images/icons/retina_display_icon.png?<%= asset_revision_key %>"/>
  <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="<%= get_site_title %>" />

  <!--[if IE]>
  <style type="text/css">
    v\:vmlframe{behavior:url(#default#VML);display:inline-block;}
  </style>
  <![endif]-->

  <%= rendered_stylesheet_tag 'base' %>

  <%= render_view_js %>

  <%= jquery_include %>
  <%= javascript_error_helper_tag %>

  <%= yield :head %>

  <%- if apply_custom_css? -%>
    <link type="text/css" rel="stylesheet" href="/styles/current_site.css?<%= asset_revision_key %>"/>
  <%- end -%>

  <%= rendered_stylesheet_tag 'strip-chrome' %>
  <%= get_favicon_tag %>


  <% if use_ga_tracking_code? %>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', '<%= get_ga_tracking_code %>'],
                ['_trackPageview'],
                ['_trackPageLoadTime']);
    </script>
    <%= render_ga_tracking %>
    <%- if enable_site_chrome? -%>
      <%= site_chrome_analytics_tags %>
    <%- end -%>
  <% end %>

  <%= render 'shared/current_user_blist_js' %>
  <%= render 'templates/mixpanel_tracking' %>
  <%= render_pendo_tracker %>

</head>

<body>
  <%= yield :layout %>

  <script type="text/template" id="templates">
    <!--
      <%= render 'shared/control_templates' %>
      <%= yield :templates %>
    // -->
  </script>
  <div id="js-appended-templates" style="display: none" aria-hidden="true"></div>
  <%= render_translations %>
  <%= yield :translations %>

  <%# Libraries for use with BeautyTip %>
  <!--[if IE]>
  <script type="text/javascript" src="/javascripts/plugins/excanvas.compiled.js"></script>
  <![endif]-->

  <!--[if lt IE 9]>
    <script type="text/javascript" src="javascripts/screens/oldie.js"></script>
  <![endif]-->

  <%= include_webpack_bundle 'open-data/base.js' %>

  <%- if !Rails.env.end_with?('production') -%>
    <%= include_webpack_bundle 'open-data/debug.js' %>
  <%- else -%>
    <script type="text/javascript">
      $.debug = function() {};
    </script>
  <%- end -%>

  <script type="text/javascript">
    blist.namespace.fetch('blist.configuration');
    blist.configuration.strings = <%= safe_json(CurrentDomain.strings) %>;
    blist.configuration.webpackManifest = <%= raw Rails.configuration.webpack[:asset_manifest].to_json %>;
    blist.configuration.assetRevisionKey = '<%= asset_revision_key %>';
    blist.configuration.development = <%= Rails.env.development? %>;
    blist.locale = "<%= I18n.locale %>";
    blist.feature_flags = <%= raw json_escape(FeatureFlags.derive(nil, request, true).to_json) %>;
    blist.rights = { user: <%= raw UserRights.to_h.to_json %>, view: <%= raw ViewRights.to_h.to_json %> };
  </script>

  <div id="modals">
    <%= yield :modals %>
  </div>

  <%= yield :js_footer %>

  <%- unless CurrentDomain.theme.js.nil? -%>
    <%- if CurrentDomain.theme.js[:type].to_s == 'static' -%>
      <script type="text/javascript" src="<%= CurrentDomain.theme.js.source %>?<%= asset_revision_key %>"></script>
    <%- elsif CurrentDomain.theme.js[:type].to_s == 'hosted' -%>
      <script type="text/javascript" src="/assets/<%= CurrentDomain.theme.js.source %>?<%= asset_revision_key %>"></script>
    <%- end -%>
  <%- end -%>

  <% unless CurrentDomain.custom_tracking_code.blank? %>
    <%= raw CurrentDomain.custom_tracking_code %>
  <% end %>
</body>
</html>

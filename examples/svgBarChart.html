<!DOCTYPE html>
<html>
  <head>
    <title>Example Usage: SvgBarChart.js</title>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=UTF8">
    <link rel="stylesheet" media="all" href="../dist/socrata-visualizations.css">
    <!-- Include styleguide to test for style namespace collisions -->
    <link rel="stylesheet" media="all" href="../node_modules/socrata-components/dist/css/styleguide.css">
    <style type="text/css">

      body {
        font-size: 10px;
        font-family: sans-serif;
      }

      #bar-chart-1,
      #bar-chart-2,
      #bar-chart-3,
      #bar-chart-4,
      #bar-chart-5,
      #bar-chart-6,
      #bar-chart-7,
      #bar-chart-8,
      #bar-chart-9,
      #bar-chart-10,
      #bar-chart-11 {
        display: block;
        position: relative;
        width: 640px;
        height: 480px;
        margin: 100px auto 0 auto;
      }
    </style>
  </head>
  <body>
    <p>Unaggregated data</p>
    <div id="bar-chart-1"></div>
    <p>Unaggregated data with limit = 10</p>
    <div id="bar-chart-2"></div>
    <p>Unaggregated data with limit = 10 and 'showOtherCategory'</p>
    <div id="bar-chart-3"></div>
    <p>Aggregated data with dimension sorted ascending alphabetically</p>
    <div id="bar-chart-4"></div>
    <p>Multi-series unaggregated data</p>
    <div id="bar-chart-5"></div>
    <p>Unaggregated data with measure sorted descending by value</p>
    <div id="bar-chart-6"></div>
    <p>Multi-series aggregated data with measure axis max value</p>
    <div id="bar-chart-7"></div>
    <p>Multi-series unaggregated data with measure axis min and max values</p>
    <div id="bar-chart-8"></div>
    <p>Multi-series aggregated data configured through a dimension grouping on text columns</p>
    <div id="bar-chart-9"></div>
    <p>Multi-series aggregated data configured through a dimension grouping on number columns</p>
    <div id="bar-chart-10"></div>
    <p>Multiple defined series and data grouping configured simultaneously should show an error</p>
    <div id="bar-chart-11"></div>
  </body>

  <!-- Include external vendor -->
  <script type="text/javascript" src="./vendor.js"></script>

  <!-- Include bundle -->
  <script type="text/javascript" src="../dist/socrata-visualizations.js"></script>

  <script type="text/javascript">

    $(document).ready(function() {

      /**
       * Set up VIFs
       */

      var DIMENSION = 'district_name';
      var MEASURE = 'proficient_2';
      var MEASURE_AGGREGATION = null;
      var DATASET_UID = 'mu6e-brbz';
      var DOMAIN = 'data.iowa.gov';
      var FILTERS = [
        {
          columnName: 'topic',
          function: 'binaryOperator',
          arguments: {
            operator: '=',
            operand: 'Math'
          },
          pivot: true
        },
        {
          columnName: 'grade',
          function: 'binaryOperator',
          arguments: {
            operator: '=',
            operand: '3'
          },
          pivot: true
        },
        {
          columnName: 'school_year',
          function: 'binaryOperator',
          arguments: {
            operator: '=',
            operand: '2014'
          },
          pivot: true
        }
      ];

      var barChart1Vif = {
        configuration: {
          viewSourceDataLink: true,
          axisLabels: {
            top: 'School District',
            right: '% Proficient',
            bottom: 'School Districts in Iowa, Sorted Alphabetically',
            left: '% of 3rd Grade Students Rated Proficient in Math (For Real)'
          }
        },
        description: 'Math proficiency by school district for 3rd graders in 2014',
        series: [
          {
            color: {
              secondary: null,
              highlight: '#44ffaa'
            },
            dataSource: {
              datasetUid: DATASET_UID,
              dimension: {
                columnName: DIMENSION,
                aggregationFunction: null
              },
              domain: DOMAIN,
              measure: {
                columnName: MEASURE,
                aggregationFunction: MEASURE_AGGREGATION
              },
              type: 'socrata.soql',
              filters: FILTERS,
              orderBy: {
                parameter: 'dimension',
                sort: 'asc'
              }
            },
            label: 'Proficient',
            type: 'barChart',
            unit: {
              one: 'percent of students',
              other: 'percent of students'
            }
          }
        ],
        createdAt: '2014-01-01T00:00:00',
        format: {
          type: 'visualization_interchange_format',
          version: 2
        },
        origin: {
          type: 'test_data',
          url: 'localhost'
        },
        title: 'Math Proficienty for 3rd Graders - Iowa Public Schools'
      };

      var barChart2Vif = _.cloneDeep(barChart1Vif);
      barChart2Vif.series[0].dataSource.limit = 10;

      var barChart3Vif = _.cloneDeep(barChart1Vif);
      barChart3Vif.configuration.showOtherCategory = true;
      barChart3Vif.series[0].dataSource.limit = 10;

      var VIF_1_COLUMN_NAME = 'category';
      var VIF_1_DATASET_UID = 'r6t9-rak2';
      var VIF_1_DOMAIN = 'dataspace.demo.socrata.com';

      // This is a version 1 VIF, which should be automatically migrated
      // when passed to the visualization.
      var barChart4Vif = {
        'aggregation': {
          'columnName': null,
          'function': 'count'
        },
        'columnName': VIF_1_COLUMN_NAME,
        'configuration': {},
        'createdAt': '2014-01-01T00:00:00',
        'datasetUid': VIF_1_DATASET_UID,
        'domain': VIF_1_DOMAIN,
        'filters': [],
        'format': {
          'type': 'visualization_interchange_format',
          'version': 1
        },
        'origin': {
          'type': 'test_data',
          'url': 'localhost'
        },
        'title': VIF_1_COLUMN_NAME,
        'type': 'barChart',
        'unit': {
          'one': 'case',
          'other': 'cases'
        }
      };

      var barChart5Vif = _.cloneDeep(barChart1Vif);
      barChart5Vif.configuration.axisLabels = {
        top: null,
        right: null,
        bottom: 'School District',
        left: '# Proficient v.s. Total'
      };
      barChart5Vif.title = null;
      barChart5Vif.description = null;
      barChart5Vif.series = [
        {
          color: {
            primary: 'silver',
            secondary: null,
          },
          dataSource: {
            datasetUid: DATASET_UID,
            dimension: {
              columnName: DIMENSION,
              aggregationFunction: null
            },
            domain: DOMAIN,
            measure: {
              columnName: 'proficient_1',
              aggregationFunction: null
            },
            type: 'socrata.soql',
            filters: FILTERS.concat([
              {
                columnName: 'district_name',
                function: 'binaryOperator',
                arguments: [
                  {
                    operator: '=',
                    operand: 'Ames'
                  },
                  {
                    operator: '=',
                    operand: 'Ankeny'
                  },
                  {
                    operator: '=',
                    operand: 'Cedar Falls'
                  }
                ]
              }
            ])
          },
          label: 'Proficient',
          type: 'barChart',
          unit: {
            one: 'student',
            other: 'students'
          }
        },
        {
          color: {
            primary: 'gold',
            secondary: null,
          },
          dataSource: {
            datasetUid: DATASET_UID,
            dimension: {
              columnName: DIMENSION,
              aggregationFunction: null
            },
            domain: DOMAIN,
            measure: {
              columnName: 'total',
              aggregationFunction: null
            },
            type: 'socrata.soql',
            filters: FILTERS.concat([
              {
                columnName: 'district_name',
                function: 'binaryOperator',
                arguments: [
                  {
                    operator: '=',
                    operand: 'Ames'
                  },
                  {
                    operator: '=',
                    operand: 'Ankeny'
                  },
                  {
                    operator: '=',
                    operand: 'Cedar Falls'
                  }
                ]
              }
            ])
          },
          label: 'Total',
          type: 'barChart',
          unit: {
            one: 'student',
            other: 'students'
          }
        }
      ];

      var barChart6Vif = _.defaultsDeep({}, barChart1Vif, {
        configuration: {
          showOtherCategory: true
        },
        series: [{
          dataSource: {
            orderBy: {
              parameter: 'measure',
              sort: 'desc'
            }
          }
        }]
      });

      var barChart7Vif = {
        configuration: {
          viewSourceDataLink: true,
          axisLabels: {
            top: 'Year',
            right: null,
            bottom: 'Grouped by county names',
            left: 'Final Payments'
          },
          showOtherCategory: true,
          measureAxisMaxValue: 100
        },
        description: 'This dataset contains Iowa unemployment insurance benefit payments and number of benefit recipients by county. County data is based on the recipient’s place of residence. (Annual)',
        series: [
          {
            color: {
              secondary: null,
              highlight: '#44ffaa',
              palette: 'categorical'
            },
            dataSource: {
              datasetUid: 'yhbr-3t8a',
              dimension: {
                columnName: 'year',
                aggregationFunction: null,
                grouping: {
                  columnName: 'county_name'
                }
              },
              domain: 'data.iowa.gov',
              filters: [
                {
                  function: 'binaryOperator',
                  columnName: 'year',
                  arguments: [
                    {
                      operator: '=',
                      operand: '2000'
                    },
                    {
                      operator: '=',
                      operand: '2001'
                    },
                    {
                      operator: '=',
                      operand: '2002'
                    }
                  ]
                }
              ],
              limit: null,
              measure: {
                columnName: 'final_payments',
                aggregationFunction: 'sum'
              },
              orderBy: {
                parameter: 'measure',
                sort: 'asc'
              },
              type: 'socrata.soql'
            },
            label: '',
            type: 'barChart',
            unit: {
              one: 'dollar',
              other: 'dollars'
            }
          }
        ],
        createdAt: '2014-01-01T00:00:00',
        format: {
          type: 'visualization_interchange_format',
          version: 2
        },
        origin: {
          type: 'test_data',
          url: 'localhost'
        },
        title: 'Unemployment Insurance Recipients and UI Benefit Payments by County (Annual)'
      };

      var barChart8Vif = _.cloneDeep(barChart5Vif);
      barChart8Vif.configuration.measureAxisMinValue = 250;
      barChart8Vif.configuration.measureAxisMaxValue = 500;

      var barChart9Vif = {
        configuration: {
          viewSourceDataLink: true,
          axisLabels: {
            top: null,
            right: null,
            bottom: 'Year',
            left: 'Final Payments'
          },
          showOtherCategory: true
        },
        description: 'This dataset contains Iowa unemployment insurance benefit payments and number of benefit recipients by county. County data is based on the recipient’s place of residence. (Annual)',
        series: [
          {
            color: {
              secondary: null,
              highlight: '#44ffaa',
              palette: 'categorical'
            },
            dataSource: {
              datasetUid: 'yhbr-3t8a',
              dimension: {
                columnName: 'county_name',
                aggregationFunction: null,
                grouping: {
                  columnName: 'year'
                }
              },
              domain: 'data.iowa.gov',
              filters: [],
              limit: 7,
              measure: {
                columnName: 'final_payments',
                aggregationFunction: 'sum'
              },
              orderBy: {
                parameter: 'dimension',
                sort: 'desc'
              },
              type: 'socrata.soql'
            },
            label: '',
            type: 'barChart',
            unit: {
              one: 'dollar',
              other: 'dollars'
            }
          }
        ],
        createdAt: '2014-01-01T00:00:00',
        format: {
          type: 'visualization_interchange_format',
          version: 2
        },
        origin: {
          type: 'test_data',
          url: 'localhost'
        },
        title: 'Unemployment Insurance Recipients and UI Benefit Payments by County (Annual)'
      };

      var barChart10Vif = {
        configuration: {
          viewSourceDataLink: true,
          axisLabels: {
            top: null,
            right: null,
            bottom: 'Year',
            left: 'Final Payments'
          },
          showOtherCategory: true
        },
        description: null,
        series: [
          {
            color: {
              secondary: null,
              highlight: '#44ffaa',
              palette: 'categorical'
            },
            dataSource: {
              datasetUid: 'k6cs-ww27',
              dimension: {
                columnName: 'blood_alcohol_level',
                aggregationFunction: null,
                grouping: {
                  columnName: 'plausibility'
                }
              },
              domain: 'vertex-stories.test-socrata.com',
              filters: [],
              limit: 5,
              measure: {
                columnName: null,
                aggregationFunction: 'count'
              },
              orderBy: {
                parameter: 'measure',
                sort: 'desc'
              },
              type: 'socrata.soql'
            },
            label: '',
            type: 'barChart',
            unit: {
              one: 'dollar',
              other: 'dollars'
            }
          }
        ],
        createdAt: '2014-01-01T00:00:00',
        format: {
          type: 'visualization_interchange_format',
          version: 2
        },
        origin: {
          type: 'test_data',
          url: 'localhost'
        },
        title: null
      };

      var barChart11Vif = _.cloneDeep(barChart10Vif);
      barChart11VifSecondSeries = _.cloneDeep(barChart11Vif.series[0]);
      barChart11VifSecondSeries.dataSource.dimension.grouping = null;
      barChart11Vif.series.push(barChart11VifSecondSeries);

      /**
       * Instantiate the plugins
       */

      var flyoutRenderer = new socrata.visualizations.views.FlyoutRenderer();

      var $barChart1Element = $('#bar-chart-1');
      $barChart1Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart1Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart1Element.socrataSvgBarChart(barChart1Vif);

      var $barChart2Element = $('#bar-chart-2');
      $barChart2Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart2Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart2Element.socrataSvgBarChart(barChart2Vif);

      var $barChart3Element = $('#bar-chart-3');
      $barChart3Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart3Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart3Element.socrataSvgBarChart(barChart3Vif);

      var $barChart4Element = $('#bar-chart-4');
      $barChart4Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart4Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart4Element.socrataSvgBarChart(barChart4Vif);

      var $barChart5Element = $('#bar-chart-5');
      $barChart5Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart5Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart5Element.socrataSvgBarChart(barChart5Vif);

      var $barChart6Element = $('#bar-chart-6');
      $barChart6Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart6Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart6Element.socrataSvgBarChart(barChart6Vif);

      var $barChart7Element = $('#bar-chart-7');
      $barChart7Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart7Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart7Element.socrataSvgBarChart(barChart7Vif);

      var $barChart8Element = $('#bar-chart-8');
      $barChart8Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart8Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart8Element.socrataSvgBarChart(barChart8Vif);

      var $barChart9Element = $('#bar-chart-9');
      $barChart9Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart9Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart9Element.socrataSvgBarChart(barChart9Vif);

      var $barChart10Element = $('#bar-chart-10');
      $barChart10Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart10Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart10Element.socrataSvgBarChart(barChart10Vif);

      var $barChart11Element = $('#bar-chart-11');
      $barChart11Element.on('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      $barChart11Element.on(
        'SOCRATA_VISUALIZATION_VIF_UPDATED',
        handleVifUpdated
      );
      $barChart11Element.socrataSvgBarChart(barChart11Vif);

      /**
       * Handle plugin events
       */

      function handleFlyout(event) {
        var payload = event.originalEvent.detail;

        // Render/hide a flyout
        if (payload !== null) {

          flyoutRenderer.render(payload);

        } else {

          flyoutRenderer.clear();
        }
      }

      function handleVifUpdated(event) {
        var payload = event.originalEvent.detail;
        var renderVifEvent = jQuery.Event('SOCRATA_VISUALIZATION_RENDER_VIF');

        renderVifEvent.originalEvent = {
          detail: payload
        };

        $(this).trigger(renderVifEvent);
      }

      /**
       * How to destroy the plugin:
       */

      // $barChart1Element.off('SOCRATA_VISUALIZATION_FLYOUT', handleFlyout);
      // $barChart1Element.off('SOCRATA_VISUALIZATION_VIF_UPDATED', handleVifUpdated);
      // $barChart1Element.trigger('SOCRATA_VISUALIZATION_DESTROY');
    });
  </script>
</html>

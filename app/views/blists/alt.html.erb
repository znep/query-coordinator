<% content_for :head do %>
  <%= auto_discovery_link_tag(:rss, "/views/#{@view.id}/rows.rss") %>
  <%= stylesheet_link_merged 'blist-show-alt' %>
  <title><%= h(@view.name) %> | <%= CurrentDomain.strings.site_title %></title>
  <%= meta_tags :description => @meta_description, :keywords => @meta_keywords %>
  <link rel="canonical" href="<%= @view.href %>" />
<% end %>

<% content_for :skip_links do %>
  <a href="#dataGrid" accesskey="d">Skip to data grid</a>
  <a href="#search" accesskey="s">Skip to search within this dataset</a>
  <a href="#views" accesskey="v">Skip to other views of this data</a>
  <% if module_enabled? :allow_comments %>
    <a href="#comments" accesskey="o">Skip to comments</a>
  <% end %>
  <a href="#sharing" accesskey="h">Skip to sharing</a>
  <%- if @view.display.can_publish? -%>
  <a href="#publishing" accesskey="p">Skip to publishing</a>
  <%- end -%>
<% end %>

<%- is_owner = current_user && @view.owner.id == current_user.id -%>
<%- is_blist = @view.is_blist? %>
<%- can_edit = current_user && @view.can_edit() -%>

<div class="altShowContainer oneColumnContainer <%= @view.is_invalid? ? 'invalidView' : '' %>">
  <div class="fullPageContentContainer">
    <div class="fullPageOuterContent">
      <div class="fullPageContent">
        <div class="outerContent">
          <div class="contentTR"><div class="contentTL"></div></div>
          <div class="content">
            <ul id="datasetMenu">
              <li><a href="<%= @view.href %>/about">About this Dataset...</a></li>
              <li><a href="<%= @view.href %>/print">Print...</a></li>
              <li><a href="<%= @view.href %>/email">Email...</a></li>
              <li><a href="<%= @view.href %>/append">Append Rows via Upload...</a></li>
              <li><a href="<%= @view.href %>/replace">Replace Rows via Upload...</a></li>
              <li><a href="/views/<%= @view.id %>/rows.rss">Subscribe via RSS</a></li>
            <%- socialize_menu_options(@view).each do |item| -%>
              <li><a href="<%= item['href'] %>">Share via <%= item['text'] %></a></li>
            <%- end -%>
              <li><a href=""></a></li>
              <li><a href="/views/<%= @view.id %>/rows.csv?accessType=DOWNLOAD">Export To CSV</a></li>
              <li><a href="/views/<%= @view.id %>/rows.xls?accessType=DOWNLOAD">Export To XLS</a></li>
              <li><a href="/views/<%= @view.id %>/rows.xlsx?accessType=DOWNLOAD">Export To XLSX</a></li>
            </ul>
            <a name="dataGrid"></a>

            <h1><%= @view.name %></h1>
            <% if @view.parent_dataset != @view %>
              <p>This is a filtered view based on <%= link_to @view.parent_dataset.name, @view.parent_dataset.alt_href %>.</p>
            <% end %>

            <div class="dataGridWrapper">
              <table id="dataGrid">
                <%= render(:partial => 'alt_tbody',
                  :locals => {:columns => @view.viewable_columns,
                  :rows => @data, :start_page => @page, :parent_id => '0'}) %>
                <%- unless @aggregates.nil? or @aggregates.none? -%>
                <tfoot>
                  <tr>
                  <%= render(:partial => 'alt_tfooter',
                    :locals => {:columns => @view.viewable_columns,
                    :aggregates => @aggregates}) %>
                  </tr>
                </tfoot>
                <%- end -%>
              </table>
            </div>
            <div id="pagination links" style="margin: 20px;">
              <%= create_pagination(@row_count, @per_page, @page, @view.href + '/alt?' + @state_param) %>
            </div>
          </div>

          <%- form_tag @view.alt_href, :method => :get do -%>
            <h2>Filter</h2>
            <ul>
              <%- @view.viewable_columns.each do |column| -%>
                <%- unless column.possible_filter_conditions.nil? -%>
                  <li>
                    <%= label_tag "filter_#{column.id}_operator", "Filter by #{column.name}" %>
                    <%= select_tag "filter[#{column.id}][operator]",
                                   options_for_limit_to(column, params.deep_value_at([:filter, column.id.to_s.to_sym, :operator])) %>
                    <%= label_tag "filter_#{column.id}_value", "the value" %>
                    <%= text_field_tag "filter[#{column.id}][value]", params.deep_value_at([:filter, column.id.to_s.to_sym, :value]) %>
                  </li>
                <%- end -%>
              <%- end -%>
            </ul>
            <%= submit_tag "Apply Filter" %>

            <h2>Sort</h2>
            <ul>
              <%- 1.upto(5) do |n| -%>
                <li>
                  <%= label_tag "sort_#{n}_field", "Sort field #{n.to_s}" %>
                  <%= select_tag "sort[#{n}][field]",
                                 options_for_sort_by(@view.viewable_columns, params.deep_value_at([:sort, n.to_s.to_sym, :field]).to_i) %>
                  <%= label_tag "sort_#{n}_direction", 'in' %>
                  <%= select_tag "sort[#{n}][direction]",
                                 options_for_select(["Ascending", "Descending"],
                                                    params.deep_value_at([:sort, n.to_s.to_sym, :direction]) || "Ascending") %>
                  order
                </li>
              <% end %>
            </ul>
            <%= submit_tag "Apply Sort" %>

            <a name="search"></a>
            <h2>Search</h2>
            <%= label_tag 'search_term', 'Search' %>
            <%= text_field_tag 'search_string', params[:search_string] %>
            <%= submit_tag 'Apply Search' %>
          <%- end -%>
        </div>

        <h2>Save this view</h2>
        <%- if !@conditions.empty? && current_user -%>
          <%- form_tag (save_filter_blist_path(@view.id) + '?' + @state_param) do -%>
            <%= hidden_field_tag 'query_json', @query_json %>
            <%= label_tag "Name" %>
            <%= text_field_tag "name" %>
            <%= submit_tag "submit" %>
          <% end %>
        <% elsif !@conditions.empty? && !current_user %>
          <p><%= link_to "Sign in to save this view.", "#{@view.alt_href}?force_login=true&#{@state_param}" %></p>
        <% end %>

        <div class="altMeta">
          <a name="views"></a>
          <h2>Saved Views</h2>
          <% if @view.filters.size > 0 %>
            <% @view.filters.each do |filter| %>
              <ul class="metaDataList">
                <li><%= link_to filter.name, filter.alt_href %></li>
              </ul>
            <% end %>
          <% else %>
            <p>No other views on this dataset</p>
          <% end %>

          <% if module_enabled? :allow_comments %>
            <a name="comments"></a>
            <h2>Post a Comment</h2>
            <%- form_tag(post_comment_blist_path(@view.id)) do -%>
              <% field_set_tag do %>
                <%= label_tag "comment[viewRating]", "My Rating" %>
                <%= select_tag("comment[viewRating]", options_for_select([1, 2, 3, 4, 5].reverse)) %>
              <% end %>

              <% field_set_tag do %>
                <%= label_tag "comment[title]", "Title" %>
                <%= text_field_tag("comment[title]") %>
              <% end %>

              <% field_set_tag do %>
                <%= label_tag "comment[body]", "Body" %>
                <%= text_area_tag("comment[body]") %>
              <% end %>

              <%= submit_tag "Submit this comment" %>
            <%- end -%>

            <h2>Comments</h2>
            <ul class="metaDataList">
              <li><em>Total Comments:</em> <%= @view.numberOfComments %></li>
              <li><em>Average Rating:</em> <%= @view.averageRating %></li>
            </ul>

            <% @view.comments.each do |comment| %>
              <div class="comment">
                <h3><%= comment.title %></h3>
                <ul class="metaDataList">
                  <li><em>Rating:</em> <%= comment.viewRating.nil? ? "No rating" : "#{comment.viewRating.to_i} out of 5" %></li>
                  <li><em>Author:</em> <%= comment.user.displayName %></li>
                  <li><em>Posted:</em> <%= humane_date(comment.createdAt) %></li>
                </ul>
                <p><%= comment.body %></p>
              </div>
            <% end %>
          <% end %>

          <a name='sharing'></a>
          <div id='sharingBlock'>
            <h2>Sharing</h2>
            <%-
            shares = @view.shares
            can_share = @view.owned_by?(current_user) &&
              @view.parent_dataset.owned_by?(current_user)
            -%>

            <h4>This <%= @view.is_blist? ? t(:blist_name) : "view" %> is
              <%= @view.is_public? ?  "public" : "private" %>
              <%= ' and shared with ' + pluralize(shares.length, 'friend') if
                @view.is_shared? %>
            </h4>
            <%- if can_share -%>
            <% form_tag(url_for(:controller => :blists,
              :action => :modify_permission)) do %>
            <%= hidden_field_tag 'permission_type', @view.is_public? ?
              'private' : 'public.' + @view.display.public_perm_type %>
            <%= submit_tag 'Make it ' + (@view.is_public? ?
              'private' : 'public') %>
            <% end %>
            <%- end -%>

            <%- if shares.length > 0 -%>
            <ul class='shareList'>
              <%- shares.sort {|a,b|
                a.type <=> b.type ||
                a.member_name.downcase <=> b.member_name.downcase}.each do |s| -%>
                <li>
                <%- if s.member_id -%>
                <a href="<%= User.href(s.member_name, s.member_id) %>">
                  <%= s.member_name %>
                </a>
                <%- else -%>
                <%= s.member_name %>
                <%- end -%>
                (<%= s.type %>)
                </li>
              <%- end -%>
            </ul>
            <%- end -%>
          </div>

          <%- if @view.display.can_publish? -%>
          <a name='publishing'></a>
          <div id='publishingBlock'>
            <h2>Publishing</h2>

            <%- if @view.is_private? -%>
            <p>
            This <%= @view.is_blist? ? t(:blist_name).downcase : 'view' %> is
            currently private.  Private <%= @view.is_blist? ?
              t(:blist_name).downcase.pluralize : 'views' %>
            cannot be viewed in the Social Data Player.  Please
            set the privacy to public or shared before publishing.
            </p>
            <%- else -%>
            <p>
            You can publish this <%= t(:blist_name).downcase %> and its views
            on your blog or website by embedding it in a Social Data Player.
            You can do so by simply copying and pasting the below HTML into
            your site.
            </p>
            <%- customization_id = CurrentDomain.default_widget_customization -%>
            <%- variation = customization_id.empty? ? 'normal' : customization_id %>
            <%= text_area_tag("publishCodeTemplate",
              get_publish_embed_code_for_view(@view,
              {:dimensions => { :width => '500',  :height => '425' }},
              variation)) %>

            <a id="previewWidgetLink"
              href="/widgets_preview/<%= @view.id
                %>?width=500&height=425&variation=<%= variation %>">See Preview</a>
            <%- end -%>
          </div>
          <%- end -%>

        </div>
      </div>
    </div>
  </div>
</div>

<% content_for :head do %>
  <%= rendered_stylesheet_tag 'dataset-edit-metadata' %>
  <title>Edit Dataset Metadata | <%= CurrentDomain.strings.site_title %></title>
<% end %>

<% content_for :skip_links do %>
  <a href="?no_js=true">Disable Javascript on this page</a>
<% end %>

<div class="contentBox fixedWidth">
  <% form_tag({}, {:id => "editMetadataForm", :class => 'commonForm', :method => :post, :multipart => true}) do %>
    <h1>Edit Metadata for <%= @view.name %></h1>
    <a href="<%= @view.href %>" class="returnLink">Return to Dataset</a>

    <%= display_standard_flashes %>

    <h2>General Information</h2>

    <div class="line clearfix">
      <label for="view_name" class="required">Dataset Title</label>
      <%= text_field_tag("view[name]", @view.name, :title => "Enter a title", :class => "textPrompt") %>
    </div>

    <div class="line clearfix">
      <label for="view_description">Brief Description</label>
      <%= text_area_tag("view[description]", @view.description, :title => "Enter a description", :class => "textPrompt") %>
    </div>

    <div class="line clearfix">
      <label for="view_category">Category</label>
      <%= select_tag("view[category]", category_select_options(h(@view.category.nil? ? '' : @view.category))) %>
    </div>

    <div class="line clearfix">
      <label for="view_tags">Tags / Keywords</label>
      <%= text_field_tag("view[tags]", @view.tags.nil? ? '' : @view.tags.join(', '), :title => "Enter keywords", :class => "textPrompt") %>
      <div class="additionalHelp">Enter one or more keywords separated by commas</div>
    </div>

    <h2>Licensing &amp; Attribution</h2>

    <div class="line clearfix">
      <label for="view_licenseId">Licensing</label>
      <%= select_tag("view[licenseId]", merged_license_select_options(@view.licenseId)) %>
      <div class="additionalHelp">Choose licensing terms for people who wish to use this dataset.</div>
    </div>

    <div class="line clearfix">
      <label for="view_attribution">Data Provided By</label>
      <%= text_field_tag("view[attribution]", @view.attribution, :title => "Individual or Organization", :class => "textPrompt") %>
    </div>

    <div class="line clearfix">
      <label for="view_attributionLink">Source Link</label>
      <%= text_field_tag("view[attributionLink]", @view.attributionLink, :title => "Enter Web Address", :class => "textPrompt") %>
    </div>


   <%- if @view.is_tabular? -%>
   <h2>Advanced</h2>

    <div class="line clearfix">
      <label for="view_metadata_rdfClass">Semantic Class</label>
        <%= select_tag("view[metadata[rdfClass]]",
              options_for_select(
                RdfTerm.all_class_options,
                h(@view.metadata.nil? || @view.metadata.rdfClass.nil? ? '' : @view.metadata.rdfClass)),
              :hasCustomEdit => 1, :class => 'combo_button_edit' )
        %>
        <%= text_field_tag 'view[metadata[customRdfClass]]', @view.rdf_class, :name=>'view[metadata[customRdfClass]]',
          :class => 'textValue hide combo_button_edit'
        %>
        <ul class="comboToggle actionButtons"><li><a>Custom</a></li></ul>
    </div>

    <div class="line clearfix">
      <label for="view_metadata_rdfSubject">Subject Column</label>
      <%= select_tag("view[metadata[rdfSubject]]",
          rdf_subject_select_options(
          @view.columns,
          h(@view.metadata.nil? || @view.metadata.rdfSubject.nil? ? '' : @view.metadata.rdfSubject)))
      %>
    </div>
    <%- end -%>

    <h2>Attachments</h2>

    <div class="attachments">
      <div class="line clearfix">
        <label>Existing Attachments</label>
        <div class="existingAttachments">
          <ul>
            <%- if @view.metadata && !@view.metadata.attachments.blank? -%>
              <%- @view.metadata.attachments.each do |attachment| -%>
                <%- attachmentObj = Attachment.set_up_model(attachment) -%>
                <li>
                  <%= hidden_field_tag("view[metadata[attachments]][][blobId]",   attachment['blobId']) %>
                  <%= hidden_field_tag("view[metadata[attachments]][][filename]", attachment['filename']) %>
                  <%= text_field_tag(  "view[metadata[attachments]][][name]",     attachmentObj.displayName) %>
                  <span class="deleteLinks">
                    <label>Delete</label>
                    <%= check_box_tag("view[metadata[attachments]][][delete]") %>
                  </span>
                </li>
              <%- end -%>
            <%- else -%>
              <li class="noAttachmentsItem">(none)</li>
            <%- end -%>
          </ul>
        </div>
      </div>

      <div class="line clearfix">
        <label for="attachment_new" class="newAttachmentLabel">New Attachment</label>
        <%= file_field_tag("attachment_new") %>
        <span class="uploadAttachmentThrobber"></span>
      </div>
    </div>

    <%- (merge_custom_metadata(@view)).each do |fieldset| -%>
      <div class="customFieldsetWrapper">
        <h2>
          <a href="#Toggle" class="toggleFieldsetLink expander expanded">
            <span class="icon"></span>
            <%= fieldset.name %>
          </a>

        </h2>
        <%- existing_fields = (@view.metadata && @view.metadata.custom_fields &&
              @view.metadata.custom_fields.assoc(fieldset.name)) ?
              @view.metadata.custom_fields.assoc(fieldset.name)[1] : {} -%>

        <div class="customFieldset">
          <%- (fieldset.fields || []).each do |field| -%>
            <%- required       = field['required'].present? -%>
            <%- existing_value = existing_fields[field.name] || '' -%>

            <div class="line clearfix<%= ' customRequired' if required %>">
              <label for="view_metadata_custom_fields_<%= fieldset.name + "_" + field.name %>"
                <%= " class='required'" if required %>>
                <%= field.name %></label>
              <%= text_field_tag("view[metadata][custom_fields][#{fieldset.name}][#{field.name}]", existing_value) %>
            </div>
          <%- end -%>
        </div>
      </div>
    <%- end -%>

    <div class="required">Required Field</div>
    <div class="clearfix submitActions">
      <input class="button submitButton" type="submit" title="Save changes" value="Save" />
      <a class="button" href="<%= @view.href %>">Cancel</a>
    </div>
  <%- end -%>
</div>

<% content_for :js_footer do %>
  <%- unless params[:no_js] == 'true' -%>
    <%= include_javascripts 'dataset-edit-metadata' %>
  <%- end -%>
<% end %>

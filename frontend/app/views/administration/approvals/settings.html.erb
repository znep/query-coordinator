<%= content_for :head do %>
  <title><%= t('approvals.settings.title') %> | <%= get_site_title %></title>
<%- end %>

<% content_for :breadcrumb do %>
  <%= admin_nav_link_to('approvals.header.breadcrumbs.approvals', :controller => 'approvals', :action => 'show' ) %>
  <span class="socrata-icon-arrow-right separator"></span>
  <span class="current-page"><%= t('approvals.header.breadcrumbs.approvals_settings') %></span>
<% end %>

<div class="approvals_settings">
  <% if workflow_exists? %>
    <%= form_tag("/admin/approvals/settings/#{params[:id]}", :method => 'POST') do %>
      <div class="actions">
        <div class="change_settings">
          <button type="button" class="btn btn-sm btn-primary btn-dark">
            <%= t('edit', scope: 'approvals.settings') %>
          </button>
        </div>
        <div class="form_buttons" style="display: none;">
          <button type="submit" class="btn btn-sm btn-primary btn-dark">
            <span class="btn-title"><%= t('save', scope: 'approvals.settings') %></span>
            <span class="spinner-default spinner-btn-primary hidden"></span>
          </button>
          <button type="button" class="cancel btn btn-sm">
            <span class="btn-title"><%= t('cancel', scope: 'approvals.settings') %></span>
            <span class="spinner-default spinner-btn-secondary hidden"></span>
          </button>
        </div>
      </div>

      <section>
        <div class="introduction">
          <p>
            <%= t('summary', scope: 'approvals.settings.introduction') %>
          </p>
        </div>

        <div class="learn_more">
          <a href="https://support.socrata.com/hc/en-us/articles/115002201008--Community-Badges">
            <%= t('learn_more', scope: 'approvals.settings') %>
          </a>
        </div>

        <div class="official_assets settings_group">
          <div class="configuration_title">
            <h6>
              <%= t('title', scope: 'approvals.settings.official_assets') %>
              <span class="socrata-icon-official2" />
            </h6>
            <p>
              <%= t('subtitle', scope: 'approvals.settings.official_assets') %>
            </p>
          </div>
          <div class="configuration_options">
            <ul>
              <li class="<%= workflow_official_task.approved? && 'selected' %>">
                <%= radio_button_tag('official_approval_strategy', 'automatic', workflow_official_task.approved?, :disabled => true) %>
                <label class="radio_label" for="official_approval_strategy_automatic">
                  <%= t('title', scope: 'approvals.settings.official_assets.manual_approval.not_required') %>
                </label>
                <div>
                  <%= t('subtitle', scope: 'approvals.settings.official_assets.manual_approval.not_required') %>
                </div>
              </li>

              <li class="<%= workflow_official_task.manual? && 'selected' %>">
                <%= radio_button_tag('official_approval_strategy', 'manual', workflow_official_task.manual?, :disabled => true) %>
                <label class="radio_label" for="official_approval_strategy_manual">
                  <%= t('title', scope: 'approvals.settings.official_assets.manual_approval.required') %>
                </label>
                <div>
                  <%= t('subtitle', scope: 'approvals.settings.official_assets.manual_approval.required') %>
                </div>
              </li>
            </ul>
          </div>
        </div>

        <div class="community_assets settings_group">
          <div class="configuration_title">
            <h6>
              <a href="https://support.socrata.com/hc/en-us/articles/115002201008--Community-Badges"><span class="socrata-icon-question" /></a>
              <%= t('community_assets', scope: 'approvals.settings.approval_process') %>
              <span class="socrata-icon-community" />
            </h6>
            <p>
              <%= t('subtitle', scope: 'approvals.settings.community_assets') %>
            </p>
          </div>
          <div class="configuration_options">
            <ul>
              <li class="<%= workflow_community_task.approved? && 'selected' %>">
                <%= radio_button_tag('community_approval_strategy', 'automatic', workflow_community_task.approved?, :disabled => true) %>
                <label class="radio_label" for="community_approval_strategy_automatic">
                  <%= t('title', scope: 'approvals.settings.community_assets.manual_approval.not_required') %>
                </label>
                <div>
                  <%= t('subtitle', scope: 'approvals.settings.community_assets.manual_approval.not_required') %>
                </div>
              </li>
              <li class="<%= workflow_community_task.manual? && 'selected' %>">
                <%= radio_button_tag('community_approval_strategy', 'manual', workflow_community_task.manual?, :disabled => true) %>
                <label class="radio_label" for="community_approval_strategy_manual">
                  <%= t('title', scope: 'approvals.settings.community_assets.manual_approval.required') %>
                </label>
                <div>
                  <%= t('subtitle', scope: 'approvals.settings.community_assets.manual_approval.required') %>
                </div>
              </li>
              <li class="<%= workflow_community_task.rejected? && 'selected' %>">
                <%= radio_button_tag('community_approval_strategy', 'reject', workflow_community_task.rejected?, :disabled => true) %>
                <label class="radio_label" for="community_approval_strategy_reject">
                  <%= t('title', scope: 'approvals.settings.community_assets.manual_approval.auto_rejected') %>
                </label>
                <div>
                  <%= t('subtitle', scope: 'approvals.settings.community_assets.manual_approval.auto_rejected') %>
                </div>
              </li>
            </ul>
          </div>
        </div>

        <!-- EN-21078: Hide "Re-approval" settings group for now -->
        <!--
          <div class="settings_group">
            <div class="configuration_title">
              <h6>
                <%#= t('reapproval', scope: 'approvals.settings.approval_process') %>
              </h6>
            </div>
            <div class="configuration_options">
              <ul>
                <li class="<%#= @approval_workflow.manual? && 'selected' %>">
                  <%#= check_box_tag('reapproval_strategy', 'manual', @approval_workflow.manual?, :disabled => true, :class => 'embiggen') %>
                  <label class="checkbox_label" for="reapproval_strategy">
                    <%#= t('working_copies', scope: 'approvals.settings.approval_process') %>
                  </label>
                </li>
              </ul>
            </div>
          </div>
        -->

        <div class="settings_group">
          <div class="configuration_title">
            <h6>
              <%= t('approvers', scope: 'approvals.settings.approval_process') %>
            </h6>
          </div>
          <div class="approver_list">
            <div class="subtext">
              <%= t('asset_approvers', scope: 'approvals.settings.approval_process') %>:
            </div>
            <% @approvers.each do |approver| %>
              <div>
                <span class="full_name"><%= approver.displayName %></span>
                <span class="email_address"><%= approver.email %></span>
              </div>
            <% end %>
          </div>
        </div>

        <div>
          <a href="/admin/users">
            <%= t('user_management', scope: 'approvals.settings') %>
          </a>
        </div>

      </section>
    <% end %>
  <% else %>
    <section>
      <p>
        <strong><%= t('missing_workflow', scope: 'approvals.settings') %></strong>
      </p>
    </section>
  <% end %>
</div>

<% content_for :scripts do %>
  <script>
    $(document).ready(function() {
      $('.change_settings > button').on('click', function(event) {
        $('.change_settings').hide();
        $('.form_buttons').show();
        $('input').attr('disabled', false);
      });
      $('.form_buttons button').on('click', function(event) {
        $(event.target).parent('button').addClass('btn-busy');
      });
      $('.form_buttons button.cancel').on('click', function(event) {
        document.location.href = '/admin/approvals';
      });
      $('.approvals_settings input').on('change', function(event) {
        $(event.target).closest('ul').children('li').removeClass('selected');
        if (event.target.checked) {
          $(event.target).parent('li').addClass('selected');
        }
      });
      // If any Rails alerts, keep them for 3s and then fade them over 2s
      setTimeout(function() {
        $('.styleguide-alert').fadeTo(2000, 0)
      }, 3000);
    });
  </script>
<% end %>

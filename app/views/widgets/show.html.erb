<% content_for :head do %>
  <%= stylesheet_link_merged 'widgets-show' %>
  
  <%= meta_tags :description => @meta_description, :keywords => @meta_keywords %>
  <%- if @view -%>
    <link rel="canonical" href="<%= @view.href %>" />
  <%- end -%>
  
  <%- unless @is_gov_widget -%>
  <style id="customizationStyles" type="text/css">
  /* font */
    html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, font, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td { font-family: <%= @theme[:style][:font][:face] %>; }

    div.blist-th .info-container { font-size: <%= @theme[:style][:font][:grid_header_size][:value] %><%= @theme[:style][:font][:grid_header_size][:unit] %>; }
    .blist-td, .blist-table-editor, .blist-table .blist-combo-dd li { font-size: <%= @theme[:style][:font][:grid_data_size][:value] %><%= @theme[:style][:font][:grid_data_size][:unit] %>; }
  
  /* frame */
    <%- if @theme[:frame][:gradient] -%>
      <%-
      base_gradient = {
        :h => 38, :rh => 30,
        :fc => "#{Color.from_hex(@theme[:frame][:color]) + Color.from_hex('4c4c4c')}," +
               "#{Color.from_hex(@theme[:frame][:color]) + Color.from_hex('191919')}:0.4," +
               "#{Color.from_hex(@theme[:frame][:color])}:0.4" }
      if @theme[:frame][:border]
        base_gradient[:ec] = @theme[:frame][:border].gsub(/#/, '')
        base_gradient[:ew] = 1
      end
      -%>
      #header .wrapperT
      {
        background-image: <%= box(base_gradient.merge({ :w => 3, :rw => 1, :rx => 1 })) %>;
      }
      #header .wrapperTR
      {
        background-image: <%= box(base_gradient.merge({ :r => 8, :rx => 8 })) %>;
      }
      #header
      {
        background-image: <%= box(base_gradient.merge({ :r => 8, :rw => 8 })) %>;
      }
      .widgetFooterWrapper
      {
        background-image: <%= box(base_gradient.merge({ :h => 80, :rh => 80, :w => 3, :rw => 1, :rx => 1,
          :fc => "#{Color.from_hex(@theme[:frame][:color])}:0.8,#{Color.from_hex(@theme[:frame][:color]) + Color.from_hex('3f3f3f')}"})) %>;
      }
    <%- else -%>
      #header,
      #header .wrapperT,
      #header .wrapperTR,
      .widgetFooterWrapper
      {
          background-color: <%= @theme[:frame][:color] %>;
          background-image: none;
      }
      
      <%- if @theme[:frame][:border] -%>
        #header
        {
            border: 1px solid <%= @theme[:frame][:border] %>;
            border-bottom: none;
        }
      <%- end -%>
    <%- end -%>

    .gridInner
    {
        border-color: <%= @theme[:frame][:color] %>;
    }

    .dialogBox .header
    {
      background-color: <%= @theme[:frame][:color] %>;
    }

    .infoContentOuter,
    .metadataPane .summaryTabs li,
    .singleInfoComments li.comment.ownerComment .commentBlock .cornerOuter,
    .metadataPane .summaryTabs
    {
        border-color: <%= @theme[:frame][:color] %>;
    }

    .metadataPane .summaryTabs li .tabOuter,
    .metadataPane .summaryTabs li .tabInner
    {
      background-image: url(/ui/box.png?ew=1&rh=20&ec=<%= @theme[:frame][:color].sub(/#/, '') %>&fc=ececec&h=23&r=3&s=h&bc=ececec);
    }

    .metadataPane .summaryTabs li.active .tabOuter,
    .metadataPane .summaryTabs li.active .tabInner
    {
      background-image: url(/ui/box.png?ew=1&rh=20&ec=<%= @theme[:frame][:color].sub(/#/, '') %>&fc=cacaca&h=23&r=3&s=h&bc=ececec);
    }

    .metadataPane .summaryTabs li.scrollArrow a,
    .metadataPane .summaryTabs li.scrollArrow.disabled a,
    .metadataPane .summaryTabs li.scrollArrow.disabled a:hover
    {
      background-color: <%= @theme[:frame][:color] %>;
      border-color: <%= @theme[:frame][:color] %>;
    }

    .infoContentOuter .infoContentInner
    {
      background-image: url(/ui/box.png?w=150&h=1&fc=<%= @theme[:frame][:color].sub(/#/, '') %>);
    }

    <%- if @theme[:frame][:border] -%>
      .gridOuter, .widgetFooterInner
      {
          border-color: <%= @theme[:frame][:border] %>;
      }
    <%- end -%>

    .widgetLogo
    {
      <%- if @theme[:frame][:logo] == 'none' -%>
      <%- elsif @theme[:frame][:logo] == 'default' -%>
        background-image: url(/stylesheets/images/widgets/socrata_logo_player.png);
      <%- elsif @theme[:frame][:logo].match(/[\dA-F]{8}-([\dA-F]{4}-){3}[\dA-F]{12}/) -%>
        background-image: url(/img/<%= @theme[:frame][:logo] %>);
      <%- else -%>
        background-image: url(<%= @theme[:frame][:logo] %>);
      <%- end -%>
    }

  /* grid */

    <%- if !@theme[:grid][:header_icons] -%>
    .blist-th-icon { display: none; }
    .blist-th .icon-display .name-wrapper { padding-left: 0; }
    <%- end -%>

  <%# disabled row height %>
  <%- unless true -%>
    .blist-td
    {
        height: <%= @theme[:grid][:row_height][:value] %><%= @theme[:grid][:row_height][:unit] %>;
        line-height: <%= @theme[:grid][:row_height][:value] %><%= @theme[:grid][:row_height][:unit] %>;
    }
  <%- end -%>

    <%- if @theme[:grid][:wrap_header_text] -%>
    .blist-th .info-container
    {
        height: 2.5em; /* 30px or so */
        margin-top: -1.25em;
        white-space: normal;
    }
    .blist-th .name-wrapper { height: 2.5em; }
    .blist-table-header, .blist-th, .blist-th .dragHandle { height: 4.5em; }
    <%- end -%>

    <%- if @theme[:grid][:title_bold] -%>
    .blist-th .blist-th-name { font-weight: bold; }
    <%- end -%>

    <%- if @theme[:grid][:zebra] -%>
      .blist-tr-even .blist-td
      {
          background-color: <%= @theme[:grid][:zebra] %>;
      }
    <%- end -%>
  </style>
  <%- end -%>

  <%- if !@theme[:style][:custom_stylesheet].blank? -%>
    <%= stylesheet_link_tag @theme[:style][:custom_stylesheet] + "-widget" %>
  <%- end -%>

  <title><%= @view.name %> | <%= th.site_title %></title>

<% end %>
<div id='header' class='headerBar'><div class='wrapperTR'>
    <div class='wrapperT clearfix'>
          <%- menu_options = dataset_menu_lookup(@view, true, @theme) -%>
          <a id='mainLink' class="menuLink" href="#main-menu"
            title="Click for more options">Menu</a>
          <%= render(:partial => "widget_menu",
            :locals => { :theme => @theme, :menu_options => menu_options }) %>

          <a id='viewsLink' class='menuLink' href='#views-menu'>More Views</a>
          <%= menu_tag({'id' => 'viewsMenu', 'class' => 'headerMenu filterView',
          'items' => filter_submenu(@view, true, menu_options) +
            [menu_options['separator'],
            {'section_title' => 'Advanced sorting, filtering, formatting and ' +
            'more are available in Full Screen mode',
            'if' => @theme[:menu][:views_fullscreen]},
            menu_options['full_screen'].merge({
              'if' => @theme[:menu][:views_fullscreen]})
            ]}) %>

          <a id='shareLink' class='menuLink' href='#share-menu'>Share</a>
          <%= menu_tag({'id' => 'shareMenu', 'class' => 'headerMenu shareSocialize',
          'items' => share_menu_options(@view, menu_options)}) %>

          <%- if @theme[:menu][:top_fullscreen] -%>
          <p class="fullScreenButton">
            <a href="<%= @view.href %>" rel="external" title="View Full Screen">View Full Screen</a>
          </p>
          <%- end -%>

          <form class='search' action='#'>
            <div class='searchContainer clearfix'>
              <input type='text' class='textInput textPrompt' title='Find Inside' />
              <div class='actionBox'>
                <div class='clearBox'>
                  <a class='clearSearch' title='Clear Search' href='#clear_search'>
                    Clear Search
                  </a>
                </div>
                <%= image_submit_tag('empty.gif', :class => 'submit',
                  :name => 'findSubmit', :title => 'Click to Find') %>
              </div>
            </div>
          </form>

    </div>
</div></div>

    <div class="gridOuter"><div class="gridInner">
      <%- if (@theme[:behavior][:save_public_views]) -%>
        <div id='viewHeader' class='clearfix'>
          <a class='datasetLink breadcrumbItem'
            href='#view_<%= @view.id %>'><%= h(@view.name) %></a>
          <div class='viewName inlineEdit' href='#new_view'>
            <span title='Click to name and save your filtered view'>
              [Unsaved Filter]
            </span>
            <%- form_tag(blists_path) do -%>
            <%= text_field_tag("view[name]", '') %>
            <%- end -%>
          </div>
        </div>
      <%- end -%>
      
      <div class="gridContainer">
        <div id="data-grid">
          <noscript>
            <h3><a href="<%= @view.href %>"><%= h(@view.name) %></a></h3>
    
            <p><%= h(@view.description) %></p>

            <% cache ['widget-bare-html', @view.id], :expires_in => 1.hour do %>
              <%= @view.html %>
            <% end %>
          </noscript>
        </div>
      </div>
      
      <%- if @theme[:meta].any?{ |name, properties| properties[:show] } -%>
        <div id="widgetMeta" class="metadataPane">
          <%- if !@view.nil? -%>
            <%= render(:partial => "widget_meta",
                  :locals => { :view => @view, :page_single => false, :theme => @theme }) %>
          <%- end -%>
        </div>
      <%- end -%>
    </div></div>
    
    <div class="widgetFooterWrapper"><div class="widgetFooterInner">
      <%- if @theme[:frame][:logo] != 'none' -%>
        <p class="widgetLogoWrapper">
          <a href='<%= @theme[:frame][:logo_url] %>' rel='external' class='widgetLogo'>
            Socrata Social Data Player
          </a>
        </p>
      
        <%- if @theme[:frame][:footer_link][:show] -%>
          <p class="getPlayerAction">
            <a href="<%= @theme[:frame][:footer_link][:url] %>" rel="external">
              <%= @theme[:frame][:footer_link][:text] %>
            </a>
          </p>
        <%- end -%>
      <%- else -%>
        &nbsp;
      <%- end -%>
      <div class="clearBoth"></div>
    </div></div>

    <div class='interstitial'>
      <a class='closeLink' href='#close'>Close</a>
      <span class='closeKeyText'>or ESC key</span>
      <h4>You are leaving <span class='serverName'>the current website</span></h4>
      <p>Thank you for visiting our site.</p>
      <div class='exitBox'>
        <p>You will now access</p>
        <a href='#' class='noInterstitial externalLink'></a>
      </div>
      <h4>We hope your visit was informative and enjoyable.</h4>
    </div>

    <div class="jqmWindow widgetModal" id="modal"></div>
  
<% content_for :js_footer do %>
  <%= render(:partial => "shared/visualization", :locals => { :view => @view }) %>

  <script type="text/javascript">
    blist.namespace.fetch('blist.widget');
    <%- if !current_user.nil? -%>
      blist.currentUserId = "<%= current_user.id %>";
      blist.isOwner = <%= current_user.id == @view.owner.id ? 'true' : 'false' %>;
    <%- end -%>
    blist.widget.viewId = '<%= @view.id %>';

    blist.widget.theme = <%= @theme.to_json %>;
    blist.widget.customizationId = '<%= params[:customization_id] || '' %>';
    blist.widget.isAltView = <%= @view.is_alt_view? ? 'true' : 'false' %>;
  </script>

  <%- if @view.can_edit() -%>
  <%= render(:partial => 'shared/table_editor_js') %>
  <%- end -%>
  <%= javascript_include_merged 'widgets-show' %>

  <%- if !@is_gov_widget && !APP_CONFIG['google_analytics_id'].blank? -%>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
      var pageTracker = _gat._getTracker("<%= APP_CONFIG['google_analytics_id'] %>");
    pageTracker._trackPageview();
    } catch(err) {}</script>

    <%- unless @theme[:behavior][:ga_code].empty? -%>
      <script type="text/javascript">
      try {
      var pageTracker2 = _gat._getTracker("<%= @theme[:behavior][:ga_code] %>");
      pageTracker2._trackPageview();
      } catch(err) {}</script>
    <%- end -%>
    
    <%= render(:partial => "shared/quantcast") %>
  <%- end -%>
<% end %>

#!/usr/bin/env ruby
require 'pathname'

# path to your application root.
APP_ROOT = Pathname.new File.expand_path('../../',  __FILE__)

Dir.chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file:

  unless `which convert` =~ /convert$/
    abort <<-eos
ERROR: Missing dependency - imagemagick
Please install imagemagick before continuing.

On Mac OS X:
  brew install imagemagick

On Ubuntu:
  sudo apt-get install imagemagick -y

    eos
  end

  unless `which aws` =~ /aws$/
    abort <<-eos
ERROR: Missing dependency - awscli
Please install awscli before continuing.

On Mac OS X:
  brew install awscli

On Ubuntu:
  pip install awscli --upgrade --user

    eos
  end

  puts "== Copying and moving git hooks into .git/hooks"
  system "cp -n bin/pre-commit ../.git/hooks/pre-commit"

  puts "== Installing dependencies =="
  system "gem install bundler --conservative"
  system "bundle check || bundle install"

  puts "\n== Copying sample files =="
  unless File.exist?('config/database.yml')
    system "cp config/database.yml.sample config/database.yml"
  end

  puts "\n== Generating .env file =="
  has_aws_config = File.exists?('.env') &&
    File.open('.env') { |f| f.each_line.find { |line| line =~ /AWS_ACCESS_KEY_ID/ } }

  if !has_aws_config
    File.open('.env', 'a') do |file|
      file << %Q{export AWS_ACCESS_KEY_ID="$(aws configure get aws_access_key_id --profile staging)"\n}
      file << %Q{export AWS_SECRET_KEY="$(aws configure get aws_secret_access_key --profile staging)"\n}
    end
  end

  puts "\n== Preparing database =="
  system "bin/rake db:migrate 2>/dev/null || bin/rake db:setup"

  puts "\n== Removing old logs and tempfiles =="
  system "rm -f log/*"
  system "rm -rf tmp/cache"

  puts "\n== Restarting application server =="
  system "mkdir -p tmp"
  system "touch tmp/restart.txt"
end

<% content_for :head do %>
  <%= auto_discovery_link_tag(:rss, "/views/#{@view.id}/rows.rss") %>
  <%= stylesheet_link_merged 'blist-show-alt' %>
  <title><%= h(@view.name) %> | <%= CurrentDomain.strings.site_title %></title>
  <%= meta_tags :description => @meta_description, :keywords => @meta_keywords %>
  <link rel="canonical" href="<%= @view.href %>" />
<% end %>

<% content_for :skip_links do %>
  <a href="#dataGrid" accesskey="d">Skip to data</a>
  <a href="#metaTabs" accesskey="m">Skip to metadata information</a>
<% end %>

<%- is_owner = current_user && @view.owner.id == current_user.id -%>
<%- is_blist = @view.is_blist? %>
<%- can_edit = current_user && @view.can_edit() -%>

<div class="altShowContainer oneColumnContainer <%= @view.is_invalid? ? 'invalidView' : '' %>">
  <div class="fullPageContentContainer">
    <div class="fullPageOuterContent">
      <div class="fullPageContent">
        <div class="outerContent">
          <div class="contentTR"><div class="contentTL"></div></div>
          <div class="content">
            <ul id="datasetMenu">
              <li><a href="<%= @view.href %>/about">About this Dataset...</a></li>
              <li><a href="<%= @view.href %>/print">Print...</a></li>
              <li><a href="<%= @view.href %>/email">Email...</a></li>
              <li><a href="<%= @view.href %>/append">Append Rows via Upload...</a></li>
              <li><a href="<%= @view.href %>/replace">Replace Rows via Upload...</a></li>
              <li><a href="/views/<%= @view.id %>/rows.rss">Subscribe via RSS</a></li>
            <%- socialize_menu_options(@view).each do |item| -%>
              <li><a href="<%= item['href'] %>">Share via <%= item['text'] %></a></li>
            <%- end -%>
              <li><a href=""></a></li>
              <li><a href="/views/<%= @view.id %>/rows.csv?accessType=DOWNLOAD">Export To CSV</a></li>
              <li><a href="/views/<%= @view.id %>/rows.xls?accessType=DOWNLOAD">Export To XLS</a></li>
              <li><a href="/views/<%= @view.id %>/rows.xlsx?accessType=DOWNLOAD">Export To XLSX</a></li>
            </ul>
            <a name="dataGrid"></a>

            <h1><%= @view.name %></h1>
            <% if @view.parent_dataset != @view %>
              <p>This is a filtered view based on <%= link_to @view.parent_dataset.name, @view.parent_dataset.alt_href %>.</p>
            <% end %>

            <div class="dataGridWrapper">
              <table id="dataGrid">
                <thead>
                  <tr>
                    <th id="header_row_number">Row number</th>
                    <% @view.viewable_columns.each do |column|%>
                      <th id="header_<%= column.id %>" class="<%= column.dataTypeName %>">
                        <%= column.name %>
                      </th>
                    <%- end -%>
                  </tr>
                </thead>
                <tbody>
                  <%# This is somewhat ugly but is inline for perf reasons %>
                  <% row_number = ((@page - 1) * @view.per_page)  %>
                  <%- @data.each do |row| -%>
                    <% row_number += 1 %>
                    <tr class="<%= cycle('even', 'odd') %>">
                      <th header="header_row_number"><%= row_number %></th>
                      <% @view.viewable_columns.each_with_index do |column, index|%>
                        <td header="header_<%= column.id %>">
                          <%- cell = row[index] -%>
                          <%- unless cell.nil? -%>
                            <%- case column.renderTypeName -%>
                            <%- when 'text' -%>
                              <%- if column.text_format == 'Plain' -%>
                                <%= row[index].to_s %>
                              <%- elsif column.text_format == 'Rich' -%>
                                <%= raw(row[index].to_s) %>
                              <%- end -%>

                            <%- when 'url' -%>
                            <%- url = cell[column.sub_type_index('url')] -%>
                            <%- if (!url.blank? && url.index('/') != 0 &&
                              URI.parse(url).scheme.nil?) -%>
                              <%- url = 'http://' + url -%>
                            <%- end -%>
                            <%- desc = cell[column.sub_type_index('description')] || url -%>

                            <%- if !url.blank? || !desc.blank? -%>
                            <%= link_to desc, url %>
                            <%- end -%>

                            <%- when 'email' -%>
                            <%= link_to cell, 'mailto:' + cell %>

                            <%- when 'phone' -%>
                              <%= cell[column.sub_type_index('phone_number')] %>
                              <%- phone_type =
                                cell[column.sub_type_index('phone_type')] -%>
                              <%- if !phone_type.nil? -%>
                                (<%= phone_type %>)
                              <%- end -%>

                            <%- when 'drop_down_list' -%>
                              <%- column.dropDown.values.each do |option| -%>
                                <%- if option['id'] == row[index] -%>
                                  <%= option['description'] %>
                                <%- end -%>
                              <%- end -%>

                            <%- when 'number' -%>
                              <%- if !column.precision.nil? -%>
                                <%- precision = '.' + column.precision -%>
                                <%- precision_style = 'f' -%>
                              <%- end -%>
                              <%- precision_style = 'e' if column.precision_style == 'scientific' -%>
                              <%- if !precision_style.nil? -%>
                                <%= "%#{precision}#{precision_style}" % row[index] %>
                              <%- else -%>
                                <%= row[index] %>
                              <%- end -%>

                            <%- when 'percent' -%>
                              <%- if !column.precision.nil? -%>
                                <%= "%.#{column.precision}f" % row[index] %>%
                              <%- else -%>
                                <%= row[index]%>%
                              <%- end -%>

                            <%- when 'money' -%>
                              <%= column.currency_symbol %><%=
                                "%.#{column.precision || 2}f" % cell %>

                            <%- when 'date' -%>
                              <%- value = Time.at(row[index].to_i) -%>
                              <%- output_value = case column.format_view -%>
                                <%- when 'date'          then value.strftime('%m/%d/%Y') %>
                                <%- when 'date_time'     then value.strftime('%m/%d/%Y %I:%M:%S %Z') %>
                                <%- when 'date_dmy'      then value.strftime('%d/%m/%Y') %>
                                <%- when 'date_dmy_time' then value.strftime('%d/%m/%Y %I:%M:%S %Z') %>
                                <%- when 'date_ymd'      then value.strftime('%Y/%m/%d') %>
                                <%- when 'date_ymd_time' then value.strftime('%Y/%m/%d %I:%M:%S %Z') %>
                                <%- when 'date_monthdy'  then value.strftime('%B %d, %Y') %>
                                <%- when 'date_dmonthy'  then value.strftime('%d %B %Y') %>
                                <%- when 'date_ymonthd'  then value.strftime('%Y %B %d') %>
                                <%- else                      value.strftime('%m/%d/%Y %I:%M:%S %Z') %>
                              <%- end -%>
                              <%= output_value || value.strftime('%c') %>

                            <%- when 'document' -%>
                              <%- name_i = column.sub_type_index('filename') -%>
                              <%- size_i = column.sub_type_index('size') -%>
                              <%- type_i = column.sub_type_index('content_type') -%>
                              <%- is_old = column.sub_type_index('file_id').nil? -%>
                              <%- id_i = column.sub_type_index(is_old ?
                                'id' : 'file_id') -%>

                              <%- if !cell[id_i].nil? -%>
                              <%- params = [] -%>
                              <%- params << 'filename=' +
                                URI::escape(cell[name_i]) if
                                !cell[name_i].blank? -%>
                              <%- params << 'content_type=' +
                                URI::escape(cell[type_i]) if
                                !cell[type_i].blank? -%>
                              <a href='/views/<%= @view.id %>/<%= is_old ?
                                '' : 'new_' %>files/<%= cell[id_i] %><%=
                                  !is_old && params.length > 0 ?
                                  '?' + params.join('&') : '' %>'>
                                  <%= cell[name_i] %>
                                </a>
                                (<%= number_to_human_size(cell[size_i],
                                  {:locale => 'en'}) %>)
                                (<%= cell[type_i] %>)
                              <%- end -%>

                            <%- when 'photo' -%>
                              <%- url = '/views/' + @view.id + '/' +
                                (column.dataTypeName == 'new_photo' ?
                                'new_' : '') + 'files/' + cell -%>
                              <a href='<%= url %>'>
                                <img src='<%= url %>' />
                              </a>

                            <%- else -%>
                              <%= row[index].to_s %>
                            <%- end -%>
                          <%- end -%>
                        </td>
                      <%- end -%>
                    </tr>
                  <%- end -%>
                </tbody>
                <% unless @aggregates.nil? or @aggregates.none? %>
                  <tfoot>
                    <tr>
                      <th>Totals</th>
                      <% @view.viewable_columns.each_with_index do |column, index|%>
                        <th> <%= @aggregates.find{|aggregate| aggregate['columnId']==column.id}['value'] if @aggregates.find{|aggregate| aggregate['columnId']== @view.viewable_columns[index].id} %></th>
                      <% end %>
                    </tr>
                  </tfoot>
                <% end %>
              </table>
            </div>
            <div id="pagination links" style="margin: 20px;">
              <%= will_paginate @data %>

            </div>
          </div>
          <%# This is somewhat ugly but is inline for perf reasons %>
          <% form_tag alt_filter_blist_path(@view.id) do -%>
          <h2>Filter</h2>
          <% @view.viewable_columns.each do |filter_field| %>
          <% unless View::FILTER_CONDITIONS[filter_field.renderTypeName.to_sym].nil? %>
          <p>
          <%= label_tag "Filter on #{filter_field.name}" %>
          <%= select_tag "limit_#{filter_field.id}", options_for_limit_to(filter_field.renderTypeName)%>
          <%= text_field_tag "cell_content_#{filter_field.id}" %>
          </p>
          <% end %>
          <% end %>

          <h2>Sort</h2>
          <% 1.upto(5) do |n|%>
          <%= label_tag "Sort field #{n.to_s}" %>
          <%= select_tag "sort_field_#{n}", options_for_sort_by(@view.viewable_columns)%>
          <%= select_tag "sort_direction_#{n}", options_for_select(["Ascending", "Descending"]), :value =>"Ascending" %>

          <% end %>
          <%= submit_tag "submit" %>
          <% end -%>
          <h2>Search</h2>
          <% form_tag alt_filter_blist_path(@view.id) do -%>
          <%= label_tag "Search" %>
          <%= text_field_tag "search", @search_query %>
          <%= link_to "clear search", @view.alt_href %>
          <%= submit_tag "submit" %>
          <% end %>
        </div>
        <% if @query_json and current_user %>
        <h2>Save this view</h2>
        <% form_tag save_filter_blist_path(@view.id) do -%>
        <%= hidden_field_tag 'query_json', @query_json %>
        <%= label_tag "Name" %>
        <%= text_field_tag "name" %>
        <%= submit_tag "submit" %>
        <% end %>
        <% elsif @query_json and not current_user %>
        <div><%= link_to "Sign in to save this view.", :controller => :blists, :action => :login_to_alt, :id => @view.id, :query_json => @query_json %></div>
        <% end %>
        <h2>Saved Views</h2>
        <% @view.filters.each do |filter| %>

        <ul>
          <li><%= link_to filter.name, filter.alt_href %></li>
        </ul>
        <% end %>
        <h2>Comments</h2>
        <h2>
          <%= pluralize(@view.numberOfComments, 'Comment') %>
        </h2>
        <h2><%= @view.averageRating %> Average Rating</h2>
        <h2><%= pluralize(@view.totalTimesRated, 'Rating') %></h2>

        <%- form_tag(alt_post_comment_blist_path(@view.id)) do -%>

        <%= label_tag "My Rating" %>
        <%= select_tag("comment[viewRating]", options_for_select([1, 2, 3, 4, 5].reverse)) %>
        <%= label_tag "Title" %>
        <%= text_field_tag("comment[title]") %>
        <%= label_tag "Body" %>
        <%= text_area_tag("comment[body]") %>
        <%= submit_tag "submit" %>
        <%- end -%>

        <% @view.comments.each do |comment| %>
        <div class="comment">
          <p>Rating:           <%= get_comment_rating_html(comment) %></p>
          <p><%= comment.title %></p>
          <p><%= comment.user.displayName %></p>

          <p><%= humane_date(comment.createdAt) %></p>

          <p><%= comment.body %></p>

        </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
